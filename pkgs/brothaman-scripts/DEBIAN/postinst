#!/bin/bash
set -e

# Set proper permissions on brothaman scripts
chmod 755 /usr/local/bin/bro-*

# Set permissions on configuration directory
chmod 755 /etc/brothaman
chmod 644 /etc/brothaman/config

# Set permissions on shared library
chmod 755 /usr/local/share/brothaman
chmod 644 /usr/local/share/brothaman/bro-common

# Create brothaman group if it doesn't exist
if ! getent group brothaman >/dev/null 2>&1; then
    addgroup --system brothaman
fi

# Ensure base ZFS dataset for unprivileged users exists
BASE_DIR="/var/lib/containers/unprivileged"
if command -v zfs >/dev/null 2>&1 && command -v zpool >/dev/null 2>&1; then
    DATASET=$(zfs list -H -o name,mountpoint 2>/dev/null | awk -v mp="$BASE_DIR" '$2 == mp {print $1; exit}')
    if [ -z "$DATASET" ]; then
        DEFAULT_POOL=$(zpool list -H -o name 2>/dev/null | head -n 1)
        if [ -n "$DEFAULT_POOL" ]; then
            DATASET="${DEFAULT_POOL}/brothaman/unprivileged"
            if ! zfs list "$DATASET" >/dev/null 2>&1; then
                zfs create -p \
                    -o mountpoint="$BASE_DIR" \
                    -o xattr=sa \
                    -o acltype=posixacl \
                    -o aclinherit=passthrough \
                    -o aclmode=passthrough \
                    -o compression=zstd \
                    -o atime=off \
                    -o recordsize=128K \
                    "$DATASET"
            else
                zfs set mountpoint="$BASE_DIR" "$DATASET"
            fi
        fi
    fi
    if [ -n "$DATASET" ]; then
        zfs set xattr=sa "$DATASET" >/dev/null 2>&1 || true
        zfs set acltype=posixacl "$DATASET" >/dev/null 2>&1 || true
        zfs set aclinherit=passthrough "$DATASET" >/dev/null 2>&1 || true
        zfs set aclmode=passthrough "$DATASET" >/dev/null 2>&1 || true
        zfs set compression=zstd "$DATASET" >/dev/null 2>&1 || true
        zfs set atime=off "$DATASET" >/dev/null 2>&1 || true
        zfs set recordsize=128K "$DATASET" >/dev/null 2>&1 || true
    fi
fi

install -d -m 0750 "$BASE_DIR"
chown root:zfshelper "$BASE_DIR"
chmod 0750 "$BASE_DIR"

# Ensure XDG runtime profile script exists for user sessions
cat >/etc/profile.d/xdg_runtime.sh <<'EOF'
#!/bin/sh

export XDG_RUNTIME_DIR="/run/user/$(id -u)"
export DBUS_SESSION_BUS_ADDRESS="unix:path=${XDG_RUNTIME_DIR}/bus"
EOF
chmod 0755 /etc/profile.d/xdg_runtime.sh

echo "Brothaman scripts installed successfully!"
echo "Configuration available in: /etc/brothaman/config"
echo "Shared library available at: /usr/local/share/brothaman/bro-common"
echo ""
echo "Available commands:"
echo "  bro-compose      - Container compose management"
echo "  bro-doctor       - System diagnostics"
echo "  bro-install-deps - Install system dependencies" 
echo "  bro-install-podman - Install Podman"
echo "  bro-install-zfs  - Install ZFS utilities"
echo "  bro-service      - Service management"
echo "  bro-test-zpool   - Test ZFS pool operations"
echo "  bro-user         - User management utilities"

#DEBHELPER#
