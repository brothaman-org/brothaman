#!/usr/bin/env bash
set -euo pipefail

# BRO_COMMON resolution
if [[ -z "${BRO_COMMON:-}" ]]; then
  if [[ -r "/usr/local/share/brothaman/bro-common" ]]; then
    export BRO_COMMON="/usr/local/share/brothaman/bro-common"
  else
    _self="${BASH_SOURCE[0]}"
    _self_dir="$(cd -- "$(dirname -- "${_self}")" && pwd)"
    export BRO_COMMON="${_self_dir%/}/../lib/bro-common"
  fi
fi

if [[ ! -r "${BRO_COMMON}" ]]; then
  echo "[ERROR] BRO_COMMON not readable at: ${BRO_COMMON}" >&2
  exit 2
fi

# shellcheck disable=SC1090
source "${BRO_COMMON}"

MODE="ansible"
ARGS=()
for a in "$@"; do
  case "$a" in
    --script) MODE="script" ;;
    *) ARGS+=("$a") ;;
  esac
done

if [[ "$MODE" == ansible ]]; then
  bro_run_ansible "$(basename "$0")" "${ARGS[@]:-}"
  exit 0
fi

# --- shell mode ---
bro_log "(shell mode) bro-doctor would run environment diagnostics here."
