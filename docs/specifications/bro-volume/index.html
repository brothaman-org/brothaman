<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../bro-user/ rel=prev><link href=../bro-activator/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.0"><title>bro-volume - Brothaman</title><link rel=stylesheet href=../../assets/stylesheets/main.618322db.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head><body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue><input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off><input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off><label class=md-overlay for=__drawer></label><div data-md-component=skip><a href=#specification-bro-volume-cli-program class=md-skip> Skip to content </a></div><div data-md-component=announce></div><header class="md-header md-header--shadow md-header--lifted" data-md-component=header><nav class="md-header__inner md-grid" aria-label=Header><a href=../.. title=Brothaman class="md-header__button md-logo" aria-label=Brothaman data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg></a><label class="md-header__button md-icon" for=__drawer><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> Brothaman </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> bro-volume </span></div></div></div><form class=md-header__option data-md-component=palette><input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0><label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label><input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1><label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label></form><script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script><label class="md-header__button md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required><label class="md-search__icon md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg></label><nav class=md-search__options aria-label=Search><button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav></form><div class=md-search__output><div class=md-search__scrollwrap tabindex=0 data-md-scrollfix><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta> Initializing search </div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div></nav><nav class=md-tabs aria-label=Tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a href=../.. class=md-tabs__link> Home </a></li><li class=md-tabs__item><a href=../../architecture/ class=md-tabs__link> Architecture </a></li><li class=md-tabs__item><a href=../../components/ class=md-tabs__link> Components </a></li><li class=md-tabs__item><a href=../../compose-conversion/ class=md-tabs__link> Tools & Utilities </a></li><li class=md-tabs__item><a href=../../labs/ class=md-tabs__link> Labs & Tutorials </a></li><li class="md-tabs__item md-tabs__item--active"><a href=../bro-helper/ class=md-tabs__link> Reference </a></li></ul></div></nav></header><div class=md-container data-md-component=container><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0><label class=md-nav__title for=__drawer><a href=../.. title=Brothaman class="md-nav__button md-logo" aria-label=Brothaman data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg></a> Brothaman </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1><label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0><span class=md-ellipsis> Home </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false><label class=md-nav__title for=__nav_1><span class="md-nav__icon md-icon"></span> Home </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../.. class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../directions/ class=md-nav__link><span class=md-ellipsis> Getting Started </span></a></li><li class=md-nav__item><a href=../../development/ class=md-nav__link><span class=md-ellipsis> Development </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2><label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0><span class=md-ellipsis> Architecture </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false><label class=md-nav__title for=__nav_2><span class="md-nav__icon md-icon"></span> Architecture </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../architecture/ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../architecture/ class=md-nav__link><span class=md-ellipsis> System Design </span></a></li><li class=md-nav__item><a href=../../socket-activation/ class=md-nav__link><span class=md-ellipsis> Socket Activation </span></a></li><li class=md-nav__item><a href=../../quadlet-patterns/ class=md-nav__link><span class=md-ellipsis> Quadlet Patterns </span></a></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_5><label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0><span class=md-ellipsis> Diagrams </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false><label class=md-nav__title for=__nav_2_5><span class="md-nav__icon md-icon"></span> Diagrams </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../diagrams/architecture/ class=md-nav__link><span class=md-ellipsis> System Architecture </span></a></li><li class=md-nav__item><a href=../../diagrams/per-service-pattern/ class=md-nav__link><span class=md-ellipsis> Service Pattern </span></a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3><label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0><span class=md-ellipsis> Components </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false><label class=md-nav__title for=__nav_3><span class="md-nav__icon md-icon"></span> Components </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../components/ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../bro-helper/ class=md-nav__link><span class=md-ellipsis> Network Helper </span></a></li><li class=md-nav__item><a href=../../user-scope/ class=md-nav__link><span class=md-ellipsis> User Management </span></a></li><li class=md-nav__item><a href=../../unprivileged-podman/ class=md-nav__link><span class=md-ellipsis> Container Runtime </span></a></li><li class=md-nav__item><a href=../../zfs/ class=md-nav__link><span class=md-ellipsis> Storage Backend </span></a></li><li class=md-nav__item><a href=../../users-and-lingering/ class=md-nav__link><span class=md-ellipsis> User Sessions </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4><label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0><span class=md-ellipsis> Tools & Utilities </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false><label class=md-nav__title for=__nav_4><span class="md-nav__icon md-icon"></span> Tools & Utilities </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../compose-conversion/ class=md-nav__link><span class=md-ellipsis> Compose Conversion </span></a></li><li class=md-nav__item><a href=../../dictionary/ class=md-nav__link><span class=md-ellipsis> Dictionary </span></a></li><li class=md-nav__item><a href=../../project-plan/ class=md-nav__link><span class=md-ellipsis> Project Plan </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5><label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0><span class=md-ellipsis> Labs & Tutorials </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false><label class=md-nav__title for=__nav_5><span class="md-nav__icon md-icon"></span> Labs & Tutorials </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../labs/ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_2><label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0><span class=md-ellipsis> Foundation </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false><label class=md-nav__title for=__nav_5_2><span class="md-nav__icon md-icon"></span> Foundation </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../labs/0.%20setup/ class=md-nav__link><span class=md-ellipsis> Lab 0: Environment Setup </span></a></li><li class=md-nav__item><a href=../../labs/1.%20lingering/ class=md-nav__link><span class=md-ellipsis> Lab 1: User Lingering </span></a></li><li class=md-nav__item><a href=../../labs/2.%20quadlet/ class=md-nav__link><span class=md-ellipsis> Lab 2: Quadlet Basics </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_3><label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex=0><span class=md-ellipsis> Storage & Persistence </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false><label class=md-nav__title for=__nav_5_3><span class="md-nav__icon md-icon"></span> Storage & Persistence </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../labs/3.%20volumes/ class=md-nav__link><span class=md-ellipsis> Lab 3: Volumes & ZFS </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_4><label class=md-nav__link for=__nav_5_4 id=__nav_5_4_label tabindex=0><span class=md-ellipsis> Applied Examples </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_4_label aria-expanded=false><label class=md-nav__title for=__nav_5_4><span class="md-nav__icon md-icon"></span> Applied Examples </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../labs/4.%20networking/ class=md-nav__link><span class=md-ellipsis> Lab 4: Network Config </span></a></li><li class=md-nav__item><a href=../../labs/5.%20example/ class=md-nav__link><span class=md-ellipsis> Lab 5: Real World Example </span></a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked><label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex><span class=md-ellipsis> Reference </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true><label class=md-nav__title for=__nav_6><span class="md-nav__icon md-icon"></span> Reference </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_1 checked><label class=md-nav__link for=__nav_6_1 id=__nav_6_1_label tabindex><span class=md-ellipsis> API Specifications </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_1_label aria-expanded=true><label class=md-nav__title for=__nav_6_1><span class="md-nav__icon md-icon"></span> API Specifications </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../bro-helper/ class=md-nav__link><span class=md-ellipsis> Network Helper </span></a></li><li class=md-nav__item><a href=../bro-user/ class=md-nav__link><span class=md-ellipsis> bro-user </span></a></li><li class="md-nav__item md-nav__item--active"><input class="md-nav__toggle md-toggle" type=checkbox id=__toc><a href=./ class="md-nav__link md-nav__link--active"><span class=md-ellipsis> bro-volume </span></a></li><li class=md-nav__item><a href=../bro-activator/ class=md-nav__link><span class=md-ellipsis> bro-activator </span></a></li></ul></nav></li></ul></nav></li></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><h1 id=specification-bro-volume-cli-program>Specification: <code>bro-volume</code> CLI Program<a class=headerlink href=#specification-bro-volume-cli-program title="Permanent link">&para;</a></h1><p>The <code>bro-volume</code> CLI program, as a bash script, is part of the Brothaman scripts package which creates ZFS backed volumes for unprivileged containers. It is installed using the <code>bro-install</code> script or the <code>brothaman-scripts</code> Debian package.</p><blockquote><p><strong>ATTENTION</strong>: The brothaman-scripts package is has a hard dependency on ZFS and zfs-utils being installed on the host system. It also has a hard dependency on the <code>zfs-helper</code> debian package to allow unprivileged users to run delegated zfs commands without root privileges.</p></blockquote><ul><li>The <code>bro-volume</code> script requires root privileges to run.</li><li>The <code>bro-volume</code> script creates a ZFS dataset for use as a Podman volume for unprivileged rootless containers. When container UID/GID overrides are provided it also applies POSIX ACLs (via <code>setfacl</code>) so the unprivileged owner retains access to the mountpoint even though ownership is shifted to the container user.</li><li>The created ZFS dataset is owned by the specified unprivileged user account that will run the container using the volume.</li><li>The created ZFS dataset has appropriate ZFS properties set for use as a Podman volume, including compression and atime settings.</li><li>The created ZFS dataset is mounted at the specified mount point for use as a Podman volume quadlet.</li><li>The <code>bro-volume</code> script supports the following command line options:</li><li><code>--name NAME</code>: The name of the volume (ZFS dataset name) required.</li><li><code>--mount-point PATH</code>: The mount point for the volume defaults to <code>/var/lib/containers/unprivileged/USERNAME/volumes/NAME</code> where USERNAME is the owner user.</li><li><code>--container CONTAINER_NAME</code>: The name of the container quadlet that will use this volume (optional), adds a PartOf= directive to the volume quadlet and integrates the volume into the container quadlet.</li><li><code>--container-path PATH</code>: The container mount path where the volume will be mounted inside the container (required when <code>--container</code> is used).</li><li><code>--container-user VALUE</code>: Username/UID or <code>internal:&lt;uid&gt;</code> identifier to own the dataset contents (defaults to the owner's UID). Usernames are resolved with <code>getent passwd</code>.</li><li><code>--container-group VALUE</code>: Group name/GID or <code>internal:&lt;gid&gt;</code> identifier to own the dataset contents (defaults to the owner's GID). Group names are resolved with <code>getent group</code>.</li><li><code>--pre_snapshots RETENTION</code>: The number of ZFS 'pre_' start snapshots to retrain for the volume (ZFS dataset), default is 5, set to 0 to disable.</li><li><code>--owner USERNAME</code>: The owner of the volume (unprivileged user account required).</li><li><code>--remove</code>: Remove the specified volume, including its ZFS dataset, quadlet file, zfs-helper policy entries, and dependencies from container quadlets.</li><li><code>--help</code>: Display help information about the script usage.</li><li><code>--version</code>: Display the version of the <code>bro-volume</code> script.</li><li>The <code>bro-volume</code> creates a <code>&lt;NAME&gt;.volume</code> quadlet for the specified unprivileged user in the appropriate XDG path: <code>~/.config/containers/systemd/&lt;NAME&gt;.volume</code>. The created volume quadlet contains the necessary configuration to use the created and prepared ZFS dataset as a Podman volume.</li><li>The created volume quadlet includes the following directives:</li><li><code>Description=</code>: A brief description of the volume.</li><li><code>VolumeName=</code>: The name of the volume (ZFS dataset name). The <code>[Volume]</code> section also declares <code>Device=&lt;mount&gt;</code> together with <code>Type=none</code> and <code>Options=bind</code> so the quadlet explicitly binds the dataset mount point into consuming containers without relying on Podman's implicit volume handling.</li><li><code>Environment=</code>: Sets environment variables for the volume, including the mount point, the ZFS dataset (same as volume) name, and the owner user as well as things like the RETENTION for pre_snapshots.<ul><li>When <code>--container-user</code>/<code>--container-group</code> are used, additional <code>Environment=</code> entries store the requested UID/GID and a flag the unit uses to reapply ownership on each start.</li></ul></li><li><code>Wants=</code>: Specifies that ZFS mounter is ready.</li><li><code>PartOf=</code>: Associates the volume with the Podman user service instance working in conjunction with a --container option to link the volume to a container.</li><li><code>ExecStartPre=</code>: Multiple used to prepare the volume for use by ensuring the mount point data set exists, creates it if necessary, and sets the correct ownership and permissions all using zfs-helperctl. Even takes the pre_snapshots argument into account, generating snapshot names with <code>date +%s%N</code> timestamps so back-to-back starts never collide. When custom container UIDs/GIDs are supplied, bro-volume applies that ownership during dataset creation (where it still has root privileges) and layers ACLs for the unprivileged owner, so the runtime unit does not need additional chown steps. See how all this is done in the <code>3. volumes.md</code> lab. Must make sure to take specifier expansion and special characters into account. Look at examples in the lab where we escaped the <code>%</code> with <code>%%</code> and the <code>$</code> with <code>$$</code>.</li><li><code>ExecStart=</code>: Mounts the ZFS dataset at the specified mount point.</li><li><code>ExecStop=</code>: Unmounts the ZFS dataset when the volume is no longer needed.</li><li>When the <code>--container</code> and <code>--container-path</code> options are provided, the <code>bro-volume</code> script automatically modifies the existing container quadlet to integrate the volume:</li><li>Adds systemd service dependencies (<code>PropagatesStopTo=</code>, <code>BindsTo=</code>, and <code>After=</code>) in the <code>[Unit]</code> section to properly link the volume service lifecycle with the container service.</li><li>Adds a <code>Volume=</code> directive in the <code>[Container]</code> section with the format <code>VOLUME_NAME:CONTAINER_PATH</code>, ensuring the container always references the generated Quadlet volume by name (Podman resolves the host bind via the volume unit's <code>Device=/var/...</code> definition).</li><li>Detects when the quadlet already declares the volume (either by referencing the generated <code>&lt;NAME&gt;.volume</code> quadlet, a shorthand <code>&lt;NAME&gt;</code> reference, or by using the same bind mount path) and reuses the existing directive instead of inserting a duplicate entry.</li><li>Removes any existing volume-related dependencies and volume mounts to the same container path to prevent conflicts.</li><li>Uses the correct systemd service naming convention where a volume quadlet named <code>NAME.volume</code> becomes the service <code>NAME-volume.service</code>.</li><li>If the path <code>/var/lib/containers/unprivileged</code> exists, the <code>bro-volume</code> script creates a new user account under this base directory for unprivileged Podman containers by delegating user creation to the <code>bro-user</code> script if the specified owner user does not already exist.</li><li>If the path does not exist, it fails with an error.</li><li>The <code>bro-volume</code> script can be extended in the future to support additional features as needed.</li><li>The <code>bro-volume</code> script is intended to be used by system administrators to create and manage ZFS backed volumes for running rootless Podman containers in a secure and isolated manner.</li><li>The <code>bro-volume</code> script is part of the Brothaman project and is licensed under the ASL 2.0 License.</li><li>The <code>bro-volume</code> script is maintained as part of the Brothaman scripts package and should be kept up to date with the latest features and security patches.</li><li>The <code>bro-volume</code> script ensures that the created ZFS dataset has delegated permissions for the specified unprivileged user to manage the dataset without requiring root privileges. This is done by setting the appropriate unit.list and operational allow list files with entries for the zfs-helper in the /etc/zfs-helper/policy.d/<username> directories.</li><li>The <code>bro-volume</code> script verifies that the specified unprivileged user has the necessary permissions to use the created ZFS dataset as a Podman volume.</li><li>The <code>bro-volume</code> script provides error handling and validation for the command line arguments to ensure that the specified parameters are valid and that the ZFS dataset can be created successfully. This includes:</li><li>Requiring <code>--container-path</code> when <code>--container</code> is specified to ensure explicit container mount path specification.</li><li>Preventing use of <code>--container-path</code> without <code>--container</code> to maintain logical argument relationships.</li><li>Validating format and characters in volume names, owner usernames, and container names using regular expressions.</li><li>Ensuring retention values are non-negative integers.</li><li>Checking for existing volumes (ZFS dataset or quadlet file) and requiring explicit removal with <code>--remove</code> before recreating.</li><li>Restricting <code>--remove</code> mode to only accept <code>--name</code> and <code>--owner</code> parameters for safety.</li><li>Allowing container ownership overrides to be specified as usernames, groups, numeric IDs, or <code>internal:</code> prefixed IDs. Internal IDs are translated using the owner's <code>/etc/subuid</code> and <code>/etc/subgid</code> entries (with 0 mapping to the owner's real UID/GID) unless the referenced container explicitly sets <code>UserNS</code>, in which case the command aborts.</li><li>The <code>bro-volume</code> script supports any type of container by requiring explicit specification of the container mount path via <code>--container-path</code>, removing previous hardcoded assumptions about specific container types (e.g., PostgreSQL).</li><li>When using <code>--remove</code>, the script performs comprehensive cleanup including:</li><li>Stopping the volume systemd service if running.</li><li>Removing the volume quadlet file.</li><li>Surgically removing only the specific volume's dependencies from all container quadlets that reference it, preserving other volumes.</li><li>Destroying the ZFS dataset and all its snapshots.</li><li>Cleaning up zfs-helper policy entries for the volume service and dataset (only if no other volumes use the same dataset).</li><li>The removal process is designed to be safe and only affect the specified volume, leaving other volumes and their dependencies intact.</li><li>The <code>bro-volume</code> script is intended to be used in conjunction with the <code>bro-user</code> script to create a complete environment for running unprivileged rootless Podman containers with ZFS backed volumes.</li></ul></article></div><script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script><script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script></div><button type=button class="md-top md-icon" data-md-component=top hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button></main><footer class=md-footer><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "content.code.copy", "content.code.select", "content.tabs.link", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script><script src=../../assets/javascripts/bundle.e71a0d61.min.js></script></body></html>