<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../2.%20quadlet/ rel=prev><link href=../4.%20networking/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.0"><title>Lab 3: Volumes & ZFS - Brothaman</title><link rel=stylesheet href=../../assets/stylesheets/main.618322db.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head><body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue><input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off><input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off><label class=md-overlay for=__drawer></label><div data-md-component=skip><a href=#volumes class=md-skip> Skip to content </a></div><div data-md-component=announce></div><header class="md-header md-header--shadow md-header--lifted" data-md-component=header><nav class="md-header__inner md-grid" aria-label=Header><a href=../.. title=Brothaman class="md-header__button md-logo" aria-label=Brothaman data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg></a><label class="md-header__button md-icon" for=__drawer><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> Brothaman </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> Lab 3: Volumes & ZFS </span></div></div></div><form class=md-header__option data-md-component=palette><input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0><label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label><input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1><label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label></form><script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script><label class="md-header__button md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required><label class="md-search__icon md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg></label><nav class=md-search__options aria-label=Search><button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav></form><div class=md-search__output><div class=md-search__scrollwrap tabindex=0 data-md-scrollfix><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta> Initializing search </div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div></nav><nav class=md-tabs aria-label=Tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a href=../.. class=md-tabs__link> Home </a></li><li class=md-tabs__item><a href=../../architecture/ class=md-tabs__link> Architecture </a></li><li class=md-tabs__item><a href=../../components/ class=md-tabs__link> Components </a></li><li class=md-tabs__item><a href=../../compose-conversion/ class=md-tabs__link> Tools & Utilities </a></li><li class="md-tabs__item md-tabs__item--active"><a href=../ class=md-tabs__link> Labs & Tutorials </a></li><li class=md-tabs__item><a href=../../specifications/bro-helper/ class=md-tabs__link> Reference </a></li></ul></div></nav></header><div class=md-container data-md-component=container><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0><label class=md-nav__title for=__drawer><a href=../.. title=Brothaman class="md-nav__button md-logo" aria-label=Brothaman data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg></a> Brothaman </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1><label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0><span class=md-ellipsis> Home </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false><label class=md-nav__title for=__nav_1><span class="md-nav__icon md-icon"></span> Home </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../.. class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../directions/ class=md-nav__link><span class=md-ellipsis> Getting Started </span></a></li><li class=md-nav__item><a href=../../development/ class=md-nav__link><span class=md-ellipsis> Development </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2><label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0><span class=md-ellipsis> Architecture </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false><label class=md-nav__title for=__nav_2><span class="md-nav__icon md-icon"></span> Architecture </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../architecture/ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../architecture/ class=md-nav__link><span class=md-ellipsis> System Design </span></a></li><li class=md-nav__item><a href=../../socket-activation/ class=md-nav__link><span class=md-ellipsis> Socket Activation </span></a></li><li class=md-nav__item><a href=../../quadlet-patterns/ class=md-nav__link><span class=md-ellipsis> Quadlet Patterns </span></a></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_5><label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0><span class=md-ellipsis> Diagrams </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false><label class=md-nav__title for=__nav_2_5><span class="md-nav__icon md-icon"></span> Diagrams </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../diagrams/architecture/ class=md-nav__link><span class=md-ellipsis> System Architecture </span></a></li><li class=md-nav__item><a href=../../diagrams/per-service-pattern/ class=md-nav__link><span class=md-ellipsis> Service Pattern </span></a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3><label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0><span class=md-ellipsis> Components </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false><label class=md-nav__title for=__nav_3><span class="md-nav__icon md-icon"></span> Components </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../components/ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../specifications/bro-helper/ class=md-nav__link><span class=md-ellipsis> Network Helper </span></a></li><li class=md-nav__item><a href=../../user-scope/ class=md-nav__link><span class=md-ellipsis> User Management </span></a></li><li class=md-nav__item><a href=../../unprivileged-podman/ class=md-nav__link><span class=md-ellipsis> Container Runtime </span></a></li><li class=md-nav__item><a href=../../zfs/ class=md-nav__link><span class=md-ellipsis> Storage Backend </span></a></li><li class=md-nav__item><a href=../../users-and-lingering/ class=md-nav__link><span class=md-ellipsis> User Sessions </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4><label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0><span class=md-ellipsis> Tools & Utilities </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false><label class=md-nav__title for=__nav_4><span class="md-nav__icon md-icon"></span> Tools & Utilities </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../compose-conversion/ class=md-nav__link><span class=md-ellipsis> Compose Conversion </span></a></li><li class=md-nav__item><a href=../../dictionary/ class=md-nav__link><span class=md-ellipsis> Dictionary </span></a></li><li class=md-nav__item><a href=../../project-plan/ class=md-nav__link><span class=md-ellipsis> Project Plan </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked><label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex><span class=md-ellipsis> Labs & Tutorials </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true><label class=md-nav__title for=__nav_5><span class="md-nav__icon md-icon"></span> Labs & Tutorials </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class="md-nav__item md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_2><label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex><span class=md-ellipsis> Foundation </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false><label class=md-nav__title for=__nav_5_2><span class="md-nav__icon md-icon"></span> Foundation </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../0.%20setup/ class=md-nav__link><span class=md-ellipsis> Lab 0: Environment Setup </span></a></li><li class=md-nav__item><a href=../1.%20lingering/ class=md-nav__link><span class=md-ellipsis> Lab 1: User Lingering </span></a></li><li class=md-nav__item><a href=../2.%20quadlet/ class=md-nav__link><span class=md-ellipsis> Lab 2: Quadlet Basics </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_3 checked><label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex><span class=md-ellipsis> Storage & Persistence </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=true><label class=md-nav__title for=__nav_5_3><span class="md-nav__icon md-icon"></span> Storage & Persistence </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--active"><input class="md-nav__toggle md-toggle" type=checkbox id=__toc><label class="md-nav__link md-nav__link--active" for=__toc><span class=md-ellipsis> Lab 3: Volumes & ZFS </span><span class="md-nav__icon md-icon"></span></label><a href=./ class="md-nav__link md-nav__link--active"><span class=md-ellipsis> Lab 3: Volumes & ZFS </span></a><nav class="md-nav md-nav--secondary" aria-label="Page Contents"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> Page Contents </label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a href=#0-snapshot class=md-nav__link><span class=md-ellipsis> 0. Snapshot </span></a></li><li class=md-nav__item><a href=#1-serve-brothamans-docs-with-volume-directives-in-test-quadletcontainers-container-section class=md-nav__link><span class=md-ellipsis> 1. Serve Brothaman's docs with Volume= directives in test-quadlet.container's [Container] section </span></a></li><li class=md-nav__item><a href=#2-creating-a-volume-quadlet class=md-nav__link><span class=md-ellipsis> 2. Creating a volume quadlet </span></a><nav class=md-nav aria-label="2. Creating a volume quadlet"><ul class=md-nav__list><li class=md-nav__item><a href=#21-create-a-zfs-backed-volume-quadlet-for-postgresql class=md-nav__link><span class=md-ellipsis> 2.1 Create a ZFS backed volume quadlet for PostgreSQL </span></a></li><li class=md-nav__item><a href=#22-troubleshooting-problems class=md-nav__link><span class=md-ellipsis> 2.2 Troubleshooting Problems </span></a></li><li class=md-nav__item><a href=#23-lets-delete-the-extra-snapshots class=md-nav__link><span class=md-ellipsis> 2.3 Let's delete the extra snapshots </span></a></li></ul></nav></li><li class=md-nav__item><a href=#3-switching-to-the-zfs-helper-for-snapshot-management class=md-nav__link><span class=md-ellipsis> 3. Switching to the zfs-helper for snapshot management </span></a><nav class=md-nav aria-label="3. Switching to the zfs-helper for snapshot management"><ul class=md-nav__list><li class=md-nav__item><a href=#31-setup-lingeruser-to-use-zfs-helper class=md-nav__link><span class=md-ellipsis> 3.1 Setup lingeruser to use zfs-helper </span></a></li><li class=md-nav__item><a href=#32-delete-pre-start-snapshots-above-a-limit class=md-nav__link><span class=md-ellipsis> 3.2 Delete pre-start snapshots above a limit </span></a></li><li class=md-nav__item><a href=#33-listing-volumes class=md-nav__link><span class=md-ellipsis> 3.3 Listing Volumes </span></a></li></ul></nav></li><li class=md-nav__item><a href=#4-connecting-the-volume-to-the-postgresql-container-quadlet class=md-nav__link><span class=md-ellipsis> 4. Connecting the volume to the PostgreSQL container quadlet </span></a><nav class=md-nav aria-label="4. Connecting the volume to the PostgreSQL container quadlet"><ul class=md-nav__list><li class=md-nav__item><a href=#notes-on-propagatesstopto-bindsto-partof-and-after class=md-nav__link><span class=md-ellipsis> Notes on PropagatesStopTo=, BindsTo=, PartOf=, and After= </span></a></li></ul></nav></li><li class=md-nav__item><a href=#5-testing-data-persistence-and-snapshot-rollbacks class=md-nav__link><span class=md-ellipsis> 5. Testing data persistence and snapshot rollbacks </span></a><nav class=md-nav aria-label="5. Testing data persistence and snapshot rollbacks"><ul class=md-nav__list><li class=md-nav__item><a href=#why-didnt-you-use-zfs-helper-for-rollbacks class=md-nav__link><span class=md-ellipsis> Why didn't you use zfs-helper for rollbacks? </span></a></li><li class=md-nav__item><a href=#how-does-it-work class=md-nav__link><span class=md-ellipsis> How does it work? </span></a></li><li class=md-nav__item><a href=#cant-a-compromised-unprivileged-account-create-a-service-with-the-same-name class=md-nav__link><span class=md-ellipsis> Can't a compromised unprivileged account create a service with the same name? </span></a></li></ul></nav></li><li class=md-nav__item><a href=#6-using-bro-commands class=md-nav__link><span class=md-ellipsis> 6. Using Bro Commands </span></a></li><li class=md-nav__item><a href=#7-rollback-optional class=md-nav__link><span class=md-ellipsis> 7. Rollback (Optional) </span></a></li><li class=md-nav__item><a href=#lessons-learned class=md-nav__link><span class=md-ellipsis> Lessons Learned </span></a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_4><label class=md-nav__link for=__nav_5_4 id=__nav_5_4_label tabindex><span class=md-ellipsis> Applied Examples </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_4_label aria-expanded=false><label class=md-nav__title for=__nav_5_4><span class="md-nav__icon md-icon"></span> Applied Examples </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../4.%20networking/ class=md-nav__link><span class=md-ellipsis> Lab 4: Network Config </span></a></li><li class=md-nav__item><a href=../5.%20example/ class=md-nav__link><span class=md-ellipsis> Lab 5: Real World Example </span></a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6><label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0><span class=md-ellipsis> Reference </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false><label class=md-nav__title for=__nav_6><span class="md-nav__icon md-icon"></span> Reference </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_1><label class=md-nav__link for=__nav_6_1 id=__nav_6_1_label tabindex=0><span class=md-ellipsis> API Specifications </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_1_label aria-expanded=false><label class=md-nav__title for=__nav_6_1><span class="md-nav__icon md-icon"></span> API Specifications </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../specifications/bro-helper/ class=md-nav__link><span class=md-ellipsis> Network Helper </span></a></li><li class=md-nav__item><a href=../../specifications/bro-user/ class=md-nav__link><span class=md-ellipsis> bro-user </span></a></li><li class=md-nav__item><a href=../../specifications/bro-volume/ class=md-nav__link><span class=md-ellipsis> bro-volume </span></a></li><li class=md-nav__item><a href=../../specifications/bro-activator/ class=md-nav__link><span class=md-ellipsis> bro-activator </span></a></li></ul></nav></li></ul></nav></li></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><h1 id=volumes>Volumes<a class=headerlink href=#volumes title="Permanent link">&para;</a></h1><p>In this lab you will manage storage volumes using Podman volume quadlets. First we will wire bind mounts on the host into container units so nginx can serve the synced MkDocs site. Next we will define dedicated volume units whose lifecycle is decoupled from their consuming containers. Finally, you'll also manage PostgreSQL data on ZFS, automate snapshotting and rollbacks, and see how volume descriptors integrate cleanly with container services and why a separate volume quadlet is beneficial in many scenarios.</p><ol><li>Serve Brothaman's docs with <code>Volume=</code> directives in test-quadlet.container's <code>[Container]</code> section</li><li>Creating a volume quadlet</li><li>Switching to the zfs-helper for snapshot management</li><li>Connecting the volume to the PostgreSQL container quadlet</li><li>Testing data persistence and snapshot rollbacks</li></ol><h2 id=0-snapshot>0. Snapshot<a class=headerlink href=#0-snapshot title="Permanent link">&para;</a></h2><p>Since this test runs inside a Vagrant VM, capture a baseline snapshot before making any changes. From your host machine (in the same directory as your Vagrantfile):</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>if</span><span class=w> </span>!<span class=w> </span>vagrant<span class=w> </span>snapshot<span class=w> </span>list<span class=w> </span><span class=m>2</span>&gt;<span class=p>&amp;</span><span class=m>1</span><span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>before-volumes<span class=w> </span>&gt;/dev/null<span class=p>;</span><span class=w> </span><span class=k>then</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>  </span>vagrant<span class=w> </span>snapshot<span class=w> </span>save<span class=w> </span>before-volumes<span class=p>;</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=k>else</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>  </span><span class=nb>echo</span><span class=w> </span>before-volumes<span class=w> </span>snapshot<span class=w> </span>already<span class=w> </span>exists<span class=p>;</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=k>fi</span>
</span></code></pre></div><p>This allows you to roll the VM back to its exact pre-test state later.</p><h2 id=1-serve-brothamans-docs-with-volume-directives-in-test-quadletcontainers-container-section>1. Serve Brothaman's docs with <code>Volume=</code> directives in test-quadlet.container's <code>[Container]</code> section<a class=headerlink href=#1-serve-brothamans-docs-with-volume-directives-in-test-quadletcontainers-container-section title="Permanent link">&para;</a></h2><p>In the last lab we created a simple nginx based container quadlet. By default without any configuration it serves a default test page. Let's go one step further and have it serve the brothaman website.</p><p>If you look into the Vagrantfile an rsync command is used to copy the local <code>docs</code> directory into the VM at <code>/brothaman</code> with your lingeruser's uid:</p><div class="language-ruby highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=w>  </span><span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>synced_folder</span><span class=w> </span><span class=s2>&quot;docs&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;/brothaman&quot;</span><span class=p>,</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>    </span><span class=ss>type</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;rsync&quot;</span><span class=p>,</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span><span class=ss>create</span><span class=p>:</span><span class=w> </span><span class=kp>true</span><span class=p>,</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>    </span><span class=ss>owner</span><span class=p>:</span><span class=w> </span><span class=mi>1001</span><span class=p>,</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>    </span><span class=ss>group</span><span class=p>:</span><span class=w> </span><span class=mi>1001</span><span class=p>,</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>    </span><span class=ss>rsync__chown</span><span class=p>:</span><span class=w> </span><span class=kp>true</span><span class=p>,</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>    </span><span class=ss>rsync__auto</span><span class=p>:</span><span class=w> </span><span class=kp>false</span><span class=p>,</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>    </span><span class=ss>rsync__args</span><span class=p>:</span><span class=w> </span><span class=o>[</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>      </span><span class=s2>&quot;--verbose&quot;</span><span class=p>,</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>      </span><span class=s2>&quot;--archive&quot;</span><span class=p>,</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=w>    </span><span class=o>]</span>
</span></code></pre></div><p>To have nginx serve this content, a virtual server configuration needs to be passed telling it how and from where to serve the content. The following nginx server configuration tells nginx to use /var/www/brothaman as its server root:</p><div class="language-ini highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=na>mkdir ~/nginx-conf.d/</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=na>cat &gt; ~/nginx-conf.d/brothaman.org.conf &lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=na>server {</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span><span class=na>listen 80;</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=na>server_name brothaman.org www.brothaman.org;</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>    </span><span class=c1># put your site files here (we just made it above)</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>    </span><span class=na>root /var/www/brothaman;</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>    </span><span class=na>index index.html index.htm;</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>    </span><span class=c1># log to container stdout/stderr (best for containers)</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=w>    </span><span class=na>access_log /dev/stdout;</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>    </span><span class=na>error_log  /dev/stderr warn;</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>    </span><span class=na>location / {</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=w>        </span><span class=na>try_files $uri $uri/</span><span class=w> </span><span class=o>=</span><span class=s>404</span><span class=c1>;</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=w>    </span><span class=na>}</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=na>}</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=na>EOF</span>
</span></code></pre></div><p>The container author configured nginx to look for server configurations in <code>/etc/nginx/conf.d/</code>. Our configuration needs to reside there to get picked up at startup. Instead of copying the file into the container image, we can use a bind mount to map our configuration directory onto the container at <code>/etc/nginx/conf.d/</code> the quadlet descriptor, <code>Volume=/home/lingeruser/nginx-conf.d:/etc/nginx/conf.d</code>. Another <code>Volume=</code> mapping, <code>Volume=/brothaman:/var/www/brothaman</code>, also directly within the test-quadlet's <code>[Container]</code> section. Together nginx can then serve this directory as using the brothaman.org virtual server:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/containers/systemd/
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>cat<span class=w> </span>&gt;<span class=w> </span>~/.config/containers/systemd/test-quadlet.container<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=s>[Unit]</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=s>Description=Quadlet Test Container</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=s>[Container]</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=s>Image=nginx:alpine</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=s>Exec=nginx -g &#39;daemon off;&#39;</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=s>ContainerName=test-quadlet</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=s>PublishPort=8080:80</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=s>Volume=/brothaman:/var/www/brothaman</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=s>Volume=/home/lingeruser/nginx-conf.d:/etc/nginx/conf.d</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=s>[Service]</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=s>Restart=always</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=s>TimeoutStartSec=300</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=s>StartLimitIntervalSec=60s</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=s>StartLimitBurst=5</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=s>RestartSec=10s</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=s>[Install]</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=s>EOF</span>
</span></code></pre></div><p>Before starting the container notice no separate volume quadlet was needed: meaning we did not create a <code>dot.volume</code> file. Both directives were put into the container quadlet's <code>[Container]</code> section directly. There's only one service, the test-quadlet container service, and it can now serve the mkdocs content. Reload systemd and start the container:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>systemctl<span class=w> </span>--user<span class=w> </span>restart<span class=w> </span>test-quadlet.service
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>curl<span class=w> </span><span class=s2>&quot;http://</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>:8080&quot;</span>
</span></code></pre></div><p>You should see the bro site contents and <strong>NOT</strong> the welcome the nginx page. You can point your browser to the VM's IP address at port 8080 to see it as well. Don't worry you don't have to set up DNS for brothaman.org, just accessing the IP:8080 will work fine. With one virtual server configuration nginx just uses it as the default site.</p><h2 id=2-creating-a-volume-quadlet>2. Creating a volume quadlet<a class=headerlink href=#2-creating-a-volume-quadlet title="Permanent link">&para;</a></h2><p>The example above is so simple, no separate volume quadlet was needed. However, for more complex scenarios where you:</p><ul><li>share the volume with multiple containers, or</li><li>you want to manage the lifecycle of the volume separately from the container, or</li><li>you want to use advanced volume features like ZFS snapshots</li></ul><p>It's beneficial to create a dedicated volume quadlet. In this lab section, the concept will be put to the test so we can see how it works and helps.</p><h3 id=21-create-a-zfs-backed-volume-quadlet-for-postgresql>2.1 Create a ZFS backed volume quadlet for PostgreSQL<a class=headerlink href=#21-create-a-zfs-backed-volume-quadlet-for-postgresql title="Permanent link">&para;</a></h3><p>Let's consider a database container like PostgreSQL which needs persistent storage for its data. Before the container starts, we want to take a snapshot of the data. In case anything goes wrong during the container's operation, we can roll back to the previous snapshot. In such cases, a dedicated volume quadlet is the way to go to isolate the functionality.</p><p>Let's use a ZFS-backed volume to take snapshots of the data volume between container restarts. We start by creating a ZFS dataset for PostgreSQL data storage and set it to mount at <code>/home/lingeruser/postgres</code>. Then we create a volume quadlet to manage this dataset.</p><p>Make sure you're logged as the <code>vagrant</code> user to escalate privileges to root with <code>sudo</code>. Below a ZFS dataset, <code>testing/postgres</code>, is created then its mountpoint set to <code>/home/lingeruser/postgres</code>: it mounts automatically using the ZFS mount service. The mountpoint's user and group ownership permissions are also set to be owned by lingeruser so lineruser's unprivileged containers can access it.</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>sudo<span class=w> </span>zfs<span class=w> </span>create<span class=w> </span>testing/postgres
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>sudo<span class=w> </span>zfs<span class=w> </span><span class=nb>set</span><span class=w> </span><span class=nv>mountpoint</span><span class=o>=</span>/home/lingeruser/postgres<span class=w> </span>testing/postgres
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>sudo<span class=w> </span>chown<span class=w> </span>lingeruser:lingeruser<span class=w> </span>/home/lingeruser/postgres
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>sudo<span class=w> </span>-iu<span class=w> </span>lingeruser<span class=w> </span>ls<span class=w> </span>-ld<span class=w> </span>postgres
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>df<span class=w> </span>-h<span class=w> </span>/home/lingeruser/postgres/
</span></code></pre></div><p>The dataset is now ready to be used as a persistent volume for our PostgreSQL container. Now switch back to the <code>lingeruser</code> again with <code>sudo su - lingeruser</code>:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/containers/systemd/
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>cat<span class=w> </span>&gt;<span class=w> </span>~/.config/containers/systemd/postgres-data.volume<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=s>[Unit]</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=s>Description=PostgreSQL Volume</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=s>[Volume]</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=s>VolumeName=postgres-data</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=s>Device=/home/lingeruser/postgres</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=s>Type=none</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=s>Options=bind</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=s>[Service]</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=s>ExecStartPre=/usr/sbin/zfs snapshot testing/postgres@pre</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=s>EOF</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>postgres-data-volume.service
</span></code></pre></div><blockquote><p><strong>NOTICE</strong>: The <code>postgres-data.volume</code> quadlet is started and stopped using a service name that combines the volume name, the <code>-volume</code> suffix, and the <code>.service</code> extension. The service name construction pattern is automatically handled by podman when you create a volume quadlet.</p></blockquote><h3 id=22-troubleshooting-problems>2.2 Troubleshooting Problems<a class=headerlink href=#22-troubleshooting-problems title="Permanent link">&para;</a></h3><p>How did it go for you? Using <code>journalctl --user -xe -u postgres-data-volume.service</code>, here are the failure errors in the service journal log:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>Oct<span class=w> </span><span class=m>26</span><span class=w> </span><span class=m>14</span>:13:16<span class=w> </span>debian12.localdomain<span class=w> </span>systemd<span class=o>[</span><span class=m>904</span><span class=o>]</span>:<span class=w> </span>Starting<span class=w> </span>postgres-data-volume.service<span class=w> </span>-<span class=w> </span>PostgreSQL<span class=w> </span>Volume...
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>Oct<span class=w> </span><span class=m>26</span><span class=w> </span><span class=m>14</span>:13:16<span class=w> </span>debian12.localdomain<span class=w> </span>postgres-data-volume<span class=o>[</span><span class=m>45001</span><span class=o>]</span>:<span class=w> </span>cannot<span class=w> </span>create<span class=w> </span>snapshots<span class=w> </span>:<span class=w> </span>permission<span class=w> </span>denied
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>Oct<span class=w> </span><span class=m>26</span><span class=w> </span><span class=m>14</span>:13:16<span class=w> </span>debian12.localdomain<span class=w> </span>systemd<span class=o>[</span><span class=m>904</span><span class=o>]</span>:<span class=w> </span>postgres-data-volume.service:<span class=w> </span>Control<span class=w> </span>process<span class=w> </span>exited,<span class=w> </span><span class=nv>code</span><span class=o>=</span>exited,<span class=w> </span><span class=nv>status</span><span class=o>=</span><span class=m>1</span>/FAILURE
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>Oct<span class=w> </span><span class=m>26</span><span class=w> </span><span class=m>14</span>:13:16<span class=w> </span>debian12.localdomain<span class=w> </span>systemd<span class=o>[</span><span class=m>904</span><span class=o>]</span>:<span class=w> </span>postgres-data-volume.service:<span class=w> </span>Failed<span class=w> </span>with<span class=w> </span>result<span class=w> </span><span class=s1>&#39;exit-code&#39;</span>.
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>Oct<span class=w> </span><span class=m>26</span><span class=w> </span><span class=m>14</span>:13:16<span class=w> </span>debian12.localdomain<span class=w> </span>systemd<span class=o>[</span><span class=m>904</span><span class=o>]</span>:<span class=w> </span>Failed<span class=w> </span>to<span class=w> </span>start<span class=w> </span>postgres-data-volume.service<span class=w> </span>-<span class=w> </span>PostgreSQL<span class=w> </span>Volume.
</span></code></pre></div><p>The permission error is expected. The <code>lingeruser</code> does not have permission to create snapshots. Try this as <code>vagrant</code> to escalate to sudo and delegate snapshot permission to <code>lingeruser</code> on the dataset:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>sudo<span class=w> </span>zfs<span class=w> </span>allow<span class=w> </span>lingeruser<span class=w> </span>snapshot<span class=w> </span>testing/postgres
</span></code></pre></div><p>Now sudo back to <code>lingeruser</code> and start the volume service again:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>postgres-data-volume.service
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>systemctl<span class=w> </span>--user<span class=w> </span>status<span class=w> </span>postgres-data-volume.service
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/postgres
</span></code></pre></div><p>You should see the volume service started successfully this time and a snapshot was created. Amazing! Now try stopping the volume service and starting it again now with:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>systemctl<span class=w> </span>--user<span class=w> </span>stop<span class=w> </span>postgres-data-volume.service
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>systemctl<span class=w> </span>--user<span class=w> </span>status<span class=w> </span>postgres-data-volume.service<span class=w> </span>-l<span class=w> </span>--no-pager
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>postgres-data-volume.service
</span></code></pre></div><p>This fails too because the snapshot with the same name already exists. Feel free to check the error message with <code>journalctl --user -xe -u postgres-data-volume.service</code>. Let's create snapshots with unique names using timestamps prefixed to the base name of the snapshot:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/containers/systemd/
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>cat<span class=w> </span>&gt;<span class=w> </span>~/.config/containers/systemd/postgres-data.volume<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=s>[Unit]</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=s>Description=PostgreSQL Volume</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=s>[Volume]</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=s>VolumeName=postgres-data</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=s>Device=/home/lingeruser/postgres</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=s>Type=none</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=s>Options=bind</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=s>[Service]</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=s>ExecStartPre=/usr/sbin/zfs snapshot testing/postgres@pre_$(date +%Y%m%d%H%M%S)</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=s>EOF</span>
</span></code></pre></div><p>This too fails and the output looks a little cryptic in the logs:</p><div class="language-text highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>Oct 28 08:28:45 debian12.localdomain systemd[904]: Starting postgres-data-volume.service - PostgreSQL Volume...
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>Oct 28 08:28:45 debian12.localdomain postgres-data-volume[78548]: usage:
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>Oct 28 08:28:45 debian12.localdomain postgres-data-volume[78548]:         snapshot [-r] [-o property=value] ... &lt;filesystem|volume&gt;@&lt;snap&gt; ...
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>Oct 28 08:28:45 debian12.localdomain postgres-data-volume[78548]: For the property list, run: zfs set|get
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>Oct 28 08:28:45 debian12.localdomain postgres-data-volume[78548]: For the delegated permission list, run: zfs allow|unallow
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>Oct 28 08:28:45 debian12.localdomain systemd[904]: postgres-data-volume.service: Control process exited, code=exited, status=2/INVALIDARGUMENT
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>Oct 28 08:28:45 debian12.localdomain systemd[904]: postgres-data-volume.service: Failed with result &#39;exit-code&#39;.
</span></code></pre></div><p>What's going on here? The clue is in the <code>usage</code> complaint by the zfs CLI program. It's not able to parse the command line. The problem is that the <code>$(date +%Y%m%d%H%M%S)</code> command substitution is not being interpreted by systemd as expected. To fix this, we need to wrap the command substitution in a shell execution context. Update the <code>ExecStartPre</code> line as follows and try again:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/containers/systemd/
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>cat<span class=w> </span>&gt;<span class=w> </span>~/.config/containers/systemd/postgres-data.volume<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=s>[Unit]</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=s>Description=PostgreSQL Volume</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=s>[Volume]</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=s>VolumeName=postgres-data</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=s>Device=/home/lingeruser/postgres</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=s>Type=none</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=s>Options=bind</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=s>[Service]</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=s>ExecStartPre=/bin/sh -c &#39;/usr/sbin/zfs snapshot testing/postgres@pre_&quot;$(date +%Y%m%d%H%M%S)&quot;&#39;</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=s>EOF</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>postgres-data-volume.service
</span></code></pre></div><p>This too fails. Take a look at why in the journal, but there's a bunch of junk generated instead of the date string we wanted to append. That happens because systemd is performing specifier expansion. The '%' and '$' characters have special meanings in systemd unit files. They need to be escaped to be interpreted literally. Update the <code>ExecStartPre</code> line again as follows with double <code>$$</code> and <code>%%</code>:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/containers/systemd/
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>cat<span class=w> </span>&gt;<span class=w> </span>~/.config/containers/systemd/postgres-data.volume<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=s>[Unit]</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=s>Description=PostgreSQL Volume</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=s>[Volume]</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=s>VolumeName=postgres-data</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=s>Device=/home/lingeruser/postgres</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=s>Type=none</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=s>Options=bind</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=s>[Service]</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=s>ExecStartPre=/bin/sh -c &#39;/usr/sbin/zfs snapshot testing/postgres@pre_&quot;$$(date +%%Y%%m%%d%%H%%M%%S)&quot;&#39;</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=s>EOF</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>postgres-data-volume.service
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/postgres
</span></code></pre></div><p>Now this works! Each time the volume service is started a new snapshot with a unique timestamped name is created. Great! Keep trying it and test by starting and restarting the service. Here let me help you:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=k>for</span><span class=w> </span>restart<span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>$(</span>seq<span class=w> </span><span class=m>1</span><span class=w> </span><span class=m>3</span><span class=k>)</span><span class=p>;</span><span class=w> </span><span class=k>do</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=w>  </span>systemctl<span class=w> </span>--user<span class=w> </span>restart<span class=w> </span>postgres-data-volume.service
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=w>  </span>sleep<span class=w> </span><span class=m>2</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=k>done</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/postgres
</span></code></pre></div><h3 id=23-lets-delete-the-extra-snapshots>2.3 Let's delete the extra snapshots<a class=headerlink href=#23-lets-delete-the-extra-snapshots title="Permanent link">&para;</a></h3><p>That's looking good. Multiple snapshots were created with unique names. Perfect! But now we got that <code>pre</code> without the prefix let's try deleting that still logged in as the <code>lingeruser</code>:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>zfs<span class=w> </span>destroy<span class=w> </span>testing/postgres@pre
</span></code></pre></div><p>In fact we cannot delete any snapshot. You should see they all fail due to a lack of permissions. That's because the <code>lingeruser</code> does not have permission to destroy snapshots. Let's switch back to <code>vagrant</code> and delegate the destroy permission on the dataset to <code>lingeruser</code>:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>sudo<span class=w> </span>zfs<span class=w> </span>allow<span class=w> </span>lingeruser<span class=w> </span>destroy,snapshot<span class=w> </span>testing/postgres
</span></code></pre></div><p>Now if you then try the destroy on the snapshot again it still does not work. What's going on here? The reason is ZFS supports the delegation of snapshot creation, but not the destruction of snapshots. Even the dataset owner can not destroy snapshots. But try destroy the pre snapshot with the <code>vagrant</code> user as root:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>vagrant@debian12:~$<span class=w> </span>sudo<span class=w> </span>zfs<span class=w> </span>destroy<span class=w> </span>testing/postgres@pre
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>vagrant@debian12:~$<span class=w> </span>sudo<span class=w> </span>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/postgres
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>NAME<span class=w>                                  </span>USED<span class=w>  </span>AVAIL<span class=w>     </span>REFER<span class=w>  </span>MOUNTPOINT
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>testing/postgres@pre-20251028085229<span class=w>     </span>0B<span class=w>      </span>-<span class=w>     </span><span class=m>40</span>.0M<span class=w>  </span>-
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>testing/postgres@pre-20251028085533<span class=w>     </span>0B<span class=w>      </span>-<span class=w>     </span><span class=m>40</span>.0M<span class=w>  </span>-
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>testing/postgres@pre-20251028085535<span class=w>     </span>0B<span class=w>      </span>-<span class=w>     </span><span class=m>40</span>.0M<span class=w>  </span>-
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>testing/postgres@pre-20251028085537<span class=w>     </span>0B<span class=w>      </span>-<span class=w>     </span><span class=m>40</span>.0M<span class=w>  </span>-
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a>vagrant@debian12:~$
</span></code></pre></div><p>That worked but we had to exit the <code>lingeruser</code> and then escalate to root with <code>sudo</code> as the <code>vagrant</code> user. Not very convenient.</p><h2 id=3-switching-to-the-zfs-helper-for-snapshot-management>3. Switching to the zfs-helper for snapshot management<a class=headerlink href=#3-switching-to-the-zfs-helper-for-snapshot-management title="Permanent link">&para;</a></h2><p>So to manage snapshot deletion, we need to be perform the destroy operation with elevated privileges with the vagrant sudo enabled user. This is a limitation of OpenZFS's delegation model. The whole situation should be pretty irritating to you. Especially if you want to automate snapshot management in unprivileged containers and have to login and out of one user to sudo from another all the time right?</p><blockquote><p><strong>WARNING</strong>: What many lazy admins (who you should never hire) often do in this case is make their unprivileged users sudoers without password prompt for zfs commands. Even adding having a sudo password should be forbidden on production systems. Unprivileged users for application sandboxing purposes should <strong>NEVER</strong> have the ability to escalate privileges with or without passwords. WTF is the point anyway right?</p></blockquote><p>Then what if you want out of this login, log out hell, and want some consistency. First off you should be automating the process with DevOps tools, but let me not go there right now. It's still pretty irritating even if you automate things. Plus doing so you still need two different users, one with sudo, and the target non sudoers user contexts to properly manage snapshots. Ugh.</p><h3 id=31-setup-lingeruser-to-use-zfs-helper>3.1 Setup lingeruser to use zfs-helper<a class=headerlink href=#31-setup-lingeruser-to-use-zfs-helper title="Permanent link">&para;</a></h3><p>Although there are several ways to skin this cat, the best is to use a helper service that runs with elevated privileges and performs zfs management tasks on behalf of unprivileged user-scoped services. Such a service needs a solid policy framework to validate and authorize requests from unprivileged users. Its authorization controls should limit what operations can be performed on which datasets by which users. Luckily we did just that for brothaman and it is called <a href=https://github.com/brothaman-org/zfs-helper><code>zfs-helper</code></a>. The stock package is already installed in the VM. All we need to do is configure it to allow our user's <code>postgres-data-volume.service</code> to manage snapshots on the <code>testing/postgres</code> dataset. See the edits added to the zfs-helper configuration files at <code>/etc/zfs-helper/policy.d/</code>:</p><blockquote><p>Perform these operations as the <code>vagrant</code> user.</p></blockquote><div class="language-bash highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>sudo<span class=w> </span>usermod<span class=w> </span>-a<span class=w> </span>-G<span class=w> </span>zfshelper<span class=w> </span>lingeruser
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>sudo<span class=w> </span>loginctl<span class=w> </span>kill-user<span class=w> </span>lingeruser
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>sudo<span class=w> </span>loginctl<span class=w> </span>user-status<span class=w> </span>lingeruser<span class=w> </span>--no-pager
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>sudo<span class=w> </span>loginctl<span class=w> </span>enable-linger<span class=w> </span>lingeruser
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>sudo<span class=w> </span>loginctl<span class=w> </span>user-status<span class=w> </span>lingeruser<span class=w> </span>--no-pager
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a>sudo<span class=w> </span>-iu<span class=w> </span>lingeruser<span class=w> </span>id
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=nb>pushd</span><span class=w> </span>.<span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>true</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a>sudo<span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span>/etc/zfs-helper/policy.d/lingeruser
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=nb>cd</span><span class=w> </span>/etc/zfs-helper/policy.d/lingeruser
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a>cat<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39; | sudo tee -a units.list</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=s>postgres-data-volume.service</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=s>EOF</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a>cat<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39; | sudo tee -a mount.list unmount.list snapshot.list rollback.list create.list destroy.list</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=s>lingeruser testing/postgres</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a><span class=s>EOF</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a><span class=nb>popd</span>
</span></code></pre></div><p>Now let's use the service to manage snapshots for us. First, update the volume quadlet to use zfs-helper for snapshot creation instead of calling zfs directly. We could do this before directly since we were granted delegation, but let's do it now again to be consistent:</p><p>Issue these commands as the <code>lingeruser</code>:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/containers/systemd/
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>cat<span class=w> </span>&gt;<span class=w> </span>~/.config/containers/systemd/postgres-data.volume<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=s>[Unit]</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=s>Description=PostgreSQL Volume</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=s>[Volume]</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=s>VolumeName=postgres-data</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=s>Device=/home/lingeruser/postgres</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=s>Type=none</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=s>Options=bind</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=s>[Service]</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=s>ExecStartPre=/bin/sh -c &#39;/usr/bin/zfs-helperctl snapshot testing/postgres@pre_&quot;$$(date +%%Y%%m%%d%%H%%M%%S)&quot;&#39;</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=s>EOF</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a>systemctl<span class=w> </span>--user<span class=w> </span>restart<span class=w> </span>postgres-data-volume.service
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/postgres
</span></code></pre></div><h3 id=32-delete-pre-start-snapshots-above-a-limit>3.2 Delete pre-start snapshots above a limit<a class=headerlink href=#32-delete-pre-start-snapshots-above-a-limit title="Permanent link">&para;</a></h3><p>Now let's enhance the volume quadlet further to delete old snapshots above a certain limit each time the volume service starts. This way we can keep the number of snapshots manageable without manual intervention. Update the volume quadlet as follows to add a snapshot cleanup step before creating a new snapshot:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/containers/systemd/
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>cat<span class=w> </span>&gt;<span class=w> </span>~/.config/containers/systemd/postgres-data.volume<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=s>[Unit]</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=s>Description=PostgreSQL Volume</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=s>PartOf=test-postgresql.service</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=s>[Volume]</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=s>VolumeName=postgres-data</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=s>Device=/home/lingeruser/postgres</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=s>Type=none</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=s>Options=bind</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=s>[Service]</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=s>Environment=KEEP_SNAPSHOTS=5</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=s>ExecStartPre=/bin/sh -c &#39;/usr/bin/zfs-helperctl snapshot testing/postgres@pre_&quot;$$(date +%%Y%%m%%d%%H%%M%%S)&quot;&#39;</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=s>ExecStartPre=/bin/sh -c &#39;zfs list -t snapshot -o name -s creation | grep -E &quot;^testing/postgres@pre_*&quot; | head -n -$${KEEP_SNAPSHOTS} | xargs -r -n1 zfs-helperctl destroy&#39;</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a><span class=s>EOF</span>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a>systemctl<span class=w> </span>--user<span class=w> </span>restart<span class=w> </span>postgres-data-volume.service
</span><span id=__span-21-20><a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/postgres
</span></code></pre></div><p>Now each time the volume service starts, it will delete old pre-start snapshots beyond the specified limit after creating a new snapshot. This keeps the snapshot count manageable automatically. No fancy retention policies manager services or cron jobs needed. Just let the volume service handle it for you. You can verify this by restarting the volume service multiple times and checking the snapshot list:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=k>for</span><span class=w> </span>restart<span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>$(</span>seq<span class=w> </span><span class=m>1</span><span class=w> </span><span class=m>10</span><span class=k>)</span><span class=p>;</span><span class=w> </span><span class=k>do</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=w>  </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;snapshot with </span><span class=nv>$restart</span><span class=s2>&quot;</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=w>  </span>systemctl<span class=w> </span>--user<span class=w> </span>restart<span class=w> </span>postgres-data-volume.service
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=w>  </span>sleep<span class=w> </span><span class=m>3</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=w>  </span>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/postgres
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=k>done</span>
</span></code></pre></div><h3 id=33-listing-volumes>3.3 Listing Volumes<a class=headerlink href=#33-listing-volumes title="Permanent link">&para;</a></h3><p>You can list all defined volume quadlets using the <code>podman volume ls</code> command. This will show you the volume name, driver, and mount point:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>lingeruser@debian12:~$<span class=w> </span>podman<span class=w> </span>volume<span class=w> </span>ls
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>DRIVER<span class=w>      </span>VOLUME<span class=w> </span>NAME
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=nb>local</span><span class=w>       </span>postgresql-data
</span></code></pre></div><p>Notice the volume name is <code>postgresql-data</code> derived from the quadlet file's VolumeName= directive value. The driver is <code>local</code> since it's a bind mount volume. The mount point can be found using <code>podman volume inspect postgresql-data</code>:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a>lingeruser@debian12:~$<span class=w> </span>podman<span class=w> </span>volume<span class=w> </span>inspect<span class=w> </span>postgresql-data
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=o>[</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=w>    </span><span class=o>{</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=w>        </span><span class=s2>&quot;Name&quot;</span>:<span class=w> </span><span class=s2>&quot;postgresql-data&quot;</span>,
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>        </span><span class=s2>&quot;Driver&quot;</span>:<span class=w> </span><span class=s2>&quot;local&quot;</span>,
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=w>        </span><span class=s2>&quot;Mountpoint&quot;</span>:<span class=w> </span><span class=s2>&quot;/home/lingeruser/.local/share/containers/storage/volumes/postgresql-data/_data&quot;</span>,
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>        </span><span class=s2>&quot;CreatedAt&quot;</span>:<span class=w> </span><span class=s2>&quot;2025-11-17T04:23:49.540718136-08:00&quot;</span>,
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>        </span><span class=s2>&quot;Labels&quot;</span>:<span class=w> </span><span class=o>{}</span>,
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>        </span><span class=s2>&quot;Scope&quot;</span>:<span class=w> </span><span class=s2>&quot;local&quot;</span>,
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>        </span><span class=s2>&quot;Options&quot;</span>:<span class=w> </span><span class=o>{</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=w>              </span><span class=s2>&quot;device&quot;</span>:<span class=w> </span><span class=s2>&quot;/home/lingeruser/postgres&quot;</span>,
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=w>              </span><span class=s2>&quot;o&quot;</span>:<span class=w> </span><span class=s2>&quot;bind&quot;</span>,
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=w>              </span><span class=s2>&quot;type&quot;</span>:<span class=w> </span><span class=s2>&quot;none&quot;</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=w>        </span><span class=o>}</span>,
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=w>        </span><span class=s2>&quot;MountCount&quot;</span>:<span class=w> </span><span class=m>1</span>,
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=w>        </span><span class=s2>&quot;NeedsCopyUp&quot;</span>:<span class=w> </span>true,
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=w>        </span><span class=s2>&quot;NeedsChown&quot;</span>:<span class=w> </span>true,
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=w>        </span><span class=s2>&quot;LockNumber&quot;</span>:<span class=w> </span><span class=m>0</span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=w>    </span><span class=o>}</span>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=o>]</span>
</span></code></pre></div><p>What is strange here? The Mountpoint is <code>/home/lingeruser/.local/share/containers/storage/volumes/postgresql-data/_data</code> which is not the host path we specified in the quadlet right?</p><p>Podman manages volumes internally and uses its own storage paths under <code>${UNPRIVILEGED_USER_HOME}/.local/share/containers/storage/volumes/</code>. It does a kind of indirection where it bind mounts your specified host path into its internal volume storage path when the volume is used by a container. This allows Podman to manage volumes consistently regardless of their underlying storage location.</p><p>The actual bind mount source is <code>/home/lingeruser/postgres</code> as defined in the quadlet. It is bind mounted locally to <code>/home/lingeruser/.local/share/containers/storage/volumes/postgresql-data/_data</code> when the volume is used by a container, then bind mounted into the container at the specified path. From inside the container, it only ever sees <code>/var/lib/postgresql/data</code> mounted from the Podman managed volume's Mountpoint path.</p><p>The only cosmetic difference from a straight Volume=/host/path:/container/path is that Podman shows its internal _data path as Mountpoint and keeps your host directory in Options.device. Functionally, it's the same thing, but with the benefits of a first-class Podman volume object.</p><h2 id=4-connecting-the-volume-to-the-postgresql-container-quadlet>4. Connecting the volume to the PostgreSQL container quadlet<a class=headerlink href=#4-connecting-the-volume-to-the-postgresql-container-quadlet title="Permanent link">&para;</a></h2><p>Finally, let's connect the volume quadlet to the PostgreSQL container quadlet so the container can use the persistent storage with snapshotting and test it out. Update the PostgreSQL container quadlet to include the volume:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/containers/systemd/
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>cat<span class=w> </span>&gt;<span class=w> </span>~/.config/containers/systemd/test-postgresql.container<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=s>[Unit]</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=s>Description=PostgreSQL Container</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=s>PropagatesStopTo=postgres-data-volume.service</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=s>BindsTo=postgres-data-volume.service</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=s>After=postgres-data-volume.service</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=s>[Container]</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=s>Image=postgres:16</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=s>ContainerName=test-postgresql</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=s>Environment=POSTGRES_PASSWORD=password</span>
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=s>Volume=postgresql-data:/var/lib/postgresql/data</span>
</span><span id=__span-25-14><a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=s>PublishPort=5432:5432</span>
</span><span id=__span-25-15><a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a>
</span><span id=__span-25-16><a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a><span class=s>[Service]</span>
</span><span id=__span-25-17><a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a><span class=s>Restart=always</span>
</span><span id=__span-25-18><a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a><span class=s>TimeoutStartSec=300</span>
</span><span id=__span-25-19><a id=__codelineno-25-19 name=__codelineno-25-19 href=#__codelineno-25-19></a><span class=s>StartLimitBurst=5</span>
</span><span id=__span-25-20><a id=__codelineno-25-20 name=__codelineno-25-20 href=#__codelineno-25-20></a><span class=s>RestartSec=10s</span>
</span><span id=__span-25-21><a id=__codelineno-25-21 name=__codelineno-25-21 href=#__codelineno-25-21></a>
</span><span id=__span-25-22><a id=__codelineno-25-22 name=__codelineno-25-22 href=#__codelineno-25-22></a><span class=s>[Install]</span>
</span><span id=__span-25-23><a id=__codelineno-25-23 name=__codelineno-25-23 href=#__codelineno-25-23></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-25-24><a id=__codelineno-25-24 name=__codelineno-25-24 href=#__codelineno-25-24></a><span class=s>EOF</span>
</span><span id=__span-25-25><a id=__codelineno-25-25 name=__codelineno-25-25 href=#__codelineno-25-25></a>
</span><span id=__span-25-26><a id=__codelineno-25-26 name=__codelineno-25-26 href=#__codelineno-25-26></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-25-27><a id=__codelineno-25-27 name=__codelineno-25-27 href=#__codelineno-25-27></a>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>test-postgresql.service
</span></code></pre></div><p>Try starting the PostgreSQL container service. It should start successfully and use the ZFS-backed volume for data storage. You can verify this by checking the status of the container service and logging in as the postgres user on the server with psql:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a>systemctl<span class=w> </span>--user<span class=w> </span>status<span class=w> </span>test-postgresql.service<span class=w> </span>--no-pager<span class=w> </span>-l
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=nb>export</span><span class=w> </span><span class=nv>PGPASSWORD</span><span class=o>=</span>password
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;\l&#39;</span>
</span></code></pre></div><h3 id=notes-on-propagatesstopto-bindsto-partof-and-after>Notes on PropagatesStopTo=, BindsTo=, PartOf=, and After=<a class=headerlink href=#notes-on-propagatesstopto-bindsto-partof-and-after title="Permanent link">&para;</a></h3><p>These directives are used to manage the relationships between systemd services:</p><ul><li><code>PartOf=</code>: This directive indicates that the service is part of another service. If the parent service is stopped or restarted, the child service will also be affected. We made the volume quadlet part of the container quadlet so that stopping the container also stops the volume service. If it was shared we would not opt to do this.</li><li><code>BindsTo=</code>: This directive creates a stronger link between services. If the service specified in <code>BindsTo=</code> is stopped, the current service will also be stopped. Make no sense to run the database without its volume right? Before the volume stops the database is shutdown allowing it to sync its buffers to prevent corruption.</li><li><code>After=</code>: This directive specifies that the current service should be started only after the specified service has been started. Doh! The database needs its volume to be ready before it starts.</li><li><code>PropagatesStopTo=</code>: This directive allows a service to propagate stop signals to its dependencies. When the container is stopped, it will also stop the volume service. This way stopping the container actually stops the volume service too. Without this directive a systemctl restart of the container service will not stop and start the volume service.</li></ul><p>Systemd is extremely powerful and an amazing init system. In fact it goes well beyond an init system. It is an entire service management platform. Learning to use its features effectively can greatly enhance your ability to manage services and their dependencies. Unfortunately, we snuck these in, with only slight mentions as describe here to limit the scope of this lab.</p><p>With Quadlets, Podman has taken a revolutionary approach to container management by integrating deeply with systemd. This integration leverages systemd's capabilities to manage the container lifecycle and their dependencies effectively. It brings the power of systemd to container management, allowing for more robust and reliable containerized applications closer to the system. Its use of core system primitives instead of reinventing the wheel is a form of convergence. It's a game-changer for how we think about and manage containers in a Linux environment.</p><h2 id=5-testing-data-persistence-and-snapshot-rollbacks>5. Testing data persistence and snapshot rollbacks<a class=headerlink href=#5-testing-data-persistence-and-snapshot-rollbacks title="Permanent link">&para;</a></h2><blockquote><p><strong>IMPORTANT</strong>: For this section you will need to keep two shells open, one logged into the VM as the <code>vagrant</code> user and one logged in as the <code>lingeruser</code>. This is because rolling back snapshots requires elevated privileges that only the <code>vagrant</code> user has via sudo. The <code>lingeruser</code> will be used to interact with the PostgreSQL container and perform database operations.</p></blockquote><p>You can now connect to the PostgreSQL container and verify that the data is being stored in the ZFS-backed volume in the <code>lingeruser</code> shell:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=nb>export</span><span class=w> </span><span class=nv>PGPASSWORD</span><span class=o>=</span>password
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;\l&#39;</span>
</span></code></pre></div><p>You should see the default PostgreSQL databases listed. Let's create a new database, insert some data, and then restart the container to see that the data persists across restarts thanks to the ZFS-backed volume in the <code>lingeruser</code> shell:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=c1># Capture the latest snapshot before creating the test database</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=nv>before_testdb_snapshot</span><span class=o>=</span><span class=k>$(</span>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/postgres<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-v<span class=w> </span>NAME<span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $1}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>tail<span class=w> </span>-n<span class=w> </span><span class=m>1</span><span class=k>)</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;Latest snapshot before the testdb: </span><span class=nv>$before_testdb_snapshot</span><span class=s2>&quot;</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=c1># Let&#39;s create the database, the test table, and insert the test data</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=nb>export</span><span class=w> </span><span class=nv>PGPASSWORD</span><span class=o>=</span>password
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;CREATE DATABASE testdb;&#39;</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>testdb<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;CREATE TABLE testtable (id SERIAL PRIMARY KEY, name VARCHAR(50));&#39;</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>testdb<span class=w> </span>-c<span class=w> </span><span class=s2>&quot;INSERT INTO testtable (name) VALUES (&#39;testname&#39;);&quot;</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>testdb<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;SELECT * FROM testtable;&#39;</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=c1># Bounce the server to create another snapshot with the new db, table, and one testname record</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a>systemctl<span class=w> </span>--user<span class=w> </span>restart<span class=w> </span>test-postgresql.service
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a><span class=nv>testname_snapshot</span><span class=o>=</span><span class=k>$(</span>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/postgres<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-v<span class=w> </span>NAME<span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $1}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>tail<span class=w> </span>-n<span class=w> </span><span class=m>1</span><span class=k>)</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;Latest snapshot with only testable: </span><span class=nv>$testname_snapshot</span><span class=s2>&quot;</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a>sleep<span class=w> </span><span class=m>5</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a><span class=c1># Verify the data is still there and add another name, anthony</span>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19 href=#__codelineno-28-19></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>testdb<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;SELECT * FROM testtable;&#39;</span><span class=w> </span>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20 href=#__codelineno-28-20></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>testdb<span class=w> </span>-c<span class=w> </span><span class=s2>&quot;INSERT INTO testtable (name) VALUES (&#39;anthony&#39;);&quot;</span>
</span><span id=__span-28-21><a id=__codelineno-28-21 name=__codelineno-28-21 href=#__codelineno-28-21></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>testdb<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;SELECT * FROM testtable;&#39;</span>
</span><span id=__span-28-22><a id=__codelineno-28-22 name=__codelineno-28-22 href=#__codelineno-28-22></a>
</span><span id=__span-28-23><a id=__codelineno-28-23 name=__codelineno-28-23 href=#__codelineno-28-23></a><span class=c1># Bounce the server to create another snapshot with the new data</span>
</span><span id=__span-28-24><a id=__codelineno-28-24 name=__codelineno-28-24 href=#__codelineno-28-24></a>systemctl<span class=w> </span>--user<span class=w> </span>restart<span class=w> </span>test-postgresql.service
</span><span id=__span-28-25><a id=__codelineno-28-25 name=__codelineno-28-25 href=#__codelineno-28-25></a><span class=nv>anthony_snapshot</span><span class=o>=</span><span class=k>$(</span>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/postgres<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-v<span class=w> </span>NAME<span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $1}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>tail<span class=w> </span>-n<span class=w> </span><span class=m>1</span><span class=k>)</span>
</span><span id=__span-28-26><a id=__codelineno-28-26 name=__codelineno-28-26 href=#__codelineno-28-26></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;Latest snapshot with anthony: </span><span class=nv>$anthony_snapshot</span><span class=s2>&quot;</span>
</span><span id=__span-28-27><a id=__codelineno-28-27 name=__codelineno-28-27 href=#__codelineno-28-27></a>sleep<span class=w> </span><span class=m>5</span>
</span><span id=__span-28-28><a id=__codelineno-28-28 name=__codelineno-28-28 href=#__codelineno-28-28></a>
</span><span id=__span-28-29><a id=__codelineno-28-29 name=__codelineno-28-29 href=#__codelineno-28-29></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>testdb<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;SELECT * FROM testtable;&#39;</span>
</span><span id=__span-28-30><a id=__codelineno-28-30 name=__codelineno-28-30 href=#__codelineno-28-30></a><span class=c1># Delete the testname entry</span>
</span><span id=__span-28-31><a id=__codelineno-28-31 name=__codelineno-28-31 href=#__codelineno-28-31></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>testdb<span class=w> </span>-c<span class=w> </span><span class=s2>&quot;DELETE FROM testtable WHERE name = &#39;testname&#39;;&quot;</span>
</span><span id=__span-28-32><a id=__codelineno-28-32 name=__codelineno-28-32 href=#__codelineno-28-32></a><span class=c1># Verify the deletion</span>
</span><span id=__span-28-33><a id=__codelineno-28-33 name=__codelineno-28-33 href=#__codelineno-28-33></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>testdb<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;SELECT * FROM testtable;&#39;</span>
</span><span id=__span-28-34><a id=__codelineno-28-34 name=__codelineno-28-34 href=#__codelineno-28-34></a>
</span><span id=__span-28-35><a id=__codelineno-28-35 name=__codelineno-28-35 href=#__codelineno-28-35></a><span class=c1># Shutdown the server to rollback</span>
</span><span id=__span-28-36><a id=__codelineno-28-36 name=__codelineno-28-36 href=#__codelineno-28-36></a>systemctl<span class=w> </span>--user<span class=w> </span>stop<span class=w> </span>test-postgresql.service
</span><span id=__span-28-37><a id=__codelineno-28-37 name=__codelineno-28-37 href=#__codelineno-28-37></a><span class=nv>no_testname_snapshot</span><span class=o>=</span><span class=k>$(</span>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/postgres<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-v<span class=w> </span>NAME<span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $1}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>tail<span class=w> </span>-n<span class=w> </span><span class=m>1</span><span class=k>)</span>
</span><span id=__span-28-38><a id=__codelineno-28-38 name=__codelineno-28-38 href=#__codelineno-28-38></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;Last snapshot without testname: </span><span class=nv>$no_testname_snapshot</span><span class=s2>&quot;</span>
</span></code></pre></div><p>I know that's a long block of code but it creates a database, a table, then inserts two rows, and deletes one row. It creates snapshots at each step. You can see how the data changes over time with each snapshot. The code block also saves each snapshot name into variables for later use to experiment with rollbacks. Do not close the lingeruser shell yet so we can use those values to rollback.</p><p>Let's try reverting to a previous snapshot to see the table revert to its earlier state. However, OpenZFS's delegation model has another shortcoming that bites us yet again: rollback delegation is not implemented. So to rollback we have to escalate privileges with the <code>vagrant</code> user via sudo. We already shut the server down at the end of the code block so we can rollback without corrupting the database.</p><blockquote><p><strong>WARNING</strong>: Never roll back a dataset while it's mounted and in use. Always stop the container first to unmount the volume cleanly. This is especially important with databases that can be corrupted when the underlying disk changes leaving them in inconsistent states.</p></blockquote><p>Let's go back to the <code>vagrant</code> user's shell to elevate privileges for these rollback operations:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>sudo<span class=w> </span>zfs<span class=w> </span>rollback<span class=w> </span>-r<span class=w> </span><span class=s2>&quot;[copy the anthony_snapshot variable&#39;s value from the lingeruser shell here]&quot;</span>
</span></code></pre></div><blockquote><p>Switching user shells we cannot just echo the $anthony_snapshot variable since it's not defined in the vagrant user's context. Just re-echo the value and copy it from within the lingeruser's shell. Now let's restart the PostgreSQL container and verify the data in the table:</p></blockquote><div class="language-bash highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>test-postgresql.service
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=nb>export</span><span class=w> </span><span class=nv>PGPASSWORD</span><span class=o>=</span>password
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-d<span class=w> </span>testdb<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;SELECT * FROM testtable;&#39;</span>
</span></code></pre></div><p>Now you should see the previously deleted 'testname', and the 'anthony' entry present again since we rolled back to the snapshot taken before 'testname' was deleted towards the end of the code block. It was as if the delete of the <code>testname</code> entry never happened. Amazing!</p><p>Now try rolling back successively further in time to snapshots taken before 'anthony' was added on your own. This will solidify your understanding of whats going on here. Just remember, we captured the past snapshot values in the <code>testname_snapshot</code> and <code>before_testdb_snapshot</code> variables in the <code>lingeruser</code> shell. Don't forget to shutdown the database in the vagrant user shell before each rollback.</p><h3 id=why-didnt-you-use-zfs-helper-for-rollbacks>Why didn't you use zfs-helper for rollbacks?<a class=headerlink href=#why-didnt-you-use-zfs-helper-for-rollbacks title="Permanent link">&para;</a></h3><p>The <code>zfs-helper</code> is explicitly designed to avoid delegated calls from the command line or elsewhere. It <strong>ONLY</strong> services requests from systemd unit services and ties authorization to systemd unit identity and kernel authenticated unix socket clients. These facilities work together to provide a secure and auditable mechanism for delegated management of ZFS datasets.</p><h3 id=how-does-it-work>How does it work?<a class=headerlink href=#how-does-it-work title="Permanent link">&para;</a></h3><p>Systemd services have well-defined identities and can be authenticated and authorized based on their unit names with secure cgroup checks. These checks connects <code>zfs-helper</code> policies with systemd units to enforce strict access controls for zfs management operations on a per dataset (noun), per user (subject), and per operation (verb) basis.</p><p>During each <code>zfs-helperctl</code> call it reads <code>/proc/self/cgroup</code>, maps that back to the calling unit name, and refuses requests unless that unit appears in the unit allow-list (the <code>units.list</code> you maintain under <code>/etc/zfs-helper/policy.d/</code>). That cgroup check is why you can list allowed datasets per operation and know the request actually came from the expected quadlet rather than an arbitrary process the user might spawn.</p><p>A few tightly stitched mechanisms work together to provide additional security. Unix sockets, <code>AF_UNIX</code>, and its <code>SO_PEERCRED</code> options allow the <code>zfs-helper</code> to retrieve the UID/GID/PID credentials of the calling service. The kernel verifies the identity of the socket client. The server socket is created by systemd when the <code>zfs-helper</code> service starts and is under its control. Only users in the <code>zfshelper</code> system group can access this socket. Group access further ensures that <strong>ONLY</strong> authorized users can communicate with the <code>zfs-helper</code> service.</p><p>In summary, when a service connects to this socket to make a request, the kernel provides the credentials of the calling process through the socket. An additional systemd user cgroup check ensures that the calling service is running within the correct user and systemd context. The allow lists control what operations can be performed on which datasets by which services. This multi-layered approach ensures that only authorized services can perform specific ZFS operations on designated datasets, providing a robust security model for delegated ZFS management.</p><h3 id=cant-a-compromised-unprivileged-account-create-a-service-with-the-same-name>Can't a compromised unprivileged account create a service with the same name?<a class=headerlink href=#cant-a-compromised-unprivileged-account-create-a-service-with-the-same-name title="Permanent link">&para;</a></h3><p>If an attacker only gets shell access as a user who happens to be in the <code>zfshelper</code> group, the cgroup gate keeps them from just running <code>zfs-helperctl</code> by handtheir shell sits in a session cgroup, not the whitelisted service cgroup, so the helper denies the request. This blocks one of the easiest privilege-abuse paths and gives you auditability (we know postgres-data-volume.service asked for that snapshot). Another reason why a separate volume quadlet as a separate service is a good security practice.</p><p>A compromised account can still try to install a brand new user service, but it won't match anything in <code>units.list</code>, so the helper still rejects those calls. To succeed they'd have to hijack an already-authorized unit name; at that point they can trigger whatever operations you've granted to that unit (destroy snapshots, etc.), but only on the datasets/verbs you explicitly allowed. They cannot grant themselves access to other datasets or new verbs without compromising the root-maintained policy files.</p><p>Bottom line: membership in the <code>zfshelper</code> group is powerful and should be restricted, yet the cgroup check sharply limits post-compromise blast radius to the exact dataset+operation pairs you've whitelisted. The helper doesn't stop a user from abusing the privileges you intentionally delegated, so continue to scope those policy entries tightly and monitor the corresponding services' behavior.</p><h2 id=6-using-bro-commands>6. Using Bro Commands<a class=headerlink href=#6-using-bro-commands title="Permanent link">&para;</a></h2><p>Now let's see how we can do all these things EZ PZ with Brothaman's <code>bro-volume</code> command. First, create a new postgres user with <code>bro-user</code> and a postgresql container quadlet:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a>sudo<span class=w> </span>bro-user<span class=w> </span>--remove<span class=w> </span>postgres
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>sudo<span class=w> </span>bro-user<span class=w> </span>postgres
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>podman<span class=w> </span>run<span class=w> </span>--rm<span class=w> </span>quay.io/podman/hello
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span>~postgres/.config/containers/systemd/
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a>cat<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39; | sudo -iu postgres tee ~postgres/.config/containers/systemd/postgresql.container</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=s>[Unit]</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=s>Description=PostgreSQL Container</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=s>[Container]</span>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=s>Image=docker.io/library/postgres:16</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=s>ContainerName=postgresql</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a><span class=s>Environment=POSTGRES_PASSWORD=password</span>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=s>PublishPort=5432:5432</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a><span class=s>Network=none</span>
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a>
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a><span class=s>[Service]</span>
</span><span id=__span-31-17><a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a><span class=s>Restart=always</span>
</span><span id=__span-31-18><a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a><span class=s>TimeoutStartSec=120</span>
</span><span id=__span-31-19><a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a><span class=s>StartLimitBurst=5</span>
</span><span id=__span-31-20><a id=__codelineno-31-20 name=__codelineno-31-20 href=#__codelineno-31-20></a><span class=s>RestartSec=10s</span>
</span><span id=__span-31-21><a id=__codelineno-31-21 name=__codelineno-31-21 href=#__codelineno-31-21></a>
</span><span id=__span-31-22><a id=__codelineno-31-22 name=__codelineno-31-22 href=#__codelineno-31-22></a><span class=s>[Install]</span>
</span><span id=__span-31-23><a id=__codelineno-31-23 name=__codelineno-31-23 href=#__codelineno-31-23></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-31-24><a id=__codelineno-31-24 name=__codelineno-31-24 href=#__codelineno-31-24></a><span class=s>EOF</span>
</span><span id=__span-31-25><a id=__codelineno-31-25 name=__codelineno-31-25 href=#__codelineno-31-25></a>
</span><span id=__span-31-26><a id=__codelineno-31-26 name=__codelineno-31-26 href=#__codelineno-31-26></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-31-27><a id=__codelineno-31-27 name=__codelineno-31-27 href=#__codelineno-31-27></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>postgresql.service
</span><span id=__span-31-28><a id=__codelineno-31-28 name=__codelineno-31-28 href=#__codelineno-31-28></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>status<span class=w> </span>postgresql.service<span class=w> </span>-l<span class=w> </span>--no-pager
</span><span id=__span-31-29><a id=__codelineno-31-29 name=__codelineno-31-29 href=#__codelineno-31-29></a>
</span><span id=__span-31-30><a id=__codelineno-31-30 name=__codelineno-31-30 href=#__codelineno-31-30></a><span class=nb>export</span><span class=w> </span><span class=nv>PGPASSWORD</span><span class=o>=</span>password
</span><span id=__span-31-31><a id=__codelineno-31-31 name=__codelineno-31-31 href=#__codelineno-31-31></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;\l&#39;</span>
</span></code></pre></div><p>All good right? Now create a ZFS-backed volume quadlet for the postgres user with <code>bro-volume</code>:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--name<span class=w> </span>postgresql-data<span class=w> </span>--owner<span class=w> </span>postgres<span class=w> </span>--container<span class=w> </span>postgresql<span class=w> </span>--container-path<span class=w> </span>/var/lib/postgresql/data
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--name<span class=w> </span>postgresql-config<span class=w> </span>--owner<span class=w> </span>postgres<span class=w> </span>--container<span class=w> </span>postgresql<span class=w> </span>--container-path<span class=w> </span>/etc/postgresql
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>podman<span class=w> </span>volume<span class=w> </span>list
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>status<span class=w> </span>postgresql-data-volume.service<span class=w> </span>-l<span class=w> </span>--no-pager
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>status<span class=w> </span>postgresql-config-volume.service<span class=w> </span>-l<span class=w> </span>--no-pager
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>restart<span class=w> </span>postgresql.service
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>podman<span class=w> </span>volume<span class=w> </span>list
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>status<span class=w> </span>postgresql-data-volume.service<span class=w> </span>-l<span class=w> </span>--no-pager
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>status<span class=w> </span>postgresql-config-volume.service<span class=w> </span>-l<span class=w> </span>--no-pager
</span><span id=__span-32-12><a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a>sudo<span class=w> </span>-iu<span class=w> </span>root<span class=w> </span>ls<span class=w> </span>-l<span class=w> </span>~postgres/volumes/postgresql-data
</span><span id=__span-32-13><a id=__codelineno-32-13 name=__codelineno-32-13 href=#__codelineno-32-13></a><span class=nb>export</span><span class=w> </span><span class=nv>PGPASSWORD</span><span class=o>=</span>password
</span><span id=__span-32-14><a id=__codelineno-32-14 name=__codelineno-32-14 href=#__codelineno-32-14></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;\l&#39;</span>
</span><span id=__span-32-15><a id=__codelineno-32-15 name=__codelineno-32-15 href=#__codelineno-32-15></a>
</span><span id=__span-32-16><a id=__codelineno-32-16 name=__codelineno-32-16 href=#__codelineno-32-16></a><span class=k>for</span><span class=w> </span>restart<span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>$(</span>seq<span class=w> </span><span class=m>1</span><span class=w> </span><span class=m>10</span><span class=k>)</span><span class=p>;</span><span class=w> </span><span class=k>do</span>
</span><span id=__span-32-17><a id=__codelineno-32-17 name=__codelineno-32-17 href=#__codelineno-32-17></a><span class=w>  </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;snapshot with </span><span class=nv>$restart</span><span class=s2>&quot;</span>
</span><span id=__span-32-18><a id=__codelineno-32-18 name=__codelineno-32-18 href=#__codelineno-32-18></a><span class=w>  </span>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>restart<span class=w> </span>postgresql.service
</span><span id=__span-32-19><a id=__codelineno-32-19 name=__codelineno-32-19 href=#__codelineno-32-19></a><span class=w>  </span>sleep<span class=w> </span><span class=m>5</span>
</span><span id=__span-32-20><a id=__codelineno-32-20 name=__codelineno-32-20 href=#__codelineno-32-20></a><span class=w>  </span>sudo<span class=w> </span>-iu<span class=w> </span>root<span class=w> </span>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/var/lib/containers/unprivileged/postgres/volumes/postgresql-data
</span><span id=__span-32-21><a id=__codelineno-32-21 name=__codelineno-32-21 href=#__codelineno-32-21></a><span class=w>  </span>sudo<span class=w> </span>-iu<span class=w> </span>root<span class=w> </span>zfs<span class=w> </span>list<span class=w> </span>-t<span class=w> </span>snapshot<span class=w> </span>testing/var/lib/containers/unprivileged/postgres/volumes/postgresql-config
</span><span id=__span-32-22><a id=__codelineno-32-22 name=__codelineno-32-22 href=#__codelineno-32-22></a><span class=k>done</span>
</span></code></pre></div><p>Yup we just felt the awesome modularization potential of quadlets and how <code>bro-volume</code> makes it EZ PZ to create and manage volume quadlets for unprivileged users. The <code>bro-volume</code> command abstracts away the complexity of manually creating volume quadlets, setting up ZFS datasets, and configuring snapshot management. It streamlines the process into a few simple commands, allowing you to focus on using your containers rather than managing their storage intricacies.</p><h2 id=7-rollback-optional>7. Rollback (Optional)<a class=headerlink href=#7-rollback-optional title="Permanent link">&para;</a></h2><p>When you're done testing, you can revert the VM to the snapshot created before starting this lab in step #0. This operation occurs on the host outside of the VM (not to be confused with ZFS snapshots):</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>vagrant<span class=w> </span>snapshot<span class=w> </span>restore<span class=w> </span>before-volumes
</span></code></pre></div><h2 id=lessons-learned>Lessons Learned<a class=headerlink href=#lessons-learned title="Permanent link">&para;</a></h2><p>We saw how adding a <code>Volume=</code> directive into container quadlets perform a bind mount of an external host directory into the container as a <code>source:destination</code> mapping. Containers like the nginx image implement a common pattern where they "import" configurations managed externally in host directories using bind mounts. BTW this was a consequence of how containers were originally used in development. The hosted site content to be served also was shared using such a bind mount.</p><p>We then moved on to create an actual volume quadlet to manage a persistent ZFS-backed volume for a PostgreSQL container. We saw how ZFS snapshots can be created before starting the container to allow rollbacks in case of corruption. However, we also encountered the limitations of OpenZFS's delegation model that complicate snapshot management for unprivileged users. To solve this, we introduced the <code>zfs-helper</code> service that runs with elevated privileges and performs snapshot management tasks on behalf of unprivileged user-scoped container services based on a defined access policy with authentication.</p><p>With <code>zfs-helper</code> in place, we updated the volume quadlet to use it for secure yet convenient snapshot creation and deletion. It removed a lot of the pain we experienced while manually managing snapshots. We also implemented automatic snapshot cleanup (retention policy) in the simplest way to maintain a manageable number of snapshots. Finally, we connected the volume quadlet to the PostgreSQL container quadlet and tested data persistence and snapshot rollbacks, demonstrating the effectiveness and power of ZFS snapshots and rollbacks for data protection and instant recovery.</p><p>Hopefully by now you've started to understand why a separate volume quadlet is a good thing. It allows you to manage the lifecycle of persistent storage independently from the container, share volumes between multiple containers, and leverage advanced features like ZFS snapshots for data protection and recovery. It is also a good security practice. Although we could also do this inside the container quadlet directly, separating concerns into dedicated quadlets leads to cleaner, more secure, and more maintainable configurations.</p></article></div><script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script><script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script></div><button type=button class="md-top md-icon" data-md-component=top hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button></main><footer class=md-footer><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "content.code.copy", "content.code.select", "content.tabs.link", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script><script src=../../assets/javascripts/bundle.e71a0d61.min.js></script></body></html>