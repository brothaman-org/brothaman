
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../5.%20debugging/">
      
      
        <link rel="next" href="../6.%20pgadmin/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Network Configuration - Brothaman</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#networking" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Brothaman" class="md-header__button md-logo" aria-label="Brothaman" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Brothaman
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Network Configuration
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Brothaman" class="md-nav__button md-logo" aria-label="Brothaman" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Brothaman
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../directions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Development Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project-plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Project Plan
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../socket-activation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Socket Activation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quadlet-patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quadlet Patterns
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Components
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Components
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bro-helper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Network Helper
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-scope/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    User Scope
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unprivileged-podman/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unprivileged Podman
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zfs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ZFS
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../users-and-lingering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Users & Lingering
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../compose-conversion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compose Conversion
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dictionary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dictionary
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" checked>
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Labs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Brothaman Labs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_2" >
        
          
          <label class="md-nav__link" for="__nav_11_2" id="__nav_11_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Foundation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_2">
            <span class="md-nav__icon md-icon"></span>
            Foundation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../0.%20setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup Environment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.%20lingering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    User Lingering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.%20quadlet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quadlet Basics
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_3" >
        
          
          <label class="md-nav__link" for="__nav_11_3" id="__nav_11_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Storage & Data
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_3">
            <span class="md-nav__icon md-icon"></span>
            Storage & Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3.%20volumes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Volumes & ZFS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5.%20debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debugging
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_4" checked>
        
          
          <label class="md-nav__link" for="__nav_11_4" id="__nav_11_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Networking & Services
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_11_4">
            <span class="md-nav__icon md-icon"></span>
            Networking & Services
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Network Configuration
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Network Configuration
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-snapshot" class="md-nav__link">
    <span class="md-ellipsis">
      0. Snapshot
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-retrofit-postgresql-with-socket-activation" class="md-nav__link">
    <span class="md-ellipsis">
      1. Retrofit PostgreSQL with Socket Activation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Retrofit PostgreSQL with Socket Activation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-motivation" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 Motivation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-background" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 Background
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#socket-descriptor-passing-support" class="md-nav__link">
    <span class="md-ellipsis">
      Socket Descriptor Passing Support
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcpudp-sockets-vs-unix-domain-sockets" class="md-nav__link">
    <span class="md-ellipsis">
      TCP/UDP Sockets vs. Unix Domain Sockets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hint-proxying-from-any-interface-to-any-other-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Hint: Proxying from any interface to any other interface
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-create-the-postgresql-activator-service-unit" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 Create the PostgreSQL Activator Service Unit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-create-the-socket-unit" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 Create the Socket Unit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-update-the-test-postgresql-quadlet" class="md-nav__link">
    <span class="md-ellipsis">
      1.5 Update the test-postgresql quadlet
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-validate-socket-activation" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 Validate Socket Activation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-define-a-network-quadlet" class="md-nav__link">
    <span class="md-ellipsis">
      2.0 Define a network quadlet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#30-connect-containers-to-the-network" class="md-nav__link">
    <span class="md-ellipsis">
      3.0 Connect containers to the network
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#40-create-a-pgadmin-quadlet-with-cross-over-dependency" class="md-nav__link">
    <span class="md-ellipsis">
      4.0 Create a pgAdmin quadlet with cross-over dependency
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#50-use-bro-socket-proxyd-to-connect-containers-to-the-network" class="md-nav__link">
    <span class="md-ellipsis">
      5.0 Use bro-socket-proxyd to connect containers to the network
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#60-rollback" class="md-nav__link">
    <span class="md-ellipsis">
      6.0 Rollback
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lessons-learned" class="md-nav__link">
    <span class="md-ellipsis">
      Lessons Learned
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6.%20pgadmin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database Admin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../7.%20pod/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pod Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proxyd-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Proxy Testing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Diagrams
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            Diagrams
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../diagrams/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    System Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../diagrams/per-service-pattern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Service Pattern
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-snapshot" class="md-nav__link">
    <span class="md-ellipsis">
      0. Snapshot
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-retrofit-postgresql-with-socket-activation" class="md-nav__link">
    <span class="md-ellipsis">
      1. Retrofit PostgreSQL with Socket Activation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Retrofit PostgreSQL with Socket Activation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-motivation" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 Motivation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-background" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 Background
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#socket-descriptor-passing-support" class="md-nav__link">
    <span class="md-ellipsis">
      Socket Descriptor Passing Support
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcpudp-sockets-vs-unix-domain-sockets" class="md-nav__link">
    <span class="md-ellipsis">
      TCP/UDP Sockets vs. Unix Domain Sockets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hint-proxying-from-any-interface-to-any-other-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Hint: Proxying from any interface to any other interface
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-create-the-postgresql-activator-service-unit" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 Create the PostgreSQL Activator Service Unit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-create-the-socket-unit" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 Create the Socket Unit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-update-the-test-postgresql-quadlet" class="md-nav__link">
    <span class="md-ellipsis">
      1.5 Update the test-postgresql quadlet
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-validate-socket-activation" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 Validate Socket Activation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-define-a-network-quadlet" class="md-nav__link">
    <span class="md-ellipsis">
      2.0 Define a network quadlet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#30-connect-containers-to-the-network" class="md-nav__link">
    <span class="md-ellipsis">
      3.0 Connect containers to the network
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#40-create-a-pgadmin-quadlet-with-cross-over-dependency" class="md-nav__link">
    <span class="md-ellipsis">
      4.0 Create a pgAdmin quadlet with cross-over dependency
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#50-use-bro-socket-proxyd-to-connect-containers-to-the-network" class="md-nav__link">
    <span class="md-ellipsis">
      5.0 Use bro-socket-proxyd to connect containers to the network
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#60-rollback" class="md-nav__link">
    <span class="md-ellipsis">
      6.0 Rollback
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lessons-learned" class="md-nav__link">
    <span class="md-ellipsis">
      Lessons Learned
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="networking">Networking</h1>
<p>Although a large part of this lab focuses on systemd socket activation, we will also cover custom Podman networks and inter-container connectivity. The lab builds upon the foundational knowledge from previous labs, particularly the PostgreSQL setup from the Volumes Lab.</p>
<p>In this lab you will:</p>
<ol>
<li>Retrofit the test-postgresql quadlet with systemd socket activation</li>
<li>Create an unprivileged pgadmin service and demonstrate cross-over dependency triggering</li>
<li>Create network quadlets to connect multiple containers and compare connectivity mechanisms</li>
</ol>
<h2 id="0-snapshot">0. Snapshot</h2>
<p>Before starting this lab, create a VM snapshot to allow easy rollback in case of issues.</p>
<pre><code class="language-bash">vagrant snapshot save networking-start
</code></pre>
<h2 id="1-retrofit-postgresql-with-socket-activation">1. Retrofit PostgreSQL with Socket Activation</h2>
<p>The previous Volumes Lab had you create a <code>test-postgresql</code> quadlet that started a PostgreSQL container with a published port using the <code>PublishPort=5432:5432</code> directive. The directive uses Podman's built-in port forwarding to expose the container's PostgreSQL service on the host's port 5432. It works great, however another approach provides for systemd socket activation enabling cross-over dependency triggering and better performance.</p>
<p>In this lab section, you will modify that quadlet to use systemd socket activation with <code>systemd-socket-proxyd</code> instead of Podman's proxy infrastructure with its <code>PublishPort</code> directive. This change improves resource efficiency and triggers PostgreSQL container startup only with incoming connections. This involves creating a <code>.socket</code> unit that listens on the desired port and a corresponding <code>.service</code> unit that starts the container when a connection is made.</p>
<h3 id="11-motivation">1.1 Motivation</h3>
<p>Now that's tightly packed so let's break it down. In systemd, user-scoped services running under unprivileged user accounts cannot use dependency directives like <code>After=</code> or <code>Requires=</code> to depend on user-scoped services running under other unprivileged user accounts. By "cross-over" we mean across systemd scope boundaries, essentially across different unprivileged user accounts. The impact of these limitations is that other containers depending on the <code>test-postgresql</code> quadlet cannot express a dependency on it when running under a different unprivileged user account.</p>
<blockquote>
<p><strong>NOTE</strong>: User-scoped services can however depend on system-wide "like" (user scoped pseudo) targets like <code>networking-online.target</code> or <code>default.target</code> in <code>WantedBy=</code> directives. </p>
</blockquote>
<p>User scope cross-over dependencies between unprivileged users are not supported, but we can work around this limitation using systemd socket activation while also benefiting from on-demand activation. This is a powerful primitive that allows services to start on-demand when a connection is made to a listening socket. By using socket activation, other containers can depend on an active socket instead of a service unit, allowing for cross-over dependencies to actually work.</p>
<h3 id="12-background">1.2 Background</h3>
<p>Systemd socket activation allows services to start on-demand, reducing resource usage when the service is idle. A socket unit listens for incoming connections and activates the service unit when a connection is received, the <code>accept()</code> call. The mechanism is particularly useful for containers, as it allows them to remain stopped until  they're needed.</p>
<p>It works by having the socket unit listen on a specified port (e.g., 5432 for PostgreSQL). When a client connects, systemd starts the associated service unit, which in turn starts the container then passes the file descriptors of the socket through the service to the container so it can handle the incoming connection. The socket hand off mechanism is efficient with near native performance. However the socket handoff requires support for systemd's socket passing mechanism. Although many services support socket activation natively, many do not. For those that do not, like PostgreSQL, we can use <code>systemd-socket-proxyd</code> as a proxy to forward connections from the host to the container's internal network namespace.</p>
<p>Handing off the listening socket to the container is achieved using <code>systemd-socket-proxyd</code>, as intermediary, which forwards connections from the host to the container's internal network namespace. The extra proxying effort adds minimal latency while enabling socket activation for services that do not natively support it.</p>
<h4 id="socket-descriptor-passing-support">Socket Descriptor Passing Support</h4>
<p>Podman added socket file descriptor passing support, see <a href="https://podman.io/blogs/2022/09/30/podman-4.0.html#socket-activation">here</a>, allowing containers to receive incoming connections directly through the host's socket  file descriptors. There's a long chain of forking involved to get the socket file descriptors to the container's service which must support systemd's socket descriptor passing. This support just added it to Podman and OCI containers which separately added support too. It does not include the network service wrapped in the container. There are two problems with this approach:</p>
<ol>
<li>Many services do not natively support systemd socket descriptor passing, including PostgreSQL.</li>
<li>Container image customizations are required to handle the socket passing mechanism: just see what it takes to make an echo service in an <code>echo.container</code> work with socket passing in the <a href="https://podman.io/blogs/2022/09/30/podman-4.0.html#socket-activation">Podman documentation</a>.</li>
</ol>
<p>This feels way too involved for most use cases. Instead, Brothaman uses <code>systemd-socket-proxyd</code> as a workaround for all network services, especially ones that do not natively support socket descriptor passing. The proxy runs inside the container's network namespace and forwards connections from the host's socket to the container's internal service port.</p>
<p>Once set up, the socket activation mechanism works as follows:</p>
<ol>
<li>The socket unit listens on the host's port (e.g., 5432 for PostgreSQL).</li>
<li>When a client connects, systemd activates the service unit passing it the file descriptors</li>
<li>The service unit starts the container if it's not already running.</li>
<li>The service unit starts <code>systemd-socket-proxyd</code> inside the container's
    network namespace using <code>bro-helper</code>, forwarding connections to the container's internal service port (e.g., 5432 for PostgreSQL).</li>
<li>The container's service handles the incoming connection.</li>
</ol>
<p>Socket passing concerns are all handled by the <code>systemd-socket-proxyd</code> proxy, allowing the container's service to operate normally without any special socket descriptor handling considerations. There is a minimal performance cost for the proxy as with the PublishPort feature of Podman, but we're more than willing to bear it for the on-demand activation, simplicity and container image compatibility it provides.</p>
<p>Brothaman's <code>bro-socket-proxyd</code> command creates activator socket and service pairs as addon infrastructure to enable any container quadlet to use socket activation with minimal effort. Furthermore it is compatible with cross-over dependencies between unprivileged user accounts regardless of the container and whether or not its service supports socket descriptor passing or not.</p>
<blockquote>
<p><strong>CONTRIBUTE</strong>: Anyone interested in adding a <code>bro-socket-direct</code> command to use Podman's native socket descriptor passing support directly without the proxy is welcome to contribute it!</p>
</blockquote>
<h4 id="tcpudp-sockets-vs-unix-domain-sockets">TCP/UDP Sockets vs. Unix Domain Sockets</h4>
<p>Systemd socket activation can use TCP or UDP sockets as well as Unix Domain Sockets (UDS). Both activation mechanisms listen for connections: one works on remotely accessible network ports, whereas Unix Domain Sockets (UDS) are file-based sockets used for inter-process communication on the same host. UDS can also be used for cross-over dependencies between different user accounts, but they're limited to the same host, while also requiring direct UDS file access with the right permissions.</p>
<p>TCP/UDP sockets, on the other hand, used in systemd socket activation listen on network ports which can be accessed both locally and remotely to activate services on-demand. No file access permissions are need for it to work. This is particularly useful for other remote services to depend on TCP activated services over the network. Unlike UDS, TCP/UDP sockets do not require direct file access permissions. Remote access makes them more flexible for cross-over dependencies yet keep in mind this occurs at the price of greater risk since services are now exposed over the network. Proper firewalling and security measures should be in place to protect these services from unauthorized access.</p>
<h4 id="hint-proxying-from-any-interface-to-any-other-interface">Hint: Proxying from any interface to any other interface</h4>
<p><code>systemd-socket-proxyd</code> can proxy from any host specific interface (not just <code>0.0.0.0</code>) to any container interface, not just its loopback, <code>127.0.0.1</code>. So, it could proxy from a container ONLY dedicated inter-container network to the container. It connects containers to networks while also activating containers on-demand. The same mechanism enables connecting containers to inter-container network quadlets, not just the host's external interfaces.</p>
<h3 id="13-create-the-postgresql-activator-service-unit">1.3 Create the PostgreSQL Activator Service Unit</h3>
<p>Before creating the socket unit, we need to create the corresponding service unit that will be activated when a connection is made to the socket.</p>
<p>When this service unit is activated it activates the <code>test-postgresql.service</code> quadlet if it is not already running. Once the container is running, the service unit retrieves the container's PID using <code>podman inspect</code> and then starts <code>systemd-socket-proxyd</code> inside the container's network namespace using <code>bro-helper</code>.</p>
<p>In a <code>lingeruser</code> shell, a new file named <code>postgresql-activator.service</code> is created in the systemd user directory with the following content:</p>
<pre><code class="language-bash">systemctl --user disable postgresql-activator.service
mkdir -p ~/.config/systemd/user/
cat &lt;&lt;EOF &gt; ~/.config/systemd/user/postgresql-activator.service
[Unit]
Description=PostgreSQL Activator Service
Requires=postgresql-activator.socket test-postgresql.service
After=postgresql-activator.socket test-postgresql.service

[Service]
Type=simple

# Create the environment file for the proxy helper with the target container PID
ExecStartPre=/usr/bin/env sh -c &quot;/usr/bin/podman inspect -f 'TARGET_PID={{.State.Pid}}' test-postgresql &gt; %t/postgresql-proxyd.env&quot;

# Environment variable file for the proxy helper does not have to exist with the dash
EnvironmentFile=-%t/postgresql-proxyd.env

# Wait until Postgres is accepting connections inside its netns
ExecStartPre=/usr/bin/env sh -c &quot;i=0; while [ \$i -lt 20 ]; do \
  /usr/bin/podman unshare nsenter -t \&quot;\$TARGET_PID\&quot; -n \
    pg_isready -h 127.0.0.1 -p 5432 &amp;&amp; exit 0; \
  i=\$((i+1)); sleep 1; \
done; exit 1&quot;


# Key is the use of exec to replace the shell with podman process
# Use podman unshare to enter user namespace, then bro-helper for network namespace
ExecStart=/usr/bin/env sh -c 'exec podman unshare /usr/local/bin/bro-helper --pid &quot;${TARGET_PID}&quot; -- /lib/systemd/systemd-socket-proxyd 127.0.0.1:5432'

NoNewPrivileges=no
PrivateTmp=yes
ProtectHome=yes
ProtectSystem=full

Restart=on-failure
RestartSec=5s
TimeoutStopSec=120

[Install]
WantedBy=default.target
EOF

systemctl --user daemon-reload
systemctl --user restart postgresql-activator.socket
systemctl --user enable postgresql-activator.service
</code></pre>
<p>Let's break down each of the significant directives in this service unit:</p>
<ul>
<li><code>Requires=</code> and <code>After=</code>: Ensures that the socket unit and the PostgreSQL container service are started before this service can be activated.</li>
<li><code>ExecStartPre=</code>: Several pre-start commands are used to gather the target container's PID and verify that PostgreSQL is ready to accept connections which makes the system much more robust.</li>
<li><code>ExecStart=</code>: The main command starts <code>systemd-socket-proxyd</code> inside the container's network namespace using <code>bro-helper</code>.</li>
<li><code>NoNewPrivileges</code>, <code>PrivateTmp</code>, <code>ProtectHome</code>, and <code>ProtectSystem</code>: Security directives to limit the service's privileges and access.</li>
<li><code>Restart=</code> and <code>RestartSec=</code>: Configures the service to restart on failure.</li>
</ul>
<p>So what happens when a connection is made to the socket: i.e. with the psql client?</p>
<pre><code class="language-bash">psql -h localhost -U postgres
</code></pre>
<p>In the beginning before anything occurs, the only enabled and started unit is the socket unit (postgresql-activator.socket).</p>
<p>When a connection is made to port 5432, i.e. with psql, the socket unit activates its (same name) service unit: <code>postgresql-activator.service</code>. Activating <code>postgresql-activator.service</code> in turn activates <code>test-postgresql.service</code>. Once the container is up, as detected by looping checks in an <code>ExecStartPre=</code> directive's shell command, the container's PID is retrieved using <code>podman inspect</code>. Finally, <code>systemd-socket-proxyd</code> is started inside the PostgreSQL container's network namespace using <code>bro-helper</code>. This setup allows incoming connections on port 5432 to be proxied directly (in one hop) to the PostgreSQL service running inside the container.</p>
<p>It's essentially a substitute for Podman's built-in port forwarding mechanism, but with the added benefits of on-demand socket activation which allows us to implement cross-over dependency triggering.</p>
<h3 id="14-create-the-socket-unit">1.4 Create the Socket Unit</h3>
<p>The <code>postgresql-activator.service</code> above is activated by the <code>postgresql-activator.socket</code> unit. This socket unit listens on port 5432 and triggers the service unit when a connection is made. In a <code>lingeruser</code> shell create a new file named <code>postgresql-activator.socket</code> in the systemd user directory with the following content:</p>
<pre><code class="language-bash">systemctl --user stop test-postgresql.service
mkdir -p ~/.config/systemd/user/
cat &lt;&lt;EOF &gt; ~/.config/systemd/user/postgresql-activator.socket
[Unit]
Description=PostgreSQL Activator Socket

[Socket]
ListenStream=5432
NoDelay=true
ReusePort=true
Backlog=128

[Install]
WantedBy=default.target
EOF

systemctl --user daemon-reload
systemctl --user enable --now postgresql-activator.socket
</code></pre>
<p>The socket is now set up to listen on port 5432. When a connection is made, it will trigger the associated service unit with the same name. The socket unit configuration includes directives:</p>
<ul>
<li><code>ListenStream=5432</code>: Listens on TCP port 5432 for PostgreSQL</li>
<li><code>NoDelay=true</code>: Disables Nagle's algorithm for lower latency</li>
<li><code>ReusePort=true</code>: Allows multiple sockets to bind to the same port</li>
<li><code>Backlog=128</code>: Sets the maximum number of pending connections</li>
</ul>
<h3 id="15-update-the-test-postgresql-quadlet">1.5 Update the test-postgresql quadlet</h3>
<p>Now we do not need Podman's built-in port forwarding anymore since systemd socket activation is handling incoming connections. Below we remove the <code>PublishPort=</code> directive from the <code>test-postgresql.container</code> quadlet. Also note we're not starting the service as usual after updating the quadlet and reloading. It will now be started by the activator service and its socket. Update the <code>test-postgresql.container</code> quadlet as follows: </p>
<pre><code class="language-bash">if systemctl --user is-active test-postgresql.service; then
  systemctl --user stop test-postgresql.service
fi
mkdir -p ~/.config/containers/systemd/
cat &gt; ~/.config/containers/systemd/test-postgresql.container &lt;&lt;'EOF'
[Unit]
Description=PostgreSQL Container
PropagatesStopTo=postgres-data-volume.service
BindsTo=postgres-data-volume.service
After=postgres-data-volume.service

[Container]
Image=postgres:16
ContainerName=test-postgresql
Environment=POSTGRES_PASSWORD=password
Volume=/home/lingeruser/postgres:/var/lib/postgresql/data
Network=none

[Service]
Restart=always
TimeoutStartSec=300
StartLimitBurst=5
RestartSec=10s

[Install]
WantedBy=default.target
EOF

systemctl --user daemon-reload
</code></pre>
<h3 id="14-validate-socket-activation">1.4 Validate Socket Activation</h3>
<p>Now that everything is set up, we can validate that the socket activation is working as expected. Remember we stopped the <code>test-postgresql.service</code> above, so it should not be running yet. Check the status of the socket and service units:</p>
<pre><code class="language-bash">systemctl --user is-active test-postgresql.service
systemctl --user is-active postgresql-activator.socket
systemctl --user is-active postgresql-activator.service
</code></pre>
<p>Basically the <code>test-postgresql.service</code> should be <strong>in</strong>active, the <code>postgresql-activator.socket</code> should be active, and the <code>postgresql-activator.service</code> should be <strong>in</strong>active. Now try connecting to PostgreSQL using the <code>psql</code> client:</p>
<pre><code class="language-bash">psql -h localhost -U postgres
# Try running a simple SQL command, e.g.: SELECT version();
</code></pre>
<p>The first connection attempt may take a few seconds as the container starts up and is fully available online. Once connected, you should be able to run SQL commands as usual. After disconnecting, check the status of the units again:</p>
<pre><code class="language-bash">systemctl --user is-active test-postgresql.service
systemctl --user is-active postgresql-activator.socket
systemctl --user is-active postgresql-activator.service
</code></pre>
<p>All three units should now be active, indicating that the PostgreSQL container is running and ready to accept connections.</p>
<h2 id="20-define-a-network-quadlet">2.0 Define a network quadlet</h2>
<pre><code class="language-bash">mkdir -p ~/.config/containers/systemd/
cat &gt; ~/.config/containers/systemd/testnet.network &lt;&lt;'EOF'
[Unit]
Description=TestNet Quadlet
After=network-online.target

[Network]
NetworkName=testnet
Subnet=192.168.100.0/24
Gateway=192.168.100.1
DNS=192.168.100.1

[Install]
WantedBy=default.target
EOF
systemctl --user daemon-reload
systemctl --user start testnet-network.service
systemctl --user status testnet-network.service
postman network list
</code></pre>
<h2 id="30-connect-containers-to-the-network">3.0 Connect containers to the network</h2>
<h2 id="40-create-a-pgadmin-quadlet-with-cross-over-dependency">4.0 Create a pgAdmin quadlet with cross-over dependency</h2>
<h2 id="50-use-bro-socket-proxyd-to-connect-containers-to-the-network">5.0 Use bro-socket-proxyd to connect containers to the network</h2>
<h2 id="60-rollback">6.0 Rollback</h2>
<h2 id="lessons-learned">Lessons Learned</h2>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>