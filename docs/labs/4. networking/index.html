<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../5.%20debugging/ rel=prev><link href=../6.%20pgadmin/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.23"><title>Lab 4: Network Config - Brothaman</title><link rel=stylesheet href=../../assets/stylesheets/main.84d31ad4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head><body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue><input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off><input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off><label class=md-overlay for=__drawer></label><div data-md-component=skip><a href=#networking class=md-skip> Skip to content </a></div><div data-md-component=announce></div><header class="md-header md-header--shadow md-header--lifted" data-md-component=header><nav class="md-header__inner md-grid" aria-label=Header><a href=../.. title=Brothaman class="md-header__button md-logo" aria-label=Brothaman data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg></a><label class="md-header__button md-icon" for=__drawer><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> Brothaman </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> Lab 4: Network Config </span></div></div></div><form class=md-header__option data-md-component=palette><input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0><label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label><input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1><label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label></form><script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script><label class="md-header__button md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required><label class="md-search__icon md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg></label><nav class=md-search__options aria-label=Search><button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav></form><div class=md-search__output><div class=md-search__scrollwrap tabindex=0 data-md-scrollfix><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta> Initializing search </div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div></nav><nav class=md-tabs aria-label=Tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a href=../.. class=md-tabs__link> Home </a></li><li class=md-tabs__item><a href=../../architecture/ class=md-tabs__link> Architecture </a></li><li class=md-tabs__item><a href=../../components/ class=md-tabs__link> Components </a></li><li class=md-tabs__item><a href=../../compose-conversion/ class=md-tabs__link> Tools & Utilities </a></li><li class="md-tabs__item md-tabs__item--active"><a href=../ class=md-tabs__link> Labs & Tutorials </a></li><li class=md-tabs__item><a href=../../specifications/bro-user/ class=md-tabs__link> Reference </a></li></ul></div></nav></header><div class=md-container data-md-component=container><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0><label class=md-nav__title for=__drawer><a href=../.. title=Brothaman class="md-nav__button md-logo" aria-label=Brothaman data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg></a> Brothaman </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1><label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0><span class=md-ellipsis> Home </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false><label class=md-nav__title for=__nav_1><span class="md-nav__icon md-icon"></span> Home </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../.. class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../directions/ class=md-nav__link><span class=md-ellipsis> Getting Started </span></a></li><li class=md-nav__item><a href=../../development/ class=md-nav__link><span class=md-ellipsis> Development </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2><label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0><span class=md-ellipsis> Architecture </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false><label class=md-nav__title for=__nav_2><span class="md-nav__icon md-icon"></span> Architecture </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../architecture/ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../architecture/ class=md-nav__link><span class=md-ellipsis> System Design </span></a></li><li class=md-nav__item><a href=../../socket-activation/ class=md-nav__link><span class=md-ellipsis> Socket Activation </span></a></li><li class=md-nav__item><a href=../../quadlet-patterns/ class=md-nav__link><span class=md-ellipsis> Quadlet Patterns </span></a></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_5><label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0><span class=md-ellipsis> Diagrams </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false><label class=md-nav__title for=__nav_2_5><span class="md-nav__icon md-icon"></span> Diagrams </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../diagrams/architecture/ class=md-nav__link><span class=md-ellipsis> System Architecture </span></a></li><li class=md-nav__item><a href=../../diagrams/per-service-pattern/ class=md-nav__link><span class=md-ellipsis> Service Pattern </span></a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3><label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0><span class=md-ellipsis> Components </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false><label class=md-nav__title for=__nav_3><span class="md-nav__icon md-icon"></span> Components </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../components/ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../bro-helper/ class=md-nav__link><span class=md-ellipsis> Network Helper </span></a></li><li class=md-nav__item><a href=../../user-scope/ class=md-nav__link><span class=md-ellipsis> User Management </span></a></li><li class=md-nav__item><a href=../../unprivileged-podman/ class=md-nav__link><span class=md-ellipsis> Container Runtime </span></a></li><li class=md-nav__item><a href=../../zfs/ class=md-nav__link><span class=md-ellipsis> Storage Backend </span></a></li><li class=md-nav__item><a href=../../users-and-lingering/ class=md-nav__link><span class=md-ellipsis> User Sessions </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4><label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0><span class=md-ellipsis> Tools & Utilities </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false><label class=md-nav__title for=__nav_4><span class="md-nav__icon md-icon"></span> Tools & Utilities </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../compose-conversion/ class=md-nav__link><span class=md-ellipsis> Compose Conversion </span></a></li><li class=md-nav__item><a href=../../dictionary/ class=md-nav__link><span class=md-ellipsis> Dictionary </span></a></li><li class=md-nav__item><a href=../../project-plan/ class=md-nav__link><span class=md-ellipsis> Project Plan </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked><label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex><span class=md-ellipsis> Labs & Tutorials </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true><label class=md-nav__title for=__nav_5><span class="md-nav__icon md-icon"></span> Labs & Tutorials </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class="md-nav__item md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_2><label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex><span class=md-ellipsis> Foundation </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false><label class=md-nav__title for=__nav_5_2><span class="md-nav__icon md-icon"></span> Foundation </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../0.%20setup/ class=md-nav__link><span class=md-ellipsis> Lab 0: Environment Setup </span></a></li><li class=md-nav__item><a href=../1.%20lingering/ class=md-nav__link><span class=md-ellipsis> Lab 1: User Lingering </span></a></li><li class=md-nav__item><a href=../2.%20quadlet/ class=md-nav__link><span class=md-ellipsis> Lab 2: Quadlet Basics </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_3><label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex><span class=md-ellipsis> Storage & Persistence </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false><label class=md-nav__title for=__nav_5_3><span class="md-nav__icon md-icon"></span> Storage & Persistence </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../3.%20volumes/ class=md-nav__link><span class=md-ellipsis> Lab 3: Volumes & ZFS </span></a></li><li class=md-nav__item><a href=../5.%20debugging/ class=md-nav__link><span class=md-ellipsis> Lab 5: Debugging </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_4 checked><label class=md-nav__link for=__nav_5_4 id=__nav_5_4_label tabindex><span class=md-ellipsis> Networking & Services </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_4_label aria-expanded=true><label class=md-nav__title for=__nav_5_4><span class="md-nav__icon md-icon"></span> Networking & Services </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--active"><input class="md-nav__toggle md-toggle" type=checkbox id=__toc><label class="md-nav__link md-nav__link--active" for=__toc><span class=md-ellipsis> Lab 4: Network Config </span><span class="md-nav__icon md-icon"></span></label><a href=./ class="md-nav__link md-nav__link--active"><span class=md-ellipsis> Lab 4: Network Config </span></a><nav class="md-nav md-nav--secondary" aria-label="Page Contents"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> Page Contents </label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a href=#0-snapshot class=md-nav__link><span class=md-ellipsis> 0. Snapshot </span></a></li><li class=md-nav__item><a href=#1-retrofit-postgresql-with-socket-activation class=md-nav__link><span class=md-ellipsis> 1. Retrofit PostgreSQL with Socket Activation </span></a><nav class=md-nav aria-label="1. Retrofit PostgreSQL with Socket Activation"><ul class=md-nav__list><li class=md-nav__item><a href=#11-motivation class=md-nav__link><span class=md-ellipsis> 1.1 Motivation </span></a></li><li class=md-nav__item><a href=#12-background class=md-nav__link><span class=md-ellipsis> 1.2 Background </span></a><nav class=md-nav aria-label="1.2 Background"><ul class=md-nav__list><li class=md-nav__item><a href=#socket-descriptor-passing-support class=md-nav__link><span class=md-ellipsis> Socket Descriptor Passing Support </span></a></li><li class=md-nav__item><a href=#tcpudp-sockets-vs-unix-domain-sockets class=md-nav__link><span class=md-ellipsis> TCP/UDP Sockets vs. Unix Domain Sockets </span></a></li><li class=md-nav__item><a href=#hint-proxying-from-any-interface-to-any-other-interface class=md-nav__link><span class=md-ellipsis> Hint: Proxying from any interface to any other interface </span></a></li></ul></nav></li><li class=md-nav__item><a href=#13-create-the-postgresql-activator-service-unit class=md-nav__link><span class=md-ellipsis> 1.3 Create the PostgreSQL Activator Service Unit </span></a></li><li class=md-nav__item><a href=#14-create-the-socket-unit class=md-nav__link><span class=md-ellipsis> 1.4 Create the Socket Unit </span></a></li><li class=md-nav__item><a href=#15-update-the-test-postgresql-quadlet class=md-nav__link><span class=md-ellipsis> 1.5 Update the test-postgresql quadlet </span></a></li><li class=md-nav__item><a href=#14-validate-socket-activation class=md-nav__link><span class=md-ellipsis> 1.4 Validate Socket Activation </span></a></li></ul></nav></li><li class=md-nav__item><a href=#20-define-a-network-quadlet class=md-nav__link><span class=md-ellipsis> 2.0 Define a network quadlet </span></a></li><li class=md-nav__item><a href=#30-connect-containers-to-the-network class=md-nav__link><span class=md-ellipsis> 3.0 Connect containers to the network </span></a></li><li class=md-nav__item><a href=#40-create-a-pgadmin-quadlet-with-cross-over-dependency class=md-nav__link><span class=md-ellipsis> 4.0 Create a pgAdmin quadlet with cross-over dependency </span></a></li><li class=md-nav__item><a href=#50-use-bro-socket-proxyd-to-connect-containers-to-the-network class=md-nav__link><span class=md-ellipsis> 5.0 Use bro-socket-proxyd to connect containers to the network </span></a></li><li class=md-nav__item><a href=#60-rollback class=md-nav__link><span class=md-ellipsis> 6.0 Rollback </span></a></li><li class=md-nav__item><a href=#lessons-learned class=md-nav__link><span class=md-ellipsis> Lessons Learned </span></a></li></ul></nav></li><li class=md-nav__item><a href=../6.%20pgadmin/ class=md-nav__link><span class=md-ellipsis> Lab 6: Database Admin </span></a></li><li class=md-nav__item><a href=../7.%20pod/ class=md-nav__link><span class=md-ellipsis> Lab 7: Pod Management </span></a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6><label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0><span class=md-ellipsis> Reference </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false><label class=md-nav__title for=__nav_6><span class="md-nav__icon md-icon"></span> Reference </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_1><label class=md-nav__link for=__nav_6_1 id=__nav_6_1_label tabindex=0><span class=md-ellipsis> API Specifications </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_1_label aria-expanded=false><label class=md-nav__title for=__nav_6_1><span class="md-nav__icon md-icon"></span> API Specifications </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../specifications/bro-user/ class=md-nav__link><span class=md-ellipsis> bro-user </span></a></li><li class=md-nav__item><a href=../../specifications/bro-volume/ class=md-nav__link><span class=md-ellipsis> bro-volume </span></a></li><li class=md-nav__item><a href=../../specifications/bro-activator/ class=md-nav__link><span class=md-ellipsis> bro-activator </span></a></li></ul></nav></li></ul></nav></li></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><h1 id=networking>Networking<a class=headerlink href=#networking title="Permanent link">&para;</a></h1><p>Although a large part of this lab focuses on systemd socket activation, we will also cover custom Podman networks and inter-container connectivity. The lab builds upon the foundational knowledge from previous labs, particularly the PostgreSQL setup from the Volumes Lab.</p><p>In this lab you will:</p><ol><li>Retrofit the test-postgresql quadlet with systemd socket activation</li><li>Create an unprivileged pgadmin service and demonstrate cross-over dependency triggering</li><li>Create network quadlets to connect multiple containers and compare connectivity mechanisms</li></ol><h2 id=0-snapshot>0. Snapshot<a class=headerlink href=#0-snapshot title="Permanent link">&para;</a></h2><p>Before starting this lab, create a VM snapshot to allow easy rollback in case of issues.</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>vagrant<span class=w> </span>snapshot<span class=w> </span>save<span class=w> </span>networking-start
</span></code></pre></div><h2 id=1-retrofit-postgresql-with-socket-activation>1. Retrofit PostgreSQL with Socket Activation<a class=headerlink href=#1-retrofit-postgresql-with-socket-activation title="Permanent link">&para;</a></h2><p>The previous Volumes Lab had you create a <code>test-postgresql</code> quadlet that started a PostgreSQL container with a published port using the <code>PublishPort=5432:5432</code> directive. The directive uses Podman's built-in port forwarding to expose the container's PostgreSQL service on the host's port 5432. It works great, however another approach provides for systemd socket activation enabling cross-over dependency triggering and better performance.</p><p>In this lab section, you will modify that quadlet to use systemd socket activation with <code>systemd-socket-proxyd</code> instead of Podman's proxy infrastructure with its <code>PublishPort</code> directive. This change improves resource efficiency and triggers PostgreSQL container startup only with incoming connections. This involves creating a <code>.socket</code> unit that listens on the desired port and a corresponding <code>.service</code> unit that starts the container when a connection is made.</p><h3 id=11-motivation>1.1 Motivation<a class=headerlink href=#11-motivation title="Permanent link">&para;</a></h3><p>Now that's tightly packed so let's break it down. In systemd, user-scoped services running under unprivileged user accounts cannot use dependency directives like <code>After=</code> or <code>Requires=</code> to depend on user-scoped services running under other unprivileged user accounts. By "cross-over" we mean across systemd scope boundaries, essentially across different unprivileged user accounts. The impact of these limitations is that other containers depending on the <code>test-postgresql</code> quadlet cannot express a dependency on it when running under a different unprivileged user account.</p><blockquote><p><strong>NOTE</strong>: User-scoped services can however depend on system-wide "like" (user scoped pseudo) targets like <code>networking-online.target</code> or <code>default.target</code> in <code>WantedBy=</code> directives. </p></blockquote><p>User scope cross-over dependencies between unprivileged users are not supported, but we can work around this limitation using systemd socket activation while also benefiting from on-demand activation. This is a powerful primitive that allows services to start on-demand when a connection is made to a listening socket. By using socket activation, other containers can depend on an active socket instead of a service unit, allowing for cross-over dependencies to actually work.</p><h3 id=12-background>1.2 Background<a class=headerlink href=#12-background title="Permanent link">&para;</a></h3><p>Systemd socket activation allows services to start on-demand, reducing resource usage when the service is idle. A socket unit listens for incoming connections and activates the service unit when a connection is received, the <code>accept()</code> call. The mechanism is particularly useful for containers, as it allows them to remain stopped until they're needed.</p><p>It works by having the socket unit listen on a specified port (e.g., 5432 for PostgreSQL). When a client connects, systemd starts the associated service unit, which in turn starts the container then passes the file descriptors of the socket through the service to the container so it can handle the incoming connection. The socket hand off mechanism is efficient with near native performance. However the socket handoff requires support for systemd's socket passing mechanism. Although many services support socket activation natively, many do not. For those that do not, like PostgreSQL, we can use <code>systemd-socket-proxyd</code> as a proxy to forward connections from the host to the container's internal network namespace.</p><p>Handing off the listening socket to the container is achieved using <code>systemd-socket-proxyd</code>, as intermediary, which forwards connections from the host to the container's internal network namespace. The extra proxying effort adds minimal latency while enabling socket activation for services that do not natively support it.</p><h4 id=socket-descriptor-passing-support>Socket Descriptor Passing Support<a class=headerlink href=#socket-descriptor-passing-support title="Permanent link">&para;</a></h4><p>Podman added socket file descriptor passing support, see <a href=https://podman.io/blogs/2022/09/30/podman-4.0.html#socket-activation>here</a>, allowing containers to receive incoming connections directly through the host's socket file descriptors. There's a long chain of forking involved to get the socket file descriptors to the container's service which must support systemd's socket descriptor passing. This support just added it to Podman and OCI containers which separately added support too. It does not include the network service wrapped in the container. There are two problems with this approach:</p><ol><li>Many services do not natively support systemd socket descriptor passing, including PostgreSQL.</li><li>Container image customizations are required to handle the socket passing mechanism: just see what it takes to make an echo service in an <code>echo.container</code> work with socket passing in the <a href=https://podman.io/blogs/2022/09/30/podman-4.0.html#socket-activation>Podman documentation</a>.</li></ol><p>This feels way too involved for most use cases. Instead, Brothaman uses <code>systemd-socket-proxyd</code> as a workaround for all network services, especially ones that do not natively support socket descriptor passing. The proxy runs inside the container's network namespace and forwards connections from the host's socket to the container's internal service port.</p><p>Once set up, the socket activation mechanism works as follows:</p><ol><li>The socket unit listens on the host's port (e.g., 5432 for PostgreSQL).</li><li>When a client connects, systemd activates the service unit passing it the file descriptors</li><li>The service unit starts the container if it's not already running.</li><li>The service unit starts <code>systemd-socket-proxyd</code> inside the container's network namespace using <code>bro-helper</code>, forwarding connections to the container's internal service port (e.g., 5432 for PostgreSQL).</li><li>The container's service handles the incoming connection.</li></ol><p>Socket passing concerns are all handled by the <code>systemd-socket-proxyd</code> proxy, allowing the container's service to operate normally without any special socket descriptor handling considerations. There is a minimal performance cost for the proxy as with the PublishPort feature of Podman, but we're more than willing to bear it for the on-demand activation, simplicity and container image compatibility it provides.</p><p>Brothaman's <code>bro-socket-proxyd</code> command creates activator socket and service pairs as addon infrastructure to enable any container quadlet to use socket activation with minimal effort. Furthermore it is compatible with cross-over dependencies between unprivileged user accounts regardless of the container and whether or not its service supports socket descriptor passing or not.</p><blockquote><p><strong>CONTRIBUTE</strong>: Anyone interested in adding a <code>bro-socket-direct</code> command to use Podman's native socket descriptor passing support directly without the proxy is welcome to contribute it!</p></blockquote><h4 id=tcpudp-sockets-vs-unix-domain-sockets>TCP/UDP Sockets vs. Unix Domain Sockets<a class=headerlink href=#tcpudp-sockets-vs-unix-domain-sockets title="Permanent link">&para;</a></h4><p>Systemd socket activation can use TCP or UDP sockets as well as Unix Domain Sockets (UDS). Both activation mechanisms listen for connections: one works on remotely accessible network ports, whereas Unix Domain Sockets (UDS) are file-based sockets used for inter-process communication on the same host. UDS can also be used for cross-over dependencies between different user accounts, but they're limited to the same host, while also requiring direct UDS file access with the right permissions.</p><p>TCP/UDP sockets, on the other hand, used in systemd socket activation listen on network ports which can be accessed both locally and remotely to activate services on-demand. No file access permissions are need for it to work. This is particularly useful for other remote services to depend on TCP activated services over the network. Unlike UDS, TCP/UDP sockets do not require direct file access permissions. Remote access makes them more flexible for cross-over dependencies yet keep in mind this occurs at the price of greater risk since services are now exposed over the network. Proper firewalling and security measures should be in place to protect these services from unauthorized access.</p><h4 id=hint-proxying-from-any-interface-to-any-other-interface>Hint: Proxying from any interface to any other interface<a class=headerlink href=#hint-proxying-from-any-interface-to-any-other-interface title="Permanent link">&para;</a></h4><p><code>systemd-socket-proxyd</code> can proxy from any host specific interface (not just <code>0.0.0.0</code>) to any container interface, not just its loopback, <code>127.0.0.1</code>. So, it could proxy from a container ONLY dedicated inter-container network to the container. It connects containers to networks while also activating containers on-demand. The same mechanism enables connecting containers to inter-container network quadlets, not just the host's external interfaces.</p><h3 id=13-create-the-postgresql-activator-service-unit>1.3 Create the PostgreSQL Activator Service Unit<a class=headerlink href=#13-create-the-postgresql-activator-service-unit title="Permanent link">&para;</a></h3><p>Before creating the socket unit, we need to create the corresponding service unit that will be activated when a connection is made to the socket.</p><p>When this service unit is activated it activates the <code>test-postgresql.service</code> quadlet if it is not already running. Once the container is running, the service unit retrieves the container's PID using <code>podman inspect</code> and then starts <code>systemd-socket-proxyd</code> inside the container's network namespace using <code>bro-helper</code>.</p><p>In a <code>lingeruser</code> shell, a new file named <code>postgresql-activator.service</code> is created in the systemd user directory with the following content:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>systemctl<span class=w> </span>--user<span class=w> </span>disable<span class=w> </span>postgresql-activator.service
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/systemd/user/
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF &gt; ~/.config/systemd/user/postgresql-activator.service</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=s>[Unit]</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=s>Description=PostgreSQL Activator Service</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=s>Requires=postgresql-activator.socket test-postgresql.service</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=s>After=postgresql-activator.socket test-postgresql.service</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=s>[Service]</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=s>Type=simple</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=s># Create the environment file for the proxy helper with the target container PID</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=s>ExecStartPre=/usr/bin/env sh -c &quot;/usr/bin/podman inspect -f &#39;TARGET_PID={{.State.Pid}}&#39; test-postgresql &gt; %t/postgresql-proxyd.env&quot;</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=s># Environment variable file for the proxy helper does not have to exist with the dash</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=s>EnvironmentFile=-%t/postgresql-proxyd.env</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a><span class=s># Wait until Postgres is accepting connections inside its netns</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=s>ExecStartPre=/usr/bin/env sh -c &quot;i=0; while [ \$i -lt 20 ]; do \</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a><span class=s>  /usr/bin/podman unshare nsenter -t \&quot;\$TARGET_PID\&quot; -n \</span>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a><span class=s>    pg_isready -h 127.0.0.1 -p 5432 &amp;&amp; exit 0; \</span>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a><span class=s>  i=\$((i+1)); sleep 1; \</span>
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a><span class=s>done; exit 1&quot;</span>
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a>
</span><span id=__span-1-25><a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a>
</span><span id=__span-1-26><a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a><span class=s># Key is the use of exec to replace the shell with podman process</span>
</span><span id=__span-1-27><a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a><span class=s># Use podman unshare to enter user namespace, then bro-helper for network namespace</span>
</span><span id=__span-1-28><a id=__codelineno-1-28 name=__codelineno-1-28 href=#__codelineno-1-28></a><span class=s>ExecStart=/usr/bin/env sh -c &#39;exec podman unshare /usr/local/bin/bro-helper --pid &quot;${TARGET_PID}&quot; -- /lib/systemd/systemd-socket-proxyd 127.0.0.1:5432&#39;</span>
</span><span id=__span-1-29><a id=__codelineno-1-29 name=__codelineno-1-29 href=#__codelineno-1-29></a>
</span><span id=__span-1-30><a id=__codelineno-1-30 name=__codelineno-1-30 href=#__codelineno-1-30></a><span class=s>NoNewPrivileges=no</span>
</span><span id=__span-1-31><a id=__codelineno-1-31 name=__codelineno-1-31 href=#__codelineno-1-31></a><span class=s>PrivateTmp=yes</span>
</span><span id=__span-1-32><a id=__codelineno-1-32 name=__codelineno-1-32 href=#__codelineno-1-32></a><span class=s>ProtectHome=yes</span>
</span><span id=__span-1-33><a id=__codelineno-1-33 name=__codelineno-1-33 href=#__codelineno-1-33></a><span class=s>ProtectSystem=full</span>
</span><span id=__span-1-34><a id=__codelineno-1-34 name=__codelineno-1-34 href=#__codelineno-1-34></a>
</span><span id=__span-1-35><a id=__codelineno-1-35 name=__codelineno-1-35 href=#__codelineno-1-35></a><span class=s>Restart=on-failure</span>
</span><span id=__span-1-36><a id=__codelineno-1-36 name=__codelineno-1-36 href=#__codelineno-1-36></a><span class=s>RestartSec=5s</span>
</span><span id=__span-1-37><a id=__codelineno-1-37 name=__codelineno-1-37 href=#__codelineno-1-37></a><span class=s>TimeoutStopSec=120</span>
</span><span id=__span-1-38><a id=__codelineno-1-38 name=__codelineno-1-38 href=#__codelineno-1-38></a>
</span><span id=__span-1-39><a id=__codelineno-1-39 name=__codelineno-1-39 href=#__codelineno-1-39></a><span class=s>[Install]</span>
</span><span id=__span-1-40><a id=__codelineno-1-40 name=__codelineno-1-40 href=#__codelineno-1-40></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-1-41><a id=__codelineno-1-41 name=__codelineno-1-41 href=#__codelineno-1-41></a><span class=s>EOF</span>
</span><span id=__span-1-42><a id=__codelineno-1-42 name=__codelineno-1-42 href=#__codelineno-1-42></a>
</span><span id=__span-1-43><a id=__codelineno-1-43 name=__codelineno-1-43 href=#__codelineno-1-43></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-1-44><a id=__codelineno-1-44 name=__codelineno-1-44 href=#__codelineno-1-44></a>systemctl<span class=w> </span>--user<span class=w> </span>restart<span class=w> </span>postgresql-activator.socket
</span><span id=__span-1-45><a id=__codelineno-1-45 name=__codelineno-1-45 href=#__codelineno-1-45></a>systemctl<span class=w> </span>--user<span class=w> </span><span class=nb>enable</span><span class=w> </span>postgresql-activator.service
</span></code></pre></div><p>Let's break down each of the significant directives in this service unit:</p><ul><li><code>Requires=</code> and <code>After=</code>: Ensures that the socket unit and the PostgreSQL container service are started before this service can be activated.</li><li><code>ExecStartPre=</code>: Several pre-start commands are used to gather the target container's PID and verify that PostgreSQL is ready to accept connections which makes the system much more robust.</li><li><code>ExecStart=</code>: The main command starts <code>systemd-socket-proxyd</code> inside the container's network namespace using <code>bro-helper</code>.</li><li><code>NoNewPrivileges</code>, <code>PrivateTmp</code>, <code>ProtectHome</code>, and <code>ProtectSystem</code>: Security directives to limit the service's privileges and access.</li><li><code>Restart=</code> and <code>RestartSec=</code>: Configures the service to restart on failure.</li></ul><p>So what happens when a connection is made to the socket: i.e. with the psql client?</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>psql<span class=w> </span>-h<span class=w> </span>localhost<span class=w> </span>-U<span class=w> </span>postgres
</span></code></pre></div><p>In the beginning before anything occurs, the only enabled and started unit is the socket unit (postgresql-activator.socket).</p><p>When a connection is made to port 5432, i.e. with psql, the socket unit activates its (same name) service unit: <code>postgresql-activator.service</code>. Activating <code>postgresql-activator.service</code> in turn activates <code>test-postgresql.service</code>. Once the container is up, as detected by looping checks in an <code>ExecStartPre=</code> directive's shell command, the container's PID is retrieved using <code>podman inspect</code>. Finally, <code>systemd-socket-proxyd</code> is started inside the PostgreSQL container's network namespace using <code>bro-helper</code>. This setup allows incoming connections on port 5432 to be proxied directly (in one hop) to the PostgreSQL service running inside the container.</p><p>It's essentially a substitute for Podman's built-in port forwarding mechanism, but with the added benefits of on-demand socket activation which allows us to implement cross-over dependency triggering.</p><h3 id=14-create-the-socket-unit>1.4 Create the Socket Unit<a class=headerlink href=#14-create-the-socket-unit title="Permanent link">&para;</a></h3><p>The <code>postgresql-activator.service</code> above is activated by the <code>postgresql-activator.socket</code> unit. This socket unit listens on port 5432 and triggers the service unit when a connection is made. In a <code>lingeruser</code> shell create a new file named <code>postgresql-activator.socket</code> in the systemd user directory with the following content:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>systemctl<span class=w> </span>--user<span class=w> </span>stop<span class=w> </span>test-postgresql.service
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/systemd/user/
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF &gt; ~/.config/systemd/user/postgresql-activator.socket</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=s>[Unit]</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=s>Description=PostgreSQL Activator Socket</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=s>[Socket]</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=s>ListenStream=5432</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=s>NoDelay=true</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=s>ReusePort=true</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=s>Backlog=128</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=s>[Install]</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=s>EOF</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>systemctl<span class=w> </span>--user<span class=w> </span><span class=nb>enable</span><span class=w> </span>--now<span class=w> </span>postgresql-activator.socket
</span></code></pre></div><p>The socket is now set up to listen on port 5432. When a connection is made, it will trigger the associated service unit with the same name. The socket unit configuration includes directives:</p><ul><li><code>ListenStream=5432</code>: Listens on TCP port 5432 for PostgreSQL</li><li><code>NoDelay=true</code>: Disables Nagle's algorithm for lower latency</li><li><code>ReusePort=true</code>: Allows multiple sockets to bind to the same port</li><li><code>Backlog=128</code>: Sets the maximum number of pending connections</li></ul><h3 id=15-update-the-test-postgresql-quadlet>1.5 Update the test-postgresql quadlet<a class=headerlink href=#15-update-the-test-postgresql-quadlet title="Permanent link">&para;</a></h3><p>Now we do not need Podman's built-in port forwarding anymore since systemd socket activation is handling incoming connections. Below we remove the <code>PublishPort=</code> directive from the <code>test-postgresql.container</code> quadlet. Also note we're not starting the service as usual after updating the quadlet and reloading. It will now be started by the activator service and its socket. Update the <code>test-postgresql.container</code> quadlet as follows: </p><div class="language-bash highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>if</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>is-active<span class=w> </span>test-postgresql.service<span class=p>;</span><span class=w> </span><span class=k>then</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>  </span>systemctl<span class=w> </span>--user<span class=w> </span>stop<span class=w> </span>test-postgresql.service
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=k>fi</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/containers/systemd/
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>cat<span class=w> </span>&gt;<span class=w> </span>~/.config/containers/systemd/test-postgresql.container<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=s>[Unit]</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=s>Description=PostgreSQL Container</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=s>PropagatesStopTo=postgres-data-volume.service</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=s>BindsTo=postgres-data-volume.service</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=s>After=postgres-data-volume.service</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=s>[Container]</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=s>Image=postgres:16</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=s>ContainerName=test-postgresql</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=s>Environment=POSTGRES_PASSWORD=password</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=s>Volume=/home/lingeruser/postgres:/var/lib/postgresql/data</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=s>Network=none</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=s>[Service]</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=s>Restart=always</span>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=s>TimeoutStartSec=300</span>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=s>StartLimitBurst=5</span>
</span><span id=__span-4-23><a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=s>RestartSec=10s</span>
</span><span id=__span-4-24><a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a>
</span><span id=__span-4-25><a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a><span class=s>[Install]</span>
</span><span id=__span-4-26><a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-4-27><a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a><span class=s>EOF</span>
</span><span id=__span-4-28><a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a>
</span><span id=__span-4-29><a id=__codelineno-4-29 name=__codelineno-4-29 href=#__codelineno-4-29></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span></code></pre></div><h3 id=14-validate-socket-activation>1.4 Validate Socket Activation<a class=headerlink href=#14-validate-socket-activation title="Permanent link">&para;</a></h3><p>Now that everything is set up, we can validate that the socket activation is working as expected. Remember we stopped the <code>test-postgresql.service</code> above, so it should not be running yet. Check the status of the socket and service units:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>systemctl<span class=w> </span>--user<span class=w> </span>is-active<span class=w> </span>test-postgresql.service
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>systemctl<span class=w> </span>--user<span class=w> </span>is-active<span class=w> </span>postgresql-activator.socket
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>systemctl<span class=w> </span>--user<span class=w> </span>is-active<span class=w> </span>postgresql-activator.service
</span></code></pre></div><p>Basically the <code>test-postgresql.service</code> should be <strong>in</strong>active, the <code>postgresql-activator.socket</code> should be active, and the <code>postgresql-activator.service</code> should be <strong>in</strong>active. Now try connecting to PostgreSQL using the <code>psql</code> client:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>psql<span class=w> </span>-h<span class=w> </span>localhost<span class=w> </span>-U<span class=w> </span>postgres
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=c1># Try running a simple SQL command, e.g.: SELECT version();</span>
</span></code></pre></div><p>The first connection attempt may take a few seconds as the container starts up and is fully available online. Once connected, you should be able to run SQL commands as usual. After disconnecting, check the status of the units again:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>systemctl<span class=w> </span>--user<span class=w> </span>is-active<span class=w> </span>test-postgresql.service
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>systemctl<span class=w> </span>--user<span class=w> </span>is-active<span class=w> </span>postgresql-activator.socket
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>systemctl<span class=w> </span>--user<span class=w> </span>is-active<span class=w> </span>postgresql-activator.service
</span></code></pre></div><p>All three units should now be active, indicating that the PostgreSQL container is running and ready to accept connections.</p><h2 id=20-define-a-network-quadlet>2.0 Define a network quadlet<a class=headerlink href=#20-define-a-network-quadlet title="Permanent link">&para;</a></h2><div class="language-bash highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/containers/systemd/
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>cat<span class=w> </span>&gt;<span class=w> </span>~/.config/containers/systemd/testnet.network<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=s>[Unit]</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=s>Description=TestNet Quadlet</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=s>After=network-online.target</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=s>[Network]</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=s>NetworkName=testnet</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=s>Subnet=192.168.100.0/24</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=s>Gateway=192.168.100.1</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=s>DNS=192.168.100.1</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=s>[Install]</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=s>EOF</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>testnet-network.service
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a>systemctl<span class=w> </span>--user<span class=w> </span>status<span class=w> </span>testnet-network.service
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>postman<span class=w> </span>network<span class=w> </span>list
</span></code></pre></div><h2 id=30-connect-containers-to-the-network>3.0 Connect containers to the network<a class=headerlink href=#30-connect-containers-to-the-network title="Permanent link">&para;</a></h2><h2 id=40-create-a-pgadmin-quadlet-with-cross-over-dependency>4.0 Create a pgAdmin quadlet with cross-over dependency<a class=headerlink href=#40-create-a-pgadmin-quadlet-with-cross-over-dependency title="Permanent link">&para;</a></h2><h2 id=50-use-bro-socket-proxyd-to-connect-containers-to-the-network>5.0 Use bro-socket-proxyd to connect containers to the network<a class=headerlink href=#50-use-bro-socket-proxyd-to-connect-containers-to-the-network title="Permanent link">&para;</a></h2><h2 id=60-rollback>6.0 Rollback<a class=headerlink href=#60-rollback title="Permanent link">&para;</a></h2><h2 id=lessons-learned>Lessons Learned<a class=headerlink href=#lessons-learned title="Permanent link">&para;</a></h2></article></div><script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script><script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script></div><button type=button class="md-top md-icon" data-md-component=top hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button></main><footer class=md-footer><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><script id=__config type=application/json>{"base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "content.code.copy", "content.code.select", "content.tabs.link", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script><script src=../../assets/javascripts/bundle.f55a23d4.min.js></script></body></html>