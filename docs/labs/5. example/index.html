<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../4.%20networking/ rel=prev><link href=../../specifications/bro-helper/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.0"><title>Lab 5: Real World Example - Brothaman</title><link rel=stylesheet href=../../assets/stylesheets/main.618322db.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head><body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue><input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off><input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off><label class=md-overlay for=__drawer></label><div data-md-component=skip><a href=#real-world-example class=md-skip> Skip to content </a></div><div data-md-component=announce></div><header class="md-header md-header--shadow md-header--lifted" data-md-component=header><nav class="md-header__inner md-grid" aria-label=Header><a href=../.. title=Brothaman class="md-header__button md-logo" aria-label=Brothaman data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg></a><label class="md-header__button md-icon" for=__drawer><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> Brothaman </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> Lab 5: Real World Example </span></div></div></div><form class=md-header__option data-md-component=palette><input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0><label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label><input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1><label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label></form><script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script><label class="md-header__button md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required><label class="md-search__icon md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg></label><nav class=md-search__options aria-label=Search><button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav></form><div class=md-search__output><div class=md-search__scrollwrap tabindex=0 data-md-scrollfix><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta> Initializing search </div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div></nav><nav class=md-tabs aria-label=Tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a href=../.. class=md-tabs__link> Home </a></li><li class=md-tabs__item><a href=../../architecture/ class=md-tabs__link> Architecture </a></li><li class=md-tabs__item><a href=../../components/ class=md-tabs__link> Components </a></li><li class=md-tabs__item><a href=../../compose-conversion/ class=md-tabs__link> Tools & Utilities </a></li><li class="md-tabs__item md-tabs__item--active"><a href=../ class=md-tabs__link> Labs & Tutorials </a></li><li class=md-tabs__item><a href=../../specifications/bro-helper/ class=md-tabs__link> Reference </a></li></ul></div></nav></header><div class=md-container data-md-component=container><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0><label class=md-nav__title for=__drawer><a href=../.. title=Brothaman class="md-nav__button md-logo" aria-label=Brothaman data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg></a> Brothaman </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1><label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0><span class=md-ellipsis> Home </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false><label class=md-nav__title for=__nav_1><span class="md-nav__icon md-icon"></span> Home </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../.. class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../directions/ class=md-nav__link><span class=md-ellipsis> Getting Started </span></a></li><li class=md-nav__item><a href=../../development/ class=md-nav__link><span class=md-ellipsis> Development </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2><label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0><span class=md-ellipsis> Architecture </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false><label class=md-nav__title for=__nav_2><span class="md-nav__icon md-icon"></span> Architecture </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../architecture/ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../architecture/ class=md-nav__link><span class=md-ellipsis> System Design </span></a></li><li class=md-nav__item><a href=../../socket-activation/ class=md-nav__link><span class=md-ellipsis> Socket Activation </span></a></li><li class=md-nav__item><a href=../../quadlet-patterns/ class=md-nav__link><span class=md-ellipsis> Quadlet Patterns </span></a></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_5><label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0><span class=md-ellipsis> Diagrams </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false><label class=md-nav__title for=__nav_2_5><span class="md-nav__icon md-icon"></span> Diagrams </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../diagrams/architecture/ class=md-nav__link><span class=md-ellipsis> System Architecture </span></a></li><li class=md-nav__item><a href=../../diagrams/per-service-pattern/ class=md-nav__link><span class=md-ellipsis> Service Pattern </span></a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3><label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0><span class=md-ellipsis> Components </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false><label class=md-nav__title for=__nav_3><span class="md-nav__icon md-icon"></span> Components </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../components/ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../specifications/bro-helper/ class=md-nav__link><span class=md-ellipsis> Network Helper </span></a></li><li class=md-nav__item><a href=../../user-scope/ class=md-nav__link><span class=md-ellipsis> User Management </span></a></li><li class=md-nav__item><a href=../../unprivileged-podman/ class=md-nav__link><span class=md-ellipsis> Container Runtime </span></a></li><li class=md-nav__item><a href=../../zfs/ class=md-nav__link><span class=md-ellipsis> Storage Backend </span></a></li><li class=md-nav__item><a href=../../users-and-lingering/ class=md-nav__link><span class=md-ellipsis> User Sessions </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4><label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0><span class=md-ellipsis> Tools & Utilities </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false><label class=md-nav__title for=__nav_4><span class="md-nav__icon md-icon"></span> Tools & Utilities </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../compose-conversion/ class=md-nav__link><span class=md-ellipsis> Compose Conversion </span></a></li><li class=md-nav__item><a href=../../dictionary/ class=md-nav__link><span class=md-ellipsis> Dictionary </span></a></li><li class=md-nav__item><a href=../../project-plan/ class=md-nav__link><span class=md-ellipsis> Project Plan </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked><label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex><span class=md-ellipsis> Labs & Tutorials </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true><label class=md-nav__title for=__nav_5><span class="md-nav__icon md-icon"></span> Labs & Tutorials </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class="md-nav__item md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_2><label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex><span class=md-ellipsis> Foundation </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false><label class=md-nav__title for=__nav_5_2><span class="md-nav__icon md-icon"></span> Foundation </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../0.%20setup/ class=md-nav__link><span class=md-ellipsis> Lab 0: Environment Setup </span></a></li><li class=md-nav__item><a href=../1.%20lingering/ class=md-nav__link><span class=md-ellipsis> Lab 1: User Lingering </span></a></li><li class=md-nav__item><a href=../2.%20quadlet/ class=md-nav__link><span class=md-ellipsis> Lab 2: Quadlet Basics </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_3><label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex><span class=md-ellipsis> Storage & Persistence </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false><label class=md-nav__title for=__nav_5_3><span class="md-nav__icon md-icon"></span> Storage & Persistence </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../3.%20volumes/ class=md-nav__link><span class=md-ellipsis> Lab 3: Volumes & ZFS </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_4 checked><label class=md-nav__link for=__nav_5_4 id=__nav_5_4_label tabindex><span class=md-ellipsis> Applied Examples </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_4_label aria-expanded=true><label class=md-nav__title for=__nav_5_4><span class="md-nav__icon md-icon"></span> Applied Examples </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../4.%20networking/ class=md-nav__link><span class=md-ellipsis> Lab 4: Network Config </span></a></li><li class="md-nav__item md-nav__item--active"><input class="md-nav__toggle md-toggle" type=checkbox id=__toc><label class="md-nav__link md-nav__link--active" for=__toc><span class=md-ellipsis> Lab 5: Real World Example </span><span class="md-nav__icon md-icon"></span></label><a href=./ class="md-nav__link md-nav__link--active"><span class=md-ellipsis> Lab 5: Real World Example </span></a><nav class="md-nav md-nav--secondary" aria-label="Page Contents"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> Page Contents </label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a href=#0-snapshot class=md-nav__link><span class=md-ellipsis> 0. Snapshot </span></a></li><li class=md-nav__item><a href=#1-pgadmin class=md-nav__link><span class=md-ellipsis> 1. pgAdmin </span></a><nav class=md-nav aria-label="1. pgAdmin"><ul class=md-nav__list><li class=md-nav__item><a href=#11-get-triggered class=md-nav__link><span class=md-ellipsis> 1.1 Get triggered </span></a></li><li class=md-nav__item><a href=#12-pgadmin-modes class=md-nav__link><span class=md-ellipsis> 1.2 pgAdmin Modes </span></a></li><li class=md-nav__item><a href=#13-setting-up-the-pgadmin-and-gitea-web-applications class=md-nav__link><span class=md-ellipsis> 1.3 Setting up the pgAdmin and Gitea Web Applications </span></a></li><li class=md-nav__item><a href=#14-connecting-with-pgadmin-desktop-and-pgadmin-web-application class=md-nav__link><span class=md-ellipsis> 1.4 Connecting with pgAdmin Desktop and pgAdmin Web Application </span></a></li><li class=md-nav__item><a href=#15-setting-up-gitea class=md-nav__link><span class=md-ellipsis> 1.5 Setting up Gitea </span></a></li></ul></nav></li><li class=md-nav__item><a href=#20-strong-authentication class=md-nav__link><span class=md-ellipsis> 2.0 Strong Authentication </span></a><nav class=md-nav aria-label="2.0 Strong Authentication"><ul class=md-nav__list><li class=md-nav__item><a href=#21-strong-authentication-for-interactive-applications class=md-nav__link><span class=md-ellipsis> 2.1 Strong Authentication for Interactive Applications </span></a></li><li class=md-nav__item><a href=#22-caddy-and-keycloak-to-the-rescue class=md-nav__link><span class=md-ellipsis> 2.2 Caddy and Keycloak to the rescue </span></a><nav class=md-nav aria-label="2.2 Caddy and Keycloak to the rescue"><ul class=md-nav__list><li class=md-nav__item><a href=#overview-of-the-flow class=md-nav__link><span class=md-ellipsis> Overview of the flow </span></a></li><li class=md-nav__item><a href=#unprivileged-users-and-containers class=md-nav__link><span class=md-ellipsis> Unprivileged Users and Containers </span></a></li></ul></nav></li><li class=md-nav__item><a href=#23-protecting-pgadmin-desktop-mode class=md-nav__link><span class=md-ellipsis> 2.3 Protecting pgAdmin Desktop Mode </span></a><nav class=md-nav aria-label="2.3 Protecting pgAdmin Desktop Mode"><ul class=md-nav__list><li class=md-nav__item><a href=#ssh-tunneling-or-tls-client-certificates class=md-nav__link><span class=md-ellipsis> SSH Tunneling or TLS Client Certificates? </span></a></li><li class=md-nav__item><a href=#using-tls-client-certificates class=md-nav__link><span class=md-ellipsis> Using TLS Client Certificates </span></a></li></ul></nav></li></ul></nav></li><li class=md-nav__item><a href=#30-building-out-the-identity-user-account class=md-nav__link><span class=md-ellipsis> 3.0 Building out the identity User Account </span></a><nav class=md-nav aria-label="3.0 Building out the identity User Account"><ul class=md-nav__list><li class=md-nav__item><a href=#31-add-caddy-to-the-idp-private-network class=md-nav__link><span class=md-ellipsis> 3.1 Add Caddy to the idp-private Network </span></a><nav class=md-nav aria-label="3.1 Add Caddy to the idp-private Network"><ul class=md-nav__list><li class=md-nav__item><a href=#verify-idp-private-network-gateway-connectivity class=md-nav__link><span class=md-ellipsis> Verify idp-private Network Gateway Connectivity </span></a></li><li class=md-nav__item><a href=#verify-caddy-access-via-activator-sockets class=md-nav__link><span class=md-ellipsis> Verify Caddy Access via Activator Sockets </span></a></li></ul></nav></li><li class=md-nav__item><a href=#32-configure-ca-trust-and-firewall-rules class=md-nav__link><span class=md-ellipsis> 3.2 Configure CA Trust and Firewall Rules </span></a><nav class=md-nav aria-label="3.2 Configure CA Trust and Firewall Rules"><ul class=md-nav__list><li class=md-nav__item><a href=#configure-firewall-rules class=md-nav__link><span class=md-ellipsis> Configure Firewall Rules </span></a></li><li class=md-nav__item><a href=#extract-and-trust-caddys-internal-ca-certificate class=md-nav__link><span class=md-ellipsis> Extract and Trust Caddy's Internal CA Certificate </span></a></li><li class=md-nav__item><a href=#security-considerations class=md-nav__link><span class=md-ellipsis> Security Considerations </span></a></li><li class=md-nav__item><a href=#certificate-mitigations class=md-nav__link><span class=md-ellipsis> Certificate Mitigations </span></a></li><li class=md-nav__item><a href=#additional-security-considerations class=md-nav__link><span class=md-ellipsis> Additional Security Considerations </span></a></li></ul></nav></li><li class=md-nav__item><a href=#33-add-the-step-ca-quadlet-to-the-idp-private-network class=md-nav__link><span class=md-ellipsis> 3.3 Add the step-ca quadlet to the idp-private Network </span></a></li><li class=md-nav__item><a href=#34-add-the-keycloak-quadlet-to-the-idp-private-network class=md-nav__link><span class=md-ellipsis> 3.4 Add the Keycloak quadlet to the idp-private Network </span></a></li><li class=md-nav__item><a href=#33-verify-container-to-container-communication class=md-nav__link><span class=md-ellipsis> 3.3 Verify Container-to-Container Communication </span></a></li></ul></nav></li></ul></nav></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6><label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0><span class=md-ellipsis> Reference </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false><label class=md-nav__title for=__nav_6><span class="md-nav__icon md-icon"></span> Reference </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_1><label class=md-nav__link for=__nav_6_1 id=__nav_6_1_label tabindex=0><span class=md-ellipsis> API Specifications </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_1_label aria-expanded=false><label class=md-nav__title for=__nav_6_1><span class="md-nav__icon md-icon"></span> API Specifications </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../specifications/bro-helper/ class=md-nav__link><span class=md-ellipsis> Network Helper </span></a></li><li class=md-nav__item><a href=../../specifications/bro-user/ class=md-nav__link><span class=md-ellipsis> bro-user </span></a></li><li class=md-nav__item><a href=../../specifications/bro-volume/ class=md-nav__link><span class=md-ellipsis> bro-volume </span></a></li><li class=md-nav__item><a href=../../specifications/bro-activator/ class=md-nav__link><span class=md-ellipsis> bro-activator </span></a></li></ul></nav></li></ul></nav></li></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><h1 id=real-world-example>Real World Example<a class=headerlink href=#real-world-example title="Permanent link">&para;</a></h1><p>This is a good point to consider a real world (concrete) example to solidify our understanding of the concepts covered so far.</p><p>In this lab we will explore a system of applications that use the same shared database while running a very dangerous application, the pgAdmin application used for PostgreSQL database management. We will demonstrate how to mitigate the inherent risks of pgAdmin in a containerized environment using Podman quadlets and systemd.</p><blockquote><p><strong>NOTICE</strong> You can start this lab with work on the VM without having to perform the other labs first. It is not additive, all the commands will be independent. However, you may find it helpful to have done the previous labs to understand the concepts and commands used here.</p></blockquote><h2 id=0-snapshot>0. Snapshot<a class=headerlink href=#0-snapshot title="Permanent link">&para;</a></h2><p>Before proceeding, create a VM snapshot to allow easy rollback after completing this lab. You can create a snapshot with the following command on your host:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>vagrant<span class=w> </span>snapshot<span class=w> </span>save<span class=w> </span>example-start
</span></code></pre></div><h2 id=1-pgadmin>1. pgAdmin<a class=headerlink href=#1-pgadmin title="Permanent link">&para;</a></h2><p>pgAdmin is a popular tool for managing PostgreSQL servers and databases. It provides a web-based interface for database administration tasks such as creating databases, running queries, managing users, and monitoring performance. It manages connection objects to PostgreSQL servers and databases, storing connection parameters and credentials (sometimes of database super users) within its own internal database. By its very nature it is an extremely dangerous application to host and to expose to users in networked environments.</p><blockquote><p><strong>WARNING</strong>: Enterprise production environments should never use pgAdmin or similar database management applications. They are simply too risky to expose and they promote one-off manual changes to database servers outside of DevOps automation processes making database servers snowflake servers. Such tools are a security nightmare and should be avoided at all costs in almost all environments much less production environments. Non-production developer environments, and perhaps home lab environments for those just learning to us Postgresql, I understand, but still I recommend against it. It's a crutch, just start getting used to using SQL, DDL, and DevOps automation instead: the investment amortizes in the end and you won't instill bad habits in yourself.</p></blockquote><h3 id=11-get-triggered>1.1 Get triggered<a class=headerlink href=#11-get-triggered title="Permanent link">&para;</a></h3><p>Anytime you see an application that:</p><ul><li>exposes a web interfaces for management</li><li>manages connections and credentials</li><li>has access to super user credentials</li><li>has the ability to run arbitrary commands</li><li>is always on and accessible over the network</li></ul><p>You should be immediately triggered to avoid using it at all costs. Such applications are a magnet for attackers and a security nightmare to manage. We're only toying with the idea as a challenging exercise to demonstrate how to mitigate the risks of such an application using Podman quadlets and systemd. Do not take this as an endorsement to use pgAdmin or similar classes of risky applications in your environments.</p><p>When you do get triggered, and you don't have a choice (because higher authorities insists on using such an application), then the protection patterns discussed here will help. In fact, these techniques are still recommended for any third party applications you cannot thoroughly assess the security implications of. They're best practices for securely hosting any third party applications in general.</p><h3 id=12-pgadmin-modes>1.2 pgAdmin Modes<a class=headerlink href=#12-pgadmin-modes title="Permanent link">&para;</a></h3><p>The pgAdmin application has two modes: the web server application mode and the desktop application mode. In web server application mode it runs centrally as a web application on a server that many users can access and log into. In desktop application mode it runs locally on a user's machine as a desktop application connecting directly to databases. Both provide the same common user interface running the same code base.</p><p>At first glance, the desktop application seems more secure because it runs locally and does not expose an "always-on" web interface. In web application mode, the application is accessible over the network, which can introduce additional attack vectors. Theoretically, in desktop mode users open the locally installed application, use it for a while, then shut it down when done. However, the application may be left running unintentionally exposing it for long periods of time. Even when off, pgAdmin is still at risk residing on a less secure desktop.</p><p>The desktop installations may not be as rigorously maintained and updated as web applications, leading to potential vulnerabilities on the host if software patches are not up to date. Generally desktops are more susceptible to malware or unauthorized access especially when misconfigured. The more desktop installations, the more points of attack. A centralized server alleviates these concerns since it can be centrally updated, managed, and monitored. In desktop mode, database access for multiple databases by multiple users will be required from multiple hosts. This is yet another management and security problem in itself. So the original question of which mode is more secure is a lot more complicated than it first appeared.</p><p>As an exercise we will secure both modes of pgAdmin tool operation: as a desktop installed application and as a web application.</p><h3 id=13-setting-up-the-pgadmin-and-gitea-web-applications>1.3 Setting up the pgAdmin and Gitea Web Applications<a class=headerlink href=#13-setting-up-the-pgadmin-and-gitea-web-applications title="Permanent link">&para;</a></h3><ul><li><strong>PostgreSQL</strong>: <a href=https://www.postgresql.org/ >Site</a> <a href=https://hub.docker.com/_/postgres>Docker</a></li><li><strong>pgAdmin</strong>: <a href=https://www.pgadmin.org/ >Site</a> <a href=https://hub.docker.com/r/dpage/pgadmin4>Docker</a></li><li><strong>gitea</strong>: <a href=https://gitea.com/en-us/ >Site</a> <a href=https://docker.gitea.com/gitea:1.25.1-rootless>Docker</a> <a href=https://docs.gitea.com/installation/install-with-docker-rootless>Rootless Guide</a></li></ul><p>Let's first set up the pgAdmin web application and gitea which both will connect to a postgresql database all running in their own containers using a Podman quadlet for each. All containers will run on the same host but isolated from each other in separate unprivileged users accounts.</p><blockquote><p><strong>NOTE</strong>: The gitea application is a great application to demonstrate multiple applications sharing accessing the same database, plus it needs special security considerations for it's API.</p></blockquote><p>Let's begin with the PostgreSQL server which also runs in its own unprivileged user account called <code>postgresql</code>. pgAdmin and gitea web applications will connect to the PostgreSQL server over its systemd socket port on <code>localhost:5432</code>. Log into the virtual machine as the <code>vagrant</code> user and issue the following commands to create the PostgreSQL container quadlet and set up volumes with bro-volume and socket activation using bro-activator:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=nv>PG_USER</span><span class=o>=</span>postgresql
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>sudo<span class=w> </span>bro-user<span class=w> </span>--remove<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>sudo<span class=w> </span>bro-user<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=nv>PG_HOME</span><span class=o>=</span><span class=s2>&quot;</span><span class=k>$(</span>getent<span class=w> </span>passwd<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>cut<span class=w> </span>-f<span class=w> </span><span class=m>6</span><span class=w> </span>-d<span class=w> </span><span class=s1>&#39;:&#39;</span><span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=nv>CONTAINERS_CONFIG</span><span class=o>=</span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_HOME</span><span class=si>}</span><span class=s2>&quot;</span>/.config/containers/systemd/
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>CONTAINERS_CONFIG</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF | sudo -iu &quot;${PG_USER}&quot; tee &quot;${CONTAINERS_CONFIG}&quot;/postgresql.container</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=s>[Unit]</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=s>Description=PostgreSQL Container</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=s>[Container]</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=s>Image=docker.io/library/postgres:16</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=s>ContainerName=postgresql</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=s>Environment=POSTGRES_PASSWORD=password</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=s>Volume=${PG_HOME}/volumes/gitea-setup.sql:/docker-entrypoint-initdb.d/gitea-setup.sql</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=s>Network=none</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=s>[Service]</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a><span class=s>Restart=always</span>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a><span class=s>TimeoutStartSec=120</span>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a><span class=s>StartLimitBurst=5</span>
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a><span class=s>RestartSec=10s</span>
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a>
</span><span id=__span-1-25><a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a><span class=s>[Install]</span>
</span><span id=__span-1-26><a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-1-27><a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a><span class=s>EOF</span>
</span><span id=__span-1-28><a id=__codelineno-1-28 name=__codelineno-1-28 href=#__codelineno-1-28></a>
</span><span id=__span-1-29><a id=__codelineno-1-29 name=__codelineno-1-29 href=#__codelineno-1-29></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--name<span class=w> </span>postgresql-data<span class=w>      </span><span class=se>\</span>
</span><span id=__span-1-30><a id=__codelineno-1-30 name=__codelineno-1-30 href=#__codelineno-1-30></a><span class=w>    </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>                    </span><span class=se>\</span>
</span><span id=__span-1-31><a id=__codelineno-1-31 name=__codelineno-1-31 href=#__codelineno-1-31></a><span class=w>    </span>--container<span class=w> </span>postgresql<span class=w>                  </span><span class=se>\</span>
</span><span id=__span-1-32><a id=__codelineno-1-32 name=__codelineno-1-32 href=#__codelineno-1-32></a><span class=w>    </span>--container-user<span class=w> </span>internal:999<span class=w>           </span><span class=se>\</span>
</span><span id=__span-1-33><a id=__codelineno-1-33 name=__codelineno-1-33 href=#__codelineno-1-33></a><span class=w>    </span>--container-group<span class=w> </span>internal:999<span class=w>          </span><span class=se>\</span>
</span><span id=__span-1-34><a id=__codelineno-1-34 name=__codelineno-1-34 href=#__codelineno-1-34></a><span class=w>    </span>--container-path<span class=w> </span>/var/lib/postgresql/data
</span><span id=__span-1-35><a id=__codelineno-1-35 name=__codelineno-1-35 href=#__codelineno-1-35></a>
</span><span id=__span-1-36><a id=__codelineno-1-36 name=__codelineno-1-36 href=#__codelineno-1-36></a>cat<span class=s>&lt;&lt;&#39;EOSQL&#39; | sudo -iu &quot;${PG_USER}&quot; tee &quot;${PG_HOME}&quot;/volumes/gitea-setup.sql</span>
</span><span id=__span-1-37><a id=__codelineno-1-37 name=__codelineno-1-37 href=#__codelineno-1-37></a><span class=s>-- Create gitea database and user</span>
</span><span id=__span-1-38><a id=__codelineno-1-38 name=__codelineno-1-38 href=#__codelineno-1-38></a><span class=s>CREATE ROLE gitea WITH LOGIN PASSWORD &#39;gitea&#39;;</span>
</span><span id=__span-1-39><a id=__codelineno-1-39 name=__codelineno-1-39 href=#__codelineno-1-39></a><span class=s>CREATE DATABASE</span>
</span><span id=__span-1-40><a id=__codelineno-1-40 name=__codelineno-1-40 href=#__codelineno-1-40></a><span class=s>    giteadb</span>
</span><span id=__span-1-41><a id=__codelineno-1-41 name=__codelineno-1-41 href=#__codelineno-1-41></a><span class=s>WITH OWNER</span>
</span><span id=__span-1-42><a id=__codelineno-1-42 name=__codelineno-1-42 href=#__codelineno-1-42></a><span class=s>    gitea</span>
</span><span id=__span-1-43><a id=__codelineno-1-43 name=__codelineno-1-43 href=#__codelineno-1-43></a><span class=s>TEMPLATE</span>
</span><span id=__span-1-44><a id=__codelineno-1-44 name=__codelineno-1-44 href=#__codelineno-1-44></a><span class=s>    template0</span>
</span><span id=__span-1-45><a id=__codelineno-1-45 name=__codelineno-1-45 href=#__codelineno-1-45></a><span class=s>ENCODING</span>
</span><span id=__span-1-46><a id=__codelineno-1-46 name=__codelineno-1-46 href=#__codelineno-1-46></a><span class=s>    UTF8 LC_COLLATE &#39;en_US.UTF-8&#39; LC_CTYPE &#39;en_US.UTF-8&#39;;</span>
</span><span id=__span-1-47><a id=__codelineno-1-47 name=__codelineno-1-47 href=#__codelineno-1-47></a><span class=s>EOSQL</span>
</span><span id=__span-1-48><a id=__codelineno-1-48 name=__codelineno-1-48 href=#__codelineno-1-48></a>sudo<span class=w> </span>chmod<span class=w> </span><span class=m>644</span><span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_HOME</span><span class=si>}</span><span class=s2>&quot;</span>/volumes/gitea-setup.sql
</span><span id=__span-1-49><a id=__codelineno-1-49 name=__codelineno-1-49 href=#__codelineno-1-49></a>
</span><span id=__span-1-50><a id=__codelineno-1-50 name=__codelineno-1-50 href=#__codelineno-1-50></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>bro-activator<span class=w>         </span><span class=se>\</span>
</span><span id=__span-1-51><a id=__codelineno-1-51 name=__codelineno-1-51 href=#__codelineno-1-51></a><span class=w>    </span>--name<span class=w> </span>postgresql<span class=w>                       </span><span class=se>\</span>
</span><span id=__span-1-52><a id=__codelineno-1-52 name=__codelineno-1-52 href=#__codelineno-1-52></a><span class=w>    </span>--external-port<span class=w> </span><span class=m>0</span>.0.0.0:5432<span class=w>            </span><span class=se>\</span>
</span><span id=__span-1-53><a id=__codelineno-1-53 name=__codelineno-1-53 href=#__codelineno-1-53></a><span class=w>    </span>--internal-port<span class=w> </span><span class=m>127</span>.0.0.1:5432
</span><span id=__span-1-54><a id=__codelineno-1-54 name=__codelineno-1-54 href=#__codelineno-1-54></a>
</span><span id=__span-1-55><a id=__codelineno-1-55 name=__codelineno-1-55 href=#__codelineno-1-55></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-1-56><a id=__codelineno-1-56 name=__codelineno-1-56 href=#__codelineno-1-56></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w>             </span><span class=se>\</span>
</span><span id=__span-1-57><a id=__codelineno-1-57 name=__codelineno-1-57 href=#__codelineno-1-57></a><span class=w>    </span>--user<span class=w> </span><span class=nb>enable</span><span class=w> </span>--now<span class=w> </span>postgresql-activator.socket
</span><span id=__span-1-58><a id=__codelineno-1-58 name=__codelineno-1-58 href=#__codelineno-1-58></a>
</span><span id=__span-1-59><a id=__codelineno-1-59 name=__codelineno-1-59 href=#__codelineno-1-59></a><span class=nb>export</span><span class=w> </span><span class=nv>PGPASSWORD</span><span class=o>=</span>password
</span><span id=__span-1-60><a id=__codelineno-1-60 name=__codelineno-1-60 href=#__codelineno-1-60></a><span class=nv>DB_IP</span><span class=o>=</span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;kernel scope link&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $9}&#39;</span><span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-1-61><a id=__codelineno-1-61 name=__codelineno-1-61 href=#__codelineno-1-61></a><span class=c1># Test connections</span>
</span><span id=__span-1-62><a id=__codelineno-1-62 name=__codelineno-1-62 href=#__codelineno-1-62></a>psql<span class=w> </span>-h<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>DB_IP</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;\l&#39;</span>
</span><span id=__span-1-63><a id=__codelineno-1-63 name=__codelineno-1-63 href=#__codelineno-1-63></a>psql<span class=w> </span>-h<span class=w> </span><span class=m>127</span>.0.0.1<span class=w> </span>-p<span class=w> </span><span class=m>5432</span><span class=w> </span>-U<span class=w> </span>postgres<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;\l&#39;</span>
</span><span id=__span-1-64><a id=__codelineno-1-64 name=__codelineno-1-64 href=#__codelineno-1-64></a>psql<span class=w> </span><span class=s2>&quot;postgres://gitea@</span><span class=si>${</span><span class=nv>DB_IP</span><span class=si>}</span><span class=s2>/giteadb&quot;</span>
</span></code></pre></div><blockquote><p><strong>NOTE</strong>: The PostgreSQL server may take a little while to initialize the database on the first run. If the <code>psql</code> commands fail, wait a minute and try again.</p></blockquote><p>The bro-activator command above sets up socket activation for the PostgreSQL server container on <code>0.0.0.0:5432</code> for the host which means all interfaces including its loopback and external interface. The PostgreSQL server container is hence directly exposed to the network. Desktop pgAdmin instances can connect to it from outside the VM and the pgAdmin web application container will be able to connect to it over the loopback interface.</p><p>Now let's set up the pgAdmin web application container in its own unprivileged user account called <code>pgadmin</code>. The pgAdmin container will connect to the PostgreSQL server over its systemd socket port on <code>localhost:5432</code>. Issue the following commands:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=nv>PG_USER</span><span class=o>=</span>pgadmin
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>sudo<span class=w> </span>bro-user<span class=w> </span>--remove<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>sudo<span class=w> </span>bro-user<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span>--network-cmd<span class=w> </span><span class=s2>&quot;none&quot;</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=nv>PG_HOME</span><span class=o>=</span><span class=s2>&quot;</span><span class=k>$(</span>getent<span class=w> </span>passwd<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>cut<span class=w> </span>-f<span class=w> </span><span class=m>6</span><span class=w> </span>-d<span class=w> </span><span class=s1>&#39;:&#39;</span><span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=nv>CONTAINERS_CONFIG</span><span class=o>=</span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_HOME</span><span class=si>}</span><span class=s2>&quot;</span>/.config/containers/systemd/
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>CONTAINERS_CONFIG</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>cat<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39; | sudo -iu &quot;${PG_USER}&quot; tee &quot;${CONTAINERS_CONFIG}&quot;/pgadmin.container</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=s>[Unit]</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=s>Description=pgAdmin Container</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=s>[Container]</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=s>Image=docker.io/dpage/pgadmin4:latest</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=s>ContainerName=pgadmin</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=s>Environment=PGADMIN_DEFAULT_PASSWORD=password</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=s>Environment=PGADMIN_DEFAULT_EMAIL=admin@example.com</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=s>Environment=PGADMIN_LISTEN_PORT=5050</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=s># Works like a charm too</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=s>#Network=slirp4netns:allow_host_loopback=true</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=s>#AddHost=postgresql:10.0.2.2</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a>
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a><span class=s>Network=pasta:-T,5432:5432,--map-gw,--ipv4-only</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a><span class=s>AddHost=postgresql:192.168.122.1</span>
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a>
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a><span class=s>[Service]</span>
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a><span class=s>Restart=always</span>
</span><span id=__span-2-29><a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a><span class=s>TimeoutStartSec=120</span>
</span><span id=__span-2-30><a id=__codelineno-2-30 name=__codelineno-2-30 href=#__codelineno-2-30></a><span class=s>StartLimitBurst=5</span>
</span><span id=__span-2-31><a id=__codelineno-2-31 name=__codelineno-2-31 href=#__codelineno-2-31></a><span class=s>RestartSec=10s</span>
</span><span id=__span-2-32><a id=__codelineno-2-32 name=__codelineno-2-32 href=#__codelineno-2-32></a>
</span><span id=__span-2-33><a id=__codelineno-2-33 name=__codelineno-2-33 href=#__codelineno-2-33></a><span class=s>[Install]</span>
</span><span id=__span-2-34><a id=__codelineno-2-34 name=__codelineno-2-34 href=#__codelineno-2-34></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-2-35><a id=__codelineno-2-35 name=__codelineno-2-35 href=#__codelineno-2-35></a><span class=s>EOF</span>
</span><span id=__span-2-36><a id=__codelineno-2-36 name=__codelineno-2-36 href=#__codelineno-2-36></a>
</span><span id=__span-2-37><a id=__codelineno-2-37 name=__codelineno-2-37 href=#__codelineno-2-37></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>        </span><span class=se>\</span>
</span><span id=__span-2-38><a id=__codelineno-2-38 name=__codelineno-2-38 href=#__codelineno-2-38></a><span class=w>    </span>--remove<span class=w> </span>--name<span class=w> </span>pgadmin-data
</span><span id=__span-2-39><a id=__codelineno-2-39 name=__codelineno-2-39 href=#__codelineno-2-39></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--name<span class=w> </span>pgadmin-data<span class=w>         </span><span class=se>\</span>
</span><span id=__span-2-40><a id=__codelineno-2-40 name=__codelineno-2-40 href=#__codelineno-2-40></a><span class=w>    </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>                    </span><span class=se>\</span>
</span><span id=__span-2-41><a id=__codelineno-2-41 name=__codelineno-2-41 href=#__codelineno-2-41></a><span class=w>    </span>--container<span class=w> </span>pgadmin<span class=w>                     </span><span class=se>\</span>
</span><span id=__span-2-42><a id=__codelineno-2-42 name=__codelineno-2-42 href=#__codelineno-2-42></a><span class=w>    </span>--container-user<span class=w> </span>internal:5050<span class=w>          </span><span class=se>\</span>
</span><span id=__span-2-43><a id=__codelineno-2-43 name=__codelineno-2-43 href=#__codelineno-2-43></a><span class=w>    </span>--container-group<span class=w> </span>internal:0<span class=w>            </span><span class=se>\</span>
</span><span id=__span-2-44><a id=__codelineno-2-44 name=__codelineno-2-44 href=#__codelineno-2-44></a><span class=w>    </span>--container-path<span class=w> </span>/var/lib/pgadmin
</span><span id=__span-2-45><a id=__codelineno-2-45 name=__codelineno-2-45 href=#__codelineno-2-45></a>
</span><span id=__span-2-46><a id=__codelineno-2-46 name=__codelineno-2-46 href=#__codelineno-2-46></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>bro-activator<span class=w>         </span><span class=se>\</span>
</span><span id=__span-2-47><a id=__codelineno-2-47 name=__codelineno-2-47 href=#__codelineno-2-47></a><span class=w>    </span>--name<span class=w> </span>pgadmin<span class=w>                          </span><span class=se>\</span>
</span><span id=__span-2-48><a id=__codelineno-2-48 name=__codelineno-2-48 href=#__codelineno-2-48></a><span class=w>    </span>--external-port<span class=w> </span><span class=m>5050</span><span class=w>                    </span><span class=se>\</span>
</span><span id=__span-2-49><a id=__codelineno-2-49 name=__codelineno-2-49 href=#__codelineno-2-49></a><span class=w>    </span>--internal-port<span class=w> </span><span class=m>127</span>.0.0.1:5050
</span><span id=__span-2-50><a id=__codelineno-2-50 name=__codelineno-2-50 href=#__codelineno-2-50></a>
</span><span id=__span-2-51><a id=__codelineno-2-51 name=__codelineno-2-51 href=#__codelineno-2-51></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-2-52><a id=__codelineno-2-52 name=__codelineno-2-52 href=#__codelineno-2-52></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PG_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w>             </span><span class=se>\</span>
</span><span id=__span-2-53><a id=__codelineno-2-53 name=__codelineno-2-53 href=#__codelineno-2-53></a><span class=w>    </span>--user<span class=w> </span><span class=nb>enable</span><span class=w> </span>--now<span class=w> </span>pgadmin-activator.socket
</span></code></pre></div><blockquote><p><strong>NOTE</strong>: The upstream <code>dpage/pgadmin4</code> image runs as uid/gid 5050/0, so the <code>bro-volume --container-user/--container-group</code> flags accept usernames (like <code>pgadmin</code>), numeric IDs, or <code>internal:</code>-prefixed IDs. <code>internal:5050</code> maps pgAdmin's in-container UID to the correct subordinate UID on the host, and <code>internal:0</code> maps the container's root group back to the host pgadmin user. No hand-calculating <code>236121</code>.</p></blockquote><p>Using <code>--container-group pgadmin</code> instead of <code>internal:0</code> produces the same permissions on the host because <code>bro-volume</code> resolves group names and translates internal:0 to the owner name before applying ownership changes to ZFS dataset mount points.</p><h3 id=14-connecting-with-pgadmin-desktop-and-pgadmin-web-application>1.4 Connecting with pgAdmin Desktop and pgAdmin Web Application<a class=headerlink href=#14-connecting-with-pgadmin-desktop-and-pgadmin-web-application title="Permanent link">&para;</a></h3><p>Go ahead and download and install the pgAdmin desktop application on your host machine from the <a href=https://www.pgadmin.org/download/ >pgAdmin website</a>. Once installed, launch the pgAdmin desktop application. Here's how my setup looks like on Manjaro Linux:</p><p><img alt="pgAdmin Desktop Application" src=../../assets/pgadmin-master-password.png></p><p>Notice it requests a master password to protect stored connection credentials. Set a strong master password and remember it. This helps protect stored connection credentials in case the desktop is compromised but it is not foolproof.</p><p>Let's connect to the PostgreSQL server running in the VM using the following connection parameters:</p><div class="language-text highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>Host: 192.168.122.40
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>Port: 5432
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>Username: postgres
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>Database: postgres
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>Password: password
</span></code></pre></div><blockquote><p><strong>NOTE</strong>: the host IP address may vary depending on your VM setup. Adjust accordingly.</p></blockquote><p><img alt="pgAdmin Server Properties" src=../../assets/pgadmin-connection-parameters.png></p><p>Once connected, you should see the PostgreSQL server and its databases in the pgAdmin desktop application. If so, configurations, you're now connected to the PostgreSQL server running in the VM from the desktop pgAdmin application.</p><p>You can also connect to the PostgreSQL server from within the pgAdmin web application running in its own container in the VM. Use the following settings instead in the web application after logging in with username <code>admin@example.com</code> and password <code>password</code> to setup a new server connection:</p><div class="language-text highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>Host: postgresql
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>Port: 5432
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>Username: postgres
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>Database: postgres
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>Password: password
</span></code></pre></div><p>Notice in this case we use the hostname <code>postgresql</code> which resolves to the PostgreSQL server container's IP address in the pgAdmin container's network namespace thanks to the <code>AddHost=</code> directive in the pgAdmin quadlet.</p><p>Both pgAdmin instances (desktop and web) are able to connect to the same PostgreSQL server instance running in its own container in the VM. In both cases a systemd socket is used to activate a Podman container and proxy traffic to PostgreSQL server in its own unprivileged user account.</p><h3 id=15-setting-up-gitea>1.5 Setting up Gitea<a class=headerlink href=#15-setting-up-gitea title="Permanent link">&para;</a></h3><p>Let's set up another application that non-interactively uses the same shared PostgreSQL instance to demonstrate path based authentication with the reverse proxy later. We'll use Gitea, a lightweight code hosting solution written in Go. It supports Git version control and provides a web interface and rest API for managing repositories, users, and other features.</p><p>Create another unprivileged user account called <code>gitea</code> and set up the Gitea container in its own unprivileged user account. Issue the following commands:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=nv>GITEA_USER</span><span class=o>=</span>gitea
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>sudo<span class=w> </span>bro-user<span class=w> </span>--remove<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>sudo<span class=w> </span>bro-user<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>--network-cmd<span class=w> </span><span class=s2>&quot;none&quot;</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=nv>GITEA_HOME</span><span class=o>=</span><span class=s2>&quot;</span><span class=k>$(</span>getent<span class=w> </span>passwd<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>cut<span class=w> </span>-f<span class=w> </span><span class=m>6</span><span class=w> </span>-d<span class=w> </span><span class=s1>&#39;:&#39;</span><span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=nv>CONTAINERS_CONFIG</span><span class=o>=</span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_HOME</span><span class=si>}</span><span class=s2>&quot;</span>/.config/containers/systemd/
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>CONTAINERS_CONFIG</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>cat<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39; | sudo -iu &quot;${GITEA_USER}&quot; tee &quot;${CONTAINERS_CONFIG}&quot;/gitea.container</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=s>[Unit]</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=s>Description=Gitea Container</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=s>[Container]</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=s>Image=docker.gitea.com/gitea:1.25.1-rootless</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=s>ContainerName=gitea</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=s>Environment=GITEA__security__INSTALL_LOCK=true</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=s>Environment=GITEA__database__DB_TYPE=postgres</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=s>Environment=GITEA__database__HOST=postgresql:5432</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=s>Environment=GITEA__database__NAME=giteadb</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=s>Environment=GITEA__database__USER=gitea</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=s>Environment=GITEA__database__PASSWD=gitea</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a><span class=s>Network=pasta:-T,5432:5432,--map-gw,--ipv4-only</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a><span class=s>AddHost=postgresql:192.168.122.1</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a><span class=s>Volume=/etc/timezone:/etc/timezone:ro</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a><span class=s>Volume=/etc/localtime:/etc/localtime:ro</span>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a><span class=s>[Service]</span>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a><span class=s>Restart=always</span>
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a><span class=s>TimeoutStartSec=120</span>
</span><span id=__span-5-31><a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a><span class=s>StartLimitBurst=5</span>
</span><span id=__span-5-32><a id=__codelineno-5-32 name=__codelineno-5-32 href=#__codelineno-5-32></a><span class=s>RestartSec=10s</span>
</span><span id=__span-5-33><a id=__codelineno-5-33 name=__codelineno-5-33 href=#__codelineno-5-33></a>
</span><span id=__span-5-34><a id=__codelineno-5-34 name=__codelineno-5-34 href=#__codelineno-5-34></a><span class=s>[Install]</span>
</span><span id=__span-5-35><a id=__codelineno-5-35 name=__codelineno-5-35 href=#__codelineno-5-35></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-5-36><a id=__codelineno-5-36 name=__codelineno-5-36 href=#__codelineno-5-36></a><span class=s>EOF</span>
</span><span id=__span-5-37><a id=__codelineno-5-37 name=__codelineno-5-37 href=#__codelineno-5-37></a>
</span><span id=__span-5-38><a id=__codelineno-5-38 name=__codelineno-5-38 href=#__codelineno-5-38></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>         </span><span class=se>\</span>
</span><span id=__span-5-39><a id=__codelineno-5-39 name=__codelineno-5-39 href=#__codelineno-5-39></a><span class=w>    </span>--remove<span class=w> </span>--name<span class=w> </span>gitea-data
</span><span id=__span-5-40><a id=__codelineno-5-40 name=__codelineno-5-40 href=#__codelineno-5-40></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--name<span class=w> </span>gitea-data<span class=w>               </span><span class=se>\</span>
</span><span id=__span-5-41><a id=__codelineno-5-41 name=__codelineno-5-41 href=#__codelineno-5-41></a><span class=w>    </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>                     </span><span class=se>\</span>
</span><span id=__span-5-42><a id=__codelineno-5-42 name=__codelineno-5-42 href=#__codelineno-5-42></a><span class=w>    </span>--container<span class=w> </span>gitea<span class=w>                           </span><span class=se>\</span>
</span><span id=__span-5-43><a id=__codelineno-5-43 name=__codelineno-5-43 href=#__codelineno-5-43></a><span class=w>    </span>--container-user<span class=w> </span>internal:1000<span class=w>              </span><span class=se>\</span>
</span><span id=__span-5-44><a id=__codelineno-5-44 name=__codelineno-5-44 href=#__codelineno-5-44></a><span class=w>    </span>--container-group<span class=w> </span>internal:1000<span class=w>             </span><span class=se>\</span>
</span><span id=__span-5-45><a id=__codelineno-5-45 name=__codelineno-5-45 href=#__codelineno-5-45></a><span class=w>    </span>--container-path<span class=w> </span>/var/lib/gitea
</span><span id=__span-5-46><a id=__codelineno-5-46 name=__codelineno-5-46 href=#__codelineno-5-46></a>
</span><span id=__span-5-47><a id=__codelineno-5-47 name=__codelineno-5-47 href=#__codelineno-5-47></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>         </span><span class=se>\</span>
</span><span id=__span-5-48><a id=__codelineno-5-48 name=__codelineno-5-48 href=#__codelineno-5-48></a><span class=w>    </span>--remove<span class=w> </span>--name<span class=w> </span>gitea-config
</span><span id=__span-5-49><a id=__codelineno-5-49 name=__codelineno-5-49 href=#__codelineno-5-49></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--name<span class=w> </span>gitea-config<span class=w>             </span><span class=se>\</span>
</span><span id=__span-5-50><a id=__codelineno-5-50 name=__codelineno-5-50 href=#__codelineno-5-50></a><span class=w>    </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>                     </span><span class=se>\</span>
</span><span id=__span-5-51><a id=__codelineno-5-51 name=__codelineno-5-51 href=#__codelineno-5-51></a><span class=w>    </span>--container<span class=w> </span>gitea<span class=w>                           </span><span class=se>\</span>
</span><span id=__span-5-52><a id=__codelineno-5-52 name=__codelineno-5-52 href=#__codelineno-5-52></a><span class=w>    </span>--container-user<span class=w> </span>internal:1000<span class=w>              </span><span class=se>\</span>
</span><span id=__span-5-53><a id=__codelineno-5-53 name=__codelineno-5-53 href=#__codelineno-5-53></a><span class=w>    </span>--container-group<span class=w> </span>internal:1000<span class=w>             </span><span class=se>\</span>
</span><span id=__span-5-54><a id=__codelineno-5-54 name=__codelineno-5-54 href=#__codelineno-5-54></a><span class=w>    </span>--container-path<span class=w> </span>/etc/gitea
</span><span id=__span-5-55><a id=__codelineno-5-55 name=__codelineno-5-55 href=#__codelineno-5-55></a>
</span><span id=__span-5-56><a id=__codelineno-5-56 name=__codelineno-5-56 href=#__codelineno-5-56></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>bro-activator<span class=w>          </span><span class=se>\</span>
</span><span id=__span-5-57><a id=__codelineno-5-57 name=__codelineno-5-57 href=#__codelineno-5-57></a><span class=w>    </span>--name<span class=w> </span>gitea<span class=w>                                </span><span class=se>\</span>
</span><span id=__span-5-58><a id=__codelineno-5-58 name=__codelineno-5-58 href=#__codelineno-5-58></a><span class=w>    </span>--service-name<span class=w> </span>http<span class=w>                         </span><span class=se>\</span>
</span><span id=__span-5-59><a id=__codelineno-5-59 name=__codelineno-5-59 href=#__codelineno-5-59></a><span class=w>    </span>--external-port<span class=w> </span><span class=m>0</span>.0.0.0:3000<span class=w>                </span><span class=se>\</span>
</span><span id=__span-5-60><a id=__codelineno-5-60 name=__codelineno-5-60 href=#__codelineno-5-60></a><span class=w>    </span>--internal-port<span class=w> </span><span class=m>127</span>.0.0.1:3000
</span><span id=__span-5-61><a id=__codelineno-5-61 name=__codelineno-5-61 href=#__codelineno-5-61></a>
</span><span id=__span-5-62><a id=__codelineno-5-62 name=__codelineno-5-62 href=#__codelineno-5-62></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>bro-activator<span class=w>          </span><span class=se>\</span>
</span><span id=__span-5-63><a id=__codelineno-5-63 name=__codelineno-5-63 href=#__codelineno-5-63></a><span class=w>    </span>--name<span class=w> </span>gitea<span class=w>                                </span><span class=se>\</span>
</span><span id=__span-5-64><a id=__codelineno-5-64 name=__codelineno-5-64 href=#__codelineno-5-64></a><span class=w>    </span>--service-name<span class=w> </span>ssh<span class=w>                          </span><span class=se>\</span>
</span><span id=__span-5-65><a id=__codelineno-5-65 name=__codelineno-5-65 href=#__codelineno-5-65></a><span class=w>    </span>--external-port<span class=w> </span><span class=m>0</span>.0.0.0:2222<span class=w>                </span><span class=se>\</span>
</span><span id=__span-5-66><a id=__codelineno-5-66 name=__codelineno-5-66 href=#__codelineno-5-66></a><span class=w>    </span>--internal-port<span class=w> </span><span class=m>127</span>.0.0.1:2222
</span><span id=__span-5-67><a id=__codelineno-5-67 name=__codelineno-5-67 href=#__codelineno-5-67></a>
</span><span id=__span-5-68><a id=__codelineno-5-68 name=__codelineno-5-68 href=#__codelineno-5-68></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-5-69><a id=__codelineno-5-69 name=__codelineno-5-69 href=#__codelineno-5-69></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w>              </span><span class=se>\</span>
</span><span id=__span-5-70><a id=__codelineno-5-70 name=__codelineno-5-70 href=#__codelineno-5-70></a><span class=w>    </span>--user<span class=w> </span><span class=nb>enable</span><span class=w> </span>--now<span class=w>                         </span><span class=se>\</span>
</span><span id=__span-5-71><a id=__codelineno-5-71 name=__codelineno-5-71 href=#__codelineno-5-71></a><span class=w>        </span>gitea-http-activator.socket<span class=w>             </span><span class=se>\</span>
</span><span id=__span-5-72><a id=__codelineno-5-72 name=__codelineno-5-72 href=#__codelineno-5-72></a><span class=w>        </span>gitea-ssh-activator.socket
</span><span id=__span-5-73><a id=__codelineno-5-73 name=__codelineno-5-73 href=#__codelineno-5-73></a>
</span><span id=__span-5-74><a id=__codelineno-5-74 name=__codelineno-5-74 href=#__codelineno-5-74></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>gitea.service
</span><span id=__span-5-75><a id=__codelineno-5-75 name=__codelineno-5-75 href=#__codelineno-5-75></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>GITEA_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>podman<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>gitea<span class=w>  </span><span class=se>\</span>
</span><span id=__span-5-76><a id=__codelineno-5-76 name=__codelineno-5-76 href=#__codelineno-5-76></a><span class=w>    </span>/app/gitea/gitea<span class=w> </span>admin<span class=w> </span>user<span class=w> </span>create<span class=w>          </span><span class=se>\</span>
</span><span id=__span-5-77><a id=__codelineno-5-77 name=__codelineno-5-77 href=#__codelineno-5-77></a><span class=w>    </span>--username<span class=w> </span>admin<span class=w>                            </span><span class=se>\</span>
</span><span id=__span-5-78><a id=__codelineno-5-78 name=__codelineno-5-78 href=#__codelineno-5-78></a><span class=w>    </span>--password<span class=w> </span>password<span class=w>                         </span><span class=se>\</span>
</span><span id=__span-5-79><a id=__codelineno-5-79 name=__codelineno-5-79 href=#__codelineno-5-79></a><span class=w>    </span>--email<span class=w> </span>admin@example.com<span class=w>                   </span><span class=se>\</span>
</span><span id=__span-5-80><a id=__codelineno-5-80 name=__codelineno-5-80 href=#__codelineno-5-80></a><span class=w>    </span>--admin<span class=w>                                     </span><span class=se>\</span>
</span><span id=__span-5-81><a id=__codelineno-5-81 name=__codelineno-5-81 href=#__codelineno-5-81></a><span class=w>    </span>-c<span class=w> </span>/etc/gitea/app.ini
</span></code></pre></div><blockquote><p><strong>TIP</strong>: The <code>--service-name</code> flag scopes each activator to a distinct unit name (<code>gitea-http-activator.{socket,service}</code> and <code>gitea-ssh-activator.{socket,service}</code> in this example). Without it, the second activator would overwrite the first because they would both try to manage <code>gitea-activator.*</code>. Use descriptive labels like <code>http</code>, <code>ssh</code>, or <code>api</code> whenever you need to expose multiple ports for a single container.</p></blockquote><p>Now on your desktop you can navigate to <code>http://&lt;your-vm-ip&gt;:3000/user/login</code> to log into the Gitea web application. Log in with username <code>admin</code> and password <code>password</code>. You should now have access to the Gitea web interface. You can create repositories, manage users, and explore its features.</p><p><img alt="Gitea Login" src=../../assets/gitea-login.png></p><p>Here's the Gitea web interface after logging in:</p><p><img alt="Gitea Console" src=../../assets/gitea-console.png></p><p>Gitea is connected to the same PostgreSQL server instance running in the VM, so in pgAdmin refresh the connection and you should see the <code>giteadb</code> database.</p><p><img alt="pgAdmin Connections" src=../../assets/pgadmin-connections.png></p><p>So far so good. Both pgAdmin (desktop and web) and Gitea are able to connect to the same PostgreSQL server instance running in its own container in the VM. However, the PostgreSQL server is directly exposed to the network which is not secure. pgAdmin web application is also directly exposed to the network which is also not secure as secure as we want it to be considering it stores connections to the PostgreSQL server including super user credentials.</p><p>Not so bad, but this is the insecure setup. Now let's discuss how to secure it.</p><h2 id=20-strong-authentication>2.0 Strong Authentication<a class=headerlink href=#20-strong-authentication title="Permanent link">&para;</a></h2><p>We will use a class of techniques called strong authentication to secure access to dangerous applications such as pgAdmin. In fact, strong authentication is recommended for any exposed application. Strong authentication requires more than just a password to authenticate users. It typically involves multiple factors of authentication such as something you know (password), something you have (security token), or something you are (biometric verification).</p><h3 id=21-strong-authentication-for-interactive-applications>2.1 Strong Authentication for Interactive Applications<a class=headerlink href=#21-strong-authentication-for-interactive-applications title="Permanent link">&para;</a></h3><p>There are directly exposed interactive end-user applications and indirectly exposed non-interactive backend services. Interactive end-user applications require user interaction to function, such as the pgAdmin web application. We can exploit that fact to force the use of strong authentication which requires user interaction: a token button press, a biometric verification, or a TOTP one time code. Using such mechanisms helps secure access to such dangerous applications. In fact, strong password-less authentication should be used everywhere regardless of the application.</p><p>Strong authentication mechanisms will be used to gate access to the application at the network level before an attacker can reach the application itself. This way, we generalize a reusable solution for any directly exposed end-user (interactive) application. Most web applications manage users and password credentials and many have integrations for strong authentication mechanisms such as MFA. However, we want to avoid the quagmire of application specific configuration details and coupling. We want one, <strong><em>decoupled and independent</em></strong> strong authentication approach that applies across all applications without having know anything about the application.</p><p>As discussed in the last section, we can use a reverse proxy to enforce authentication, then (perform authorization to) allow or deny access to the application before even reaching the application. The reverse proxy can be combined with an Identity Provider (IdP) to support multiple strong authentication mechanisms and manage groups authorized to access downstream applications.</p><blockquote><p><strong>IN APPLICATION API ACCESS</strong>: Some interactive applications also expose APIs for automation and thus are both non-interactive and interactive. Since these APIs are non-interactive, they cannot leverage user interaction for strong authentication. Instead, they often rely on API-token based authentication mechanisms, OAuth tokens, or JWTs. Application APIs have distinct and different URL paths than those presented to interactive users. The reverse proxy can map different authentication mechanisms based on URL paths to support both interactive end-user paths with strong authentication and non-interactive APIs using API-token based authentication. We introduced gitea not only because we wanted yet another application using the database but it also has an API to demonstrate path based authentication with.</p></blockquote><h3 id=22-caddy-and-keycloak-to-the-rescue>2.2 Caddy and Keycloak to the rescue<a class=headerlink href=#22-caddy-and-keycloak-to-the-rescue title="Permanent link">&para;</a></h3><p>Caddy will be used for the reverse proxy. Keycloak will be used an Identity Provider (IdP). Step-ca will be used to issue TLS certificates. These three components will run in a single unprivileged user account called <code>identity</code>. The pgAdmin web application already runs in its container in its own unprivileged user account called <code>pgadmin</code>, and as a desktop client on test desktops. PostgreSQL already runs in its own container in its own unprivileged user account called <code>postgresql</code>. Gitea will be used as another test application that non-interactively uses the same shared postgresql instance and it will run in its own unprivileged user account called <code>gitea</code>.</p><p>Caddy will gate access and route traffic to the two web applications: pgAdmin and gitea. Caddy will use WebAuthn APIs for FIDO2 and TOTP strong authentication mechanisms to authenticate and authorize users using Keycloak as the IdP. Only authorized users in specific groups will be allowed access to each application. Caddy will also proxy Keycloak and step-ca endpoints for web applications to use. Here's a list of proxied endpoints:</p><ul><li>the Keycloak server web administration UI for user self-service and management and its WebAuthn endpoints</li><li>the pgAdmin web application UI for postgresql database management</li><li>the postgresql server for database connections from clients, for both interactive and non-interactive access</li><li>the gitea application for non-interactive access to postgresql</li><li>the step-ca ACME endpoint for certificate issuance and renewal</li><li>the step-ca TLS client authentication endpoint</li></ul><pre class=mermaid><code>sequenceDiagram
    participant Browser
    participant Caddy as Caddy (Reverse Proxy + OIDC client)
    participant Keycloak as Keycloak (IdP)
    participant WebApp as Downstream Web Application

    Note over Browser,Caddy: User requests web application
    Browser-&gt;&gt;Caddy: HTTPS 443 GET https://app.example.com/
    alt no session / not authenticated
        Caddy-&gt;&gt;Browser: 302 Redirect to Keycloak Auth endpoint
        Browser-&gt;&gt;Keycloak: HTTPS 443 GET /realms/webapps/protocol/openid-connect/auth?client_id=&amp;redirect_uri=
        Keycloak-&gt;&gt;Browser: HTML login page (with MFA options: FIDO2 / TOTP)
        Browser-&gt;&gt;Keycloak: POST login credentials + choose WebAuthn/TOTP
        Keycloak-&gt;&gt;Browser: 302 Redirect back to redirect_uri with auth code
        Browser-&gt;&gt;Caddy: HTTPS 443 GET https://app.example.com/callback?code=&amp;state=
        Caddy-&gt;&gt;Keycloak: HTTPS 443 POST /realms/webapps/protocol/openid-connect/token (grant_type=authorization_code &amp; code=)
        Keycloak-&gt;&gt;Caddy: JSON response { id_token, access_token, refresh_token,  }
        Caddy-&gt;&gt;Keycloak: HTTPS 443 GET /realms/webapps/protocol/openid-connect/userinfo (Authorization: Bearer access_token)
        Keycloak-&gt;&gt;Caddy: JSON userinfo { sub, email, groups:["webapp-users",],  }
        Caddy-&gt;&gt;Caddy: Validate token &amp; check claim groups contains "webapp-users"
    end
    alt authorised
        Caddy-&gt;&gt;WebApp: HTTP/HTTPS internal proxy request to WebApp on internal port (e.g., 8080) with X-Auth-User &amp; X-Auth-Groups headers
        WebApp--&gt;&gt;Browser: HTTP/HTTPS response via Caddy
    else not authorised
        Caddy--&gt;&gt;Browser: HTTP 403 Forbidden or redirect to access-denied page
    end</code></pre><h4 id=overview-of-the-flow>Overview of the flow<a class=headerlink href=#overview-of-the-flow title="Permanent link">&para;</a></h4><p>Users of an interactive web app  hit Caddy reverse-proxy  Caddy ensures they're authenticated (via Keycloak) and authorised (group membership)  if yes, proxy to downstream web application; if no, deny. Here's the typical step-by-step flow:</p><ol><li><p>A user opens the browser and tries to access the web app through the Caddy proxy (e.g., <a href=https://app.example.com>https://app.example.com</a>).</p></li><li><p>Caddy detects that the user is not yet authenticated (via some session cookie or token).</p></li><li><p>Caddy (or a plugin) sends the user to Keycloak for login (redirect). This uses the OIDC protocol (which is built on OAuth 2.0). Keycloak presents the login screen  and you can configure it to require FIDO2 / TOTP as part of the login flow (MFA).</p></li><li><p>User completes authentication (with FIDO2 key or TOTP). Keycloak issues an ID token and/or access token (JWT) to the browser/app.</p></li><li><p>Browser returns to Caddy (via the callback redirect) with the token or code, etc.</p></li><li><p>Caddy validates the token (or exchanges an authorization code for a token) and checks the user's group/role claims to decide if the user is allowed to access the downstream web-app.</p><ul><li><p>If allowed: Caddy forwards the request to the downstream web application, possibly passing a header (e.g., Authorization: Bearer token or a custom header with user info).</p></li><li><p>If not allowed: Caddy returns 403 or redirects to an access denied page.</p></li></ul></li><li><p>For subsequent requests, the session is maintained (cookie or token) so the redirect to Keycloak is not repeated until session expiry.</p></li></ol><p>So, in short: Caddy acts as an OIDC client (or uses an OIDC gate/plug-in) in front of your web-app; Keycloak is the OIDC provider.</p><h4 id=unprivileged-users-and-containers>Unprivileged Users and Containers<a class=headerlink href=#unprivileged-users-and-containers title="Permanent link">&para;</a></h4><p><img alt="Architecture Diagram" src=../../diagrams/sec_arch.png></p><p>In section <a href=./#20-strong-authentication>2.0 Strong Authentication</a> mentioned the words, "decoupled" and "independent", with respect to the mechanism. What was meant now manifests concretely in the security contexts and boundaries in the diagram above. Notice that Caddy, Keycloak, and step-ca all run together in the same unprivileged user account called <code>identity</code> with a network quadlet to provide private container-to-container communication between them. They are tightly coupled to one another and together they provide strong authentication and authorization. However, they are decoupled and independent of the applications they gate access to: <code>pgAdmin</code> and <code>gitea</code>. These protected applications run in their own unprivileged user accounts called <code>pgadmin</code> and <code>gitea</code> respectively. There is no contagion risk between the identity services and the applications they protect.</p><p>Compromising the <code>identity</code> unprivileged user account running Caddy and Keycloak does not compromise the applications they provide an additional layer of strong authentication to protect. Caddy knows nothing about the applications themselves other than their existence and how to proxy them. Keycloak registers hardware tokens for users and groups them based on their access to applications. Together they determine and proxy connections to applications. The private network quadlet for container-to-container communication allows Caddy connections to Keycloak and step-ca to remain private over the dedicated network without risking exposure of their service ports to the host or to the outside world; namely:</p><ul><li>Caddy's OIDC interactions with Keycloak to enforce policies and access to web applications at the network level</li><li>Caddy's proxying of Keycloak endpoints</li><li>Caddy's proxying of step-ca ACME and TLS client authentication endpoints</li></ul><p>Identity operations are fully isolated from application operations and Caddy is the first decoupled protective barrier, an independent PEP (Policy Enforcement Point), controlling network level access to applications based on authentication and authorization policies. Applications still manage their own users requiring them to login to the applications themselves: these are second independent authentication factors, the "what you know" factors. Again, compromising the unprivileged <code>identity</code> user or any one of the other unprivileged applications (pgAdmin and gitea) does not compromise the other unprivileged user accounts or its containers. Everything remains intact and independent even though there are perceived dependencies: i.e. Caddy still proxies pgAdmin and gitea.</p><p>Furthermore, the pgAdmin and gitea containers running in their own separate unprivileged user accounts are never directly exposed to the network. These applications expose their HTTP ports on the host's loopback interface. Only the Caddy reverse proxy is directly exposed to proxy traffic outside of the host. Firewall rules in the host map privileged port 443 to Caddy's listening port 8443 since Caddy cannot bind to ports below 1024 when running unprivileged. Port 80 is always redirected by the firewall to port 443. Caddy also redirects port 8080 to 8443 to always ensure the use of TLS termination. The firewall may also be used to restrict access to Caddy from known IP sources and trusted networks.</p><h3 id=23-protecting-pgadmin-desktop-mode>2.3 Protecting pgAdmin Desktop Mode<a class=headerlink href=#23-protecting-pgadmin-desktop-mode title="Permanent link">&para;</a></h3><p>There will be multiple desktop mode pgAdmin application instances running across external desktop hosts, a.k.a. clients. Each client requires access to postgresql servers over the network: the ones they administer. In our case we just have one shared postgresql server instance. The host's external interface binds port 5432 for postgresql connections originating from desktop pgAdmin clients. Instead of exposing the postgresql server directly to clients, the same Caddy reverse proxy also handles postgresql server connections from desktop pgAdmin clients. The reverse proxy should also serve as a PEP before allowing access to the database: no network access granted unless authenticated and authorized.</p><p>So what options do we have? How can we do this with a generalized (reusable) solution?</p><p>Although the latest postgresql 18.0 release now supports OAuth 2.0 with bearer tokens for database connections, pgAdmin desktop mode does not support OAuth 2.0 or OpenID Connect (OIDC) for database connections. Therefore, we cannot use the same OIDC based strong authentication mechanism used for web applications to secure database connections from desktop pgAdmin clients. The industry, not just the pgAdmin people, are getting there though, so keep an eye out for better integration options; OIDC is the better way to go.</p><h4 id=ssh-tunneling-or-tls-client-certificates>SSH Tunneling or TLS Client Certificates?<a class=headerlink href=#ssh-tunneling-or-tls-client-certificates title="Permanent link">&para;</a></h4><p>That said, two common denominator alternatives remain: they're both equal in terms of their strength and management overheads. One is the use of TLS client certificates for strong authentication, and the other is the use of SSH tunneling with SSH keys. Both are generalized and can be used beyond our specific use case of gating postgresql network access. Let's quickly analyze both approaches.</p><p>Both require key material on the client: TLS client certificate private key or SSH private key. Both need to be generated, trusted (configured), and protected. Both can be compromised on the client side unless protected by a token or a vault via token access API's such as PKCS#11. Both are equally strong when implemented properly.</p><p><strong>WARNING</strong>: Storing private keys on clients is always too great a risk: if the client is compromised, the private key can be stolen and used to impersonate the client, so don't do it unless you can protect client keys using a hardware security token.</p><p>TLS is a baked in standard for securing network communications. It operates at layer 4 of the OSI model, providing end-to-end encryption and authentication. TLS client certificates are widely supported by many applications and services, including postgresql. They're also supported by multiple hardware tokens and interfaces for proper protection on client systems. They can be easily integrated into existing infrastructure and provide a seamless user experience. It's a first class citizen of the network stack.</p><p>SSH on the other hand is primarily designed for secure remote access and command execution. While SSH tunneling can be used to secure database connections, it introduces additional complexity and overhead. SSH requires managing separate user accounts and their keys, and this is what increases exposure and complexity (more moving parts). Additionally, not all applications natively support SSH tunneling, requiring additional configuration and more one offs. Let's play it safe and stick to the official standard. SSH keys do not work well with hardware tokens either, often requiring both gpg/tls certs and SSH keys representing them to be generated: it's still a problem but may improve later.</p><h4 id=using-tls-client-certificates>Using TLS Client Certificates<a class=headerlink href=#using-tls-client-certificates title="Permanent link">&para;</a></h4><p>Caddy will be configured to use TLS certificates trusted by the step-ca certificate authority (CA) for client authentication. This way, all traffic between pgAdmin desktop clients and Caddy is encrypted and TLS authenticated in both directions. To do so, Caddy exposes a separate connection path from outside of the host to the postgresql server.</p><blockquote><p>I'm so tempted to try Postgresql 18.0 which was just released support for OAuth 2.0 with bearer tokens. PostgreSQL 18.0 can be configured for external (non-loopback) database connection sources to switch authentication mechanisms and act as an OIDC client to Keycloak. Keycloak can enable short lived or one time use API tokens for DevOps automation. It would be wonderful to tie and track one time authorizations to DevOps jobs that modify databases in security logs. But I digress.</p></blockquote><p>Even if a desktop pgAdmin installation is compromised, the attacker cannot access the postgresql server without the client certificate. Securing the client certificate private key on the desktop is still paramount.</p><blockquote><p>We will <strong>NOT</strong> rely on IP sources since in dynamic environments (clients using DHCP) these change, and can easily be spoofed. Relying on IP sources make the system much more brittle in the long run and is not a solid security measure unless "LAN authentication/authorization" 802.1X or a VPN gateway is used: essentially some way to authenticate and authorize IP addresses on the network.</p></blockquote><h2 id=30-building-out-the-identity-user-account>3.0 Building out the identity User Account<a class=headerlink href=#30-building-out-the-identity-user-account title="Permanent link">&para;</a></h2><p>We're going install Caddy, Keycloak, and step-ca in their own unprivileged user account called <code>identity</code>. The three components will run in containers managed by Podman quadlets. They will communicate over a private network quadlet only accessible to them. For more details on the containers involved see the following sites and docker hub pages:</p><ul><li><strong>Caddy</strong>: <a href=https://caddyserver.com/ >Site</a> <a href=https://hub.docker.com/_/caddy>Docker</a></li><li><strong>Keycloak</strong>: <a href=https://www.keycloak.org/ >Site</a> <a href=https://hub.docker.com/r/keycloak/keycloak>Docker</a> <a href=https://www.keycloak.org/getting-started/getting-started-podman>Getting Started Podman</a></li><li><strong>step-ca</strong>: <a href=https://smallstep.com/docs/step-ca/ >Site</a> <a href=https://hub.docker.com/r/smallstep/step-ca>Docker</a></li></ul><p>Let's begin by creating the <code>identity</code> unprivileged user account and the <code>idp-private</code> network quadlet while logged into virtual machine as the vagrant user:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=nv>ID_USER</span><span class=o>=</span>identity
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>sudo<span class=w> </span>bro-user<span class=w> </span>--remove<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>sudo<span class=w> </span>bro-user<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>--network-cmd<span class=w> </span><span class=s2>&quot;none&quot;</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=nv>ID_HOME</span><span class=o>=</span><span class=s2>&quot;</span><span class=k>$(</span>getent<span class=w> </span>passwd<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>cut<span class=w> </span>-f<span class=w> </span><span class=m>6</span><span class=w> </span>-d<span class=w> </span><span class=s1>&#39;:&#39;</span><span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=nv>CONTAINERS_CONFIG</span><span class=o>=</span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_HOME</span><span class=si>}</span><span class=s2>&quot;</span>/.config/containers/systemd/
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>CONTAINERS_CONFIG</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>cat<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39; | sudo -iu &quot;${ID_USER}&quot; tee &quot;${CONTAINERS_CONFIG}&quot;/idp-private.network</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=s>[Unit]</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=s>Description=Internal IDP Network Quadlet</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=s>After=network-online.target</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=s>[Network]</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=s>NetworkName=idp-private</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=s>Subnet=192.168.200.0/24</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=s>Gateway=192.168.200.1</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=s>DNS=192.168.200.1</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=s>[Install]</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=s>EOF</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-6-24><a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>idp-private-network.service
</span><span id=__span-6-25><a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>status<span class=w> </span>idp-private-network.service<span class=w> </span>-l<span class=w> </span>--no-pager
</span><span id=__span-6-26><a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>podman<span class=w> </span>network<span class=w> </span>list
</span><span id=__span-6-27><a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a>
</span><span id=__span-6-28><a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=c1># Without NetworkName would be systemd-idp-private</span>
</span><span id=__span-6-29><a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>podman<span class=w> </span>network<span class=w> </span>inspect<span class=w> </span>idp-private
</span></code></pre></div><p>Now let's start adding containers one at a time to the new <code>idp-private</code> network quadlet.</p><h3 id=31-add-caddy-to-the-idp-private-network>3.1 Add Caddy to the idp-private Network<a class=headerlink href=#31-add-caddy-to-the-idp-private-network title="Permanent link">&para;</a></h3><p>Create the Caddy quadlet and add it to the <code>idp-private</code> network quadlet:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=nv>ID_USER</span><span class=o>=</span>identity
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=nv>ID_HOME</span><span class=o>=</span><span class=s2>&quot;</span><span class=k>$(</span>getent<span class=w> </span>passwd<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>cut<span class=w> </span>-f<span class=w> </span><span class=m>6</span><span class=w> </span>-d<span class=w> </span><span class=s1>&#39;:&#39;</span><span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=nv>CONTAINERS_CONFIG</span><span class=o>=</span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_HOME</span><span class=si>}</span><span class=s2>&quot;</span>/.config/containers/systemd/
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>cat<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39; | sudo -iu &quot;${ID_USER}&quot; tee &quot;${CONTAINERS_CONFIG}&quot;/caddy.container</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=s>[Unit]</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=s>Description=Caddy Container</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=s>[Container]</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=s>Image=docker.io/caddy:latest</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=s>ContainerName=caddy</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=s>Volume=/etc/timezone:/etc/timezone:ro</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=s>Volume=/etc/localtime:/etc/localtime:ro</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=s>Network=idp-private</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a><span class=s>IP=192.168.200.10</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=s>DNSSearch=brothaman.org</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=s>AddHost=caddy.brothaman.org:192.168.200.10</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=s>AddHost=keycloak.brothaman.org:192.168.200.20</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=s>AddHost=step-ca.brothaman.org:192.168.200.30</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a><span class=s>[Service]</span>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=s>Restart=always</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a><span class=s>TimeoutStartSec=120</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a><span class=s>StartLimitBurst=5</span>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a><span class=s>RestartSec=10s</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a><span class=s>[Install]</span>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a><span class=s>EOF</span>
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>            </span><span class=se>\</span>
</span><span id=__span-7-31><a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a><span class=w>    </span>--remove<span class=w> </span>--name<span class=w> </span>caddy-data
</span><span id=__span-7-32><a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--name<span class=w> </span>caddy-data<span class=w>               </span><span class=se>\</span>
</span><span id=__span-7-33><a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a><span class=w>    </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>                        </span><span class=se>\</span>
</span><span id=__span-7-34><a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a><span class=w>    </span>--container<span class=w> </span>caddy<span class=w>                           </span><span class=se>\</span>
</span><span id=__span-7-35><a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a><span class=w>    </span>--container-user<span class=w> </span>internal:1000<span class=w>              </span><span class=se>\</span>
</span><span id=__span-7-36><a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a><span class=w>    </span>--container-group<span class=w> </span>internal:1000<span class=w>             </span><span class=se>\</span>
</span><span id=__span-7-37><a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a><span class=w>    </span>--container-path<span class=w> </span>/data
</span><span id=__span-7-38><a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a>
</span><span id=__span-7-39><a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>            </span><span class=se>\</span>
</span><span id=__span-7-40><a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a><span class=w>    </span>--remove<span class=w> </span>--name<span class=w> </span>caddy-config
</span><span id=__span-7-41><a id=__codelineno-7-41 name=__codelineno-7-41 href=#__codelineno-7-41></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--name<span class=w> </span>caddy-config<span class=w>             </span><span class=se>\</span>
</span><span id=__span-7-42><a id=__codelineno-7-42 name=__codelineno-7-42 href=#__codelineno-7-42></a><span class=w>    </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>                        </span><span class=se>\</span>
</span><span id=__span-7-43><a id=__codelineno-7-43 name=__codelineno-7-43 href=#__codelineno-7-43></a><span class=w>    </span>--container<span class=w> </span>caddy<span class=w>                           </span><span class=se>\</span>
</span><span id=__span-7-44><a id=__codelineno-7-44 name=__codelineno-7-44 href=#__codelineno-7-44></a><span class=w>    </span>--container-user<span class=w> </span>internal:1000<span class=w>              </span><span class=se>\</span>
</span><span id=__span-7-45><a id=__codelineno-7-45 name=__codelineno-7-45 href=#__codelineno-7-45></a><span class=w>    </span>--container-group<span class=w> </span>internal:1000<span class=w>             </span><span class=se>\</span>
</span><span id=__span-7-46><a id=__codelineno-7-46 name=__codelineno-7-46 href=#__codelineno-7-46></a><span class=w>    </span>--container-path<span class=w> </span>/config
</span><span id=__span-7-47><a id=__codelineno-7-47 name=__codelineno-7-47 href=#__codelineno-7-47></a>
</span><span id=__span-7-48><a id=__codelineno-7-48 name=__codelineno-7-48 href=#__codelineno-7-48></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>            </span><span class=se>\</span>
</span><span id=__span-7-49><a id=__codelineno-7-49 name=__codelineno-7-49 href=#__codelineno-7-49></a><span class=w>    </span>--remove<span class=w> </span>--name<span class=w> </span>caddy-etc
</span><span id=__span-7-50><a id=__codelineno-7-50 name=__codelineno-7-50 href=#__codelineno-7-50></a>sudo<span class=w> </span>bro-volume<span class=w> </span>--name<span class=w> </span>caddy-etc<span class=w>                </span><span class=se>\</span>
</span><span id=__span-7-51><a id=__codelineno-7-51 name=__codelineno-7-51 href=#__codelineno-7-51></a><span class=w>    </span>--owner<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w>                        </span><span class=se>\</span>
</span><span id=__span-7-52><a id=__codelineno-7-52 name=__codelineno-7-52 href=#__codelineno-7-52></a><span class=w>    </span>--container<span class=w> </span>caddy<span class=w>                           </span><span class=se>\</span>
</span><span id=__span-7-53><a id=__codelineno-7-53 name=__codelineno-7-53 href=#__codelineno-7-53></a><span class=w>    </span>--container-user<span class=w> </span>internal:1000<span class=w>              </span><span class=se>\</span>
</span><span id=__span-7-54><a id=__codelineno-7-54 name=__codelineno-7-54 href=#__codelineno-7-54></a><span class=w>    </span>--container-group<span class=w> </span>internal:1000<span class=w>             </span><span class=se>\</span>
</span><span id=__span-7-55><a id=__codelineno-7-55 name=__codelineno-7-55 href=#__codelineno-7-55></a><span class=w>    </span>--container-path<span class=w> </span>/etc/caddy
</span><span id=__span-7-56><a id=__codelineno-7-56 name=__codelineno-7-56 href=#__codelineno-7-56></a>
</span><span id=__span-7-57><a id=__codelineno-7-57 name=__codelineno-7-57 href=#__codelineno-7-57></a>cat<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39; | sudo -iu &quot;${ID_USER}&quot; tee &quot;${ID_HOME}&quot;/volumes/caddy-etc/Caddyfile</span>
</span><span id=__span-7-58><a id=__codelineno-7-58 name=__codelineno-7-58 href=#__codelineno-7-58></a><span class=s>{</span>
</span><span id=__span-7-59><a id=__codelineno-7-59 name=__codelineno-7-59 href=#__codelineno-7-59></a><span class=s>    http_port 80</span>
</span><span id=__span-7-60><a id=__codelineno-7-60 name=__codelineno-7-60 href=#__codelineno-7-60></a><span class=s>    https_port 443</span>
</span><span id=__span-7-61><a id=__codelineno-7-61 name=__codelineno-7-61 href=#__codelineno-7-61></a>
</span><span id=__span-7-62><a id=__codelineno-7-62 name=__codelineno-7-62 href=#__codelineno-7-62></a><span class=s>    # Global options block</span>
</span><span id=__span-7-63><a id=__codelineno-7-63 name=__codelineno-7-63 href=#__codelineno-7-63></a><span class=s>    email admin@identity.brothaman.org</span>
</span><span id=__span-7-64><a id=__codelineno-7-64 name=__codelineno-7-64 href=#__codelineno-7-64></a><span class=s>}</span>
</span><span id=__span-7-65><a id=__codelineno-7-65 name=__codelineno-7-65 href=#__codelineno-7-65></a>
</span><span id=__span-7-66><a id=__codelineno-7-66 name=__codelineno-7-66 href=#__codelineno-7-66></a><span class=s>identity.brothaman.org {</span>
</span><span id=__span-7-67><a id=__codelineno-7-67 name=__codelineno-7-67 href=#__codelineno-7-67></a><span class=s>    # For now just return a simple page</span>
</span><span id=__span-7-68><a id=__codelineno-7-68 name=__codelineno-7-68 href=#__codelineno-7-68></a><span class=s>    tls internal</span>
</span><span id=__span-7-69><a id=__codelineno-7-69 name=__codelineno-7-69 href=#__codelineno-7-69></a><span class=s>    respond &lt;&lt;EOHTML</span>
</span><span id=__span-7-70><a id=__codelineno-7-70 name=__codelineno-7-70 href=#__codelineno-7-70></a><span class=s>Hello from Caddy over HTTPS</span>
</span><span id=__span-7-71><a id=__codelineno-7-71 name=__codelineno-7-71 href=#__codelineno-7-71></a>
</span><span id=__span-7-72><a id=__codelineno-7-72 name=__codelineno-7-72 href=#__codelineno-7-72></a><span class=s>EOHTML</span>
</span><span id=__span-7-73><a id=__codelineno-7-73 name=__codelineno-7-73 href=#__codelineno-7-73></a><span class=s>}</span>
</span><span id=__span-7-74><a id=__codelineno-7-74 name=__codelineno-7-74 href=#__codelineno-7-74></a><span class=s>EOF</span>
</span><span id=__span-7-75><a id=__codelineno-7-75 name=__codelineno-7-75 href=#__codelineno-7-75></a>
</span><span id=__span-7-76><a id=__codelineno-7-76 name=__codelineno-7-76 href=#__codelineno-7-76></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>bro-activator<span class=w> </span>--remove<span class=w>    </span><span class=se>\</span>
</span><span id=__span-7-77><a id=__codelineno-7-77 name=__codelineno-7-77 href=#__codelineno-7-77></a><span class=w>    </span>--name<span class=w> </span>caddy<span class=w> </span>--service-name<span class=w> </span>http
</span><span id=__span-7-78><a id=__codelineno-7-78 name=__codelineno-7-78 href=#__codelineno-7-78></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>bro-activator<span class=w>             </span><span class=se>\</span>
</span><span id=__span-7-79><a id=__codelineno-7-79 name=__codelineno-7-79 href=#__codelineno-7-79></a><span class=w>    </span>--name<span class=w> </span>caddy<span class=w>                                </span><span class=se>\</span>
</span><span id=__span-7-80><a id=__codelineno-7-80 name=__codelineno-7-80 href=#__codelineno-7-80></a><span class=w>    </span>--service-name<span class=w> </span>http<span class=w>                         </span><span class=se>\</span>
</span><span id=__span-7-81><a id=__codelineno-7-81 name=__codelineno-7-81 href=#__codelineno-7-81></a><span class=w>    </span>--external-port<span class=w> </span><span class=m>0</span>.0.0.0:8080<span class=w>                </span><span class=se>\</span>
</span><span id=__span-7-82><a id=__codelineno-7-82 name=__codelineno-7-82 href=#__codelineno-7-82></a><span class=w>    </span>--internal-port<span class=w> </span><span class=m>127</span>.0.0.1:80
</span><span id=__span-7-83><a id=__codelineno-7-83 name=__codelineno-7-83 href=#__codelineno-7-83></a>
</span><span id=__span-7-84><a id=__codelineno-7-84 name=__codelineno-7-84 href=#__codelineno-7-84></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>bro-activator<span class=w> </span>--remove<span class=w>    </span><span class=se>\</span>
</span><span id=__span-7-85><a id=__codelineno-7-85 name=__codelineno-7-85 href=#__codelineno-7-85></a><span class=w>    </span>--name<span class=w> </span>caddy<span class=w> </span>--service-name<span class=w> </span>https
</span><span id=__span-7-86><a id=__codelineno-7-86 name=__codelineno-7-86 href=#__codelineno-7-86></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>bro-activator<span class=w>             </span><span class=se>\</span>
</span><span id=__span-7-87><a id=__codelineno-7-87 name=__codelineno-7-87 href=#__codelineno-7-87></a><span class=w>    </span>--name<span class=w> </span>caddy<span class=w>                                </span><span class=se>\</span>
</span><span id=__span-7-88><a id=__codelineno-7-88 name=__codelineno-7-88 href=#__codelineno-7-88></a><span class=w>    </span>--service-name<span class=w> </span>https<span class=w>                        </span><span class=se>\</span>
</span><span id=__span-7-89><a id=__codelineno-7-89 name=__codelineno-7-89 href=#__codelineno-7-89></a><span class=w>    </span>--external-port<span class=w> </span><span class=m>0</span>.0.0.0:8443<span class=w>                </span><span class=se>\</span>
</span><span id=__span-7-90><a id=__codelineno-7-90 name=__codelineno-7-90 href=#__codelineno-7-90></a><span class=w>    </span>--internal-port<span class=w> </span><span class=m>127</span>.0.0.1:443
</span><span id=__span-7-91><a id=__codelineno-7-91 name=__codelineno-7-91 href=#__codelineno-7-91></a>
</span><span id=__span-7-92><a id=__codelineno-7-92 name=__codelineno-7-92 href=#__codelineno-7-92></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-7-93><a id=__codelineno-7-93 name=__codelineno-7-93 href=#__codelineno-7-93></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span><span class=nb>enable</span><span class=w>   </span><span class=se>\</span>
</span><span id=__span-7-94><a id=__codelineno-7-94 name=__codelineno-7-94 href=#__codelineno-7-94></a><span class=w>    </span>--now<span class=w> </span>caddy-http-activator.socket
</span><span id=__span-7-95><a id=__codelineno-7-95 name=__codelineno-7-95 href=#__codelineno-7-95></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span><span class=nb>enable</span><span class=w>   </span><span class=se>\</span>
</span><span id=__span-7-96><a id=__codelineno-7-96 name=__codelineno-7-96 href=#__codelineno-7-96></a><span class=w>    </span>--now<span class=w> </span>caddy-https-activator.socket
</span></code></pre></div><p>The Caddy container image by default runs the Caddy process privileged within it so it can bind to ports below 1024. However, since we're running the container unprivileged in Podman, the activator proxy cannot bind to privileged ports. Therefore, we configure the activator sockets to listen on unprivileged ports 8080 and 8443 on all the host's interfaces and map them to Caddy's internal listening ports 80 and 443 respectively.</p><p>Later we will add firewall rules to the VM as root to map privileged ports 80 and 443 to the unprivileged ports 8080 and 8443 respectively. This seems a bit roundabout: Caddy inside the container binds to 80 and 443, the activator proxies bind to 8080 and 8443 on the host, and eventually as you will see firewall rules we will add to the vm will maps 80 and 443 to 8080 and 8443 on the host. Yes, this feels like we're scratching the left year with our right hand but it's the only way to get around the privileged port binding restriction when running unprivileged containers. The same would occur using the PublishPort directive in Docker/Podman.</p><h4 id=verify-idp-private-network-gateway-connectivity>Verify idp-private Network Gateway Connectivity<a class=headerlink href=#verify-idp-private-network-gateway-connectivity title="Permanent link">&para;</a></h4><p>Now after putting the first container into the new idp-private network you should be able to ping the gateway and see the network interfaces from within the unprivileged user's podman unshare rootless network namespace. Try this as the <code>vagrant</code> user:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>podman<span class=w> </span>unshare<span class=w> </span>--rootless-netns<span class=w> </span>ip<span class=w> </span>addr<span class=w> </span>show
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>podman<span class=w> </span>unshare<span class=w> </span>--rootless-netns<span class=w> </span>/usr/sbin/brctl<span class=w> </span>show
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=k>if</span><span class=w> </span>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>podman<span class=w> </span>unshare<span class=w> </span>--rootless-netns<span class=w> </span>ping<span class=w> </span>-W<span class=w> </span><span class=m>0</span>.5<span class=w> </span>-c<span class=w> </span><span class=m>1</span><span class=w> </span><span class=m>192</span>.168.200.1<span class=w> </span>&gt;<span class=w> </span>/dev/null<span class=p>;</span><span class=w> </span><span class=k>then</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=w>    </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;Ping to gateway 192.168.200.1 successful&quot;</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=k>else</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>    </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;Ping to gateway 192.168.200.1 failed&quot;</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=k>fi</span>
</span></code></pre></div><h4 id=verify-caddy-access-via-activator-sockets>Verify Caddy Access via Activator Sockets<a class=headerlink href=#verify-caddy-access-via-activator-sockets title="Permanent link">&para;</a></h4><p>Let's also verify that Caddy can be accessed via its activator sockets:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=nv>ip</span><span class=o>=</span><span class=k>$(</span>ip<span class=w> </span>-o<span class=w> </span>-4<span class=w> </span>addr<span class=w> </span>show<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span>show<span class=w> </span>default<span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;/default/ {print $5}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{split($4,a,&quot;/&quot;); print a[1]; exit}&#39;</span><span class=k>)</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;</span><span class=nv>$ip</span><span class=s2> identity.brothaman.org&quot;</span><span class=w> </span><span class=c1># | sudo tee -a /etc/hosts</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>curl<span class=w> </span>-k<span class=w> </span>--resolve<span class=w> </span>identity.brothaman.org:8443:<span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=w> </span>https://identity.brothaman.org:8443
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>curl<span class=w> </span>-v<span class=w> </span>--resolve<span class=w> </span>identity.brothaman.org:8080:<span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=w> </span>http://identity.brothaman.org:8080
</span></code></pre></div><p>Notice the commands in the snippet above use curl's <code>--resolve</code> flag to override DNS resolution for the test. We grab the interface from the default rote, extract its ipv4 address, and use that to resolve the hostname to the correct IP address. You can also add an entry to your desktop's <code>/etc/hosts</code> file for easier access. Just uncomment the pipe at the end of the echo line in the snippet above.</p><p>Also notice the use of the <code>-k</code> flag in the first curl line to skip TLS certificate verification since Caddy is using a self-signed internal CA certificate for TLS termination. Try removing it and you'll see this output:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>vagrant@debian12:~$<span class=w> </span>curl<span class=w> </span>--resolve<span class=w> </span>identity.brothaman.org:8443:<span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=w> </span>https://identity.brothaman.org:8443
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>curl:<span class=w> </span><span class=o>(</span><span class=m>60</span><span class=o>)</span><span class=w> </span>SSL<span class=w> </span>certificate<span class=w> </span>problem:<span class=w> </span>unable<span class=w> </span>to<span class=w> </span>get<span class=w> </span><span class=nb>local</span><span class=w> </span>issuer<span class=w> </span>certificate
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>More<span class=w> </span>details<span class=w> </span>here:<span class=w> </span>https://curl.se/docs/sslcerts.html
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>curl<span class=w> </span>failed<span class=w> </span>to<span class=w> </span>verify<span class=w> </span>the<span class=w> </span>legitimacy<span class=w> </span>of<span class=w> </span>the<span class=w> </span>server<span class=w> </span>and<span class=w> </span>therefore<span class=w> </span>could<span class=w> </span>not
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>establish<span class=w> </span>a<span class=w> </span>secure<span class=w> </span>connection<span class=w> </span>to<span class=w> </span>it.<span class=w> </span>To<span class=w> </span>learn<span class=w> </span>more<span class=w> </span>about<span class=w> </span>this<span class=w> </span>situation<span class=w> </span>and
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>how<span class=w> </span>to<span class=w> </span>fix<span class=w> </span>it,<span class=w> </span>please<span class=w> </span>visit<span class=w> </span>the<span class=w> </span>web<span class=w> </span>page<span class=w> </span>mentioned<span class=w> </span>above.
</span></code></pre></div><p>The certificate verification fails because the self-signed internal CA certificate is not trusted by default. You can add the CA certificate to your desktop's trusted certificate store to fix this.</p><p>Also notice the output of the second command:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>vagrant@debian12:~$<span class=w> </span>curl<span class=w> </span>-v<span class=w> </span>--resolve<span class=w> </span>identity.brothaman.org:8080:<span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=w> </span>http://identity.brothaman.org:8080
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>*<span class=w> </span>Added<span class=w> </span>identity.brothaman.org:8080:192.168.122.40<span class=w> </span>to<span class=w> </span>DNS<span class=w> </span>cache
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>*<span class=w> </span>Hostname<span class=w> </span>identity.brothaman.org<span class=w> </span>was<span class=w> </span>found<span class=w> </span><span class=k>in</span><span class=w> </span>DNS<span class=w> </span>cache
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>*<span class=w>   </span>Trying<span class=w> </span><span class=m>192</span>.168.122.40:8080...
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>*<span class=w> </span>Connected<span class=w> </span>to<span class=w> </span>identity.brothaman.org<span class=w> </span><span class=o>(</span><span class=m>192</span>.168.122.40<span class=o>)</span><span class=w> </span>port<span class=w> </span><span class=m>8080</span><span class=w> </span><span class=o>(</span><span class=c1>#0)</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>&gt;<span class=w> </span>GET<span class=w> </span>/<span class=w> </span>HTTP/1.1
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>&gt;<span class=w> </span>Host:<span class=w> </span>identity.brothaman.org:8080
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>&gt;<span class=w> </span>User-Agent:<span class=w> </span>curl/7.88.1
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>&gt;<span class=w> </span>Accept:<span class=w> </span>*/*
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>&gt;
</span></code></pre></div><p>If you ran this without the <code>-v</code> flag curl wouldn't print the extra verbose output because it completed successfully with a redirect HTTP code 308 returned by Caddy. The client, curl, is told to go to port 443 for HTTPS. You can see this by swapping the <code>-v</code> with <code>-L</code> flag to curl to follow redirects:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>vagrant@debian12:~$<span class=w> </span>curl<span class=w> </span>-L<span class=w> </span>--resolve<span class=w> </span>identity.brothaman.org:8080:<span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=w> </span>http://identity.brothaman.org:8080
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>curl:<span class=w> </span><span class=o>(</span><span class=m>7</span><span class=o>)</span><span class=w> </span>Failed<span class=w> </span>to<span class=w> </span>connect<span class=w> </span>to<span class=w> </span>identity.brothaman.org<span class=w> </span>port<span class=w> </span><span class=m>443</span><span class=w> </span>after<span class=w> </span><span class=m>1</span><span class=w> </span>ms:<span class=w> </span>Couldn<span class=err>&#39;</span>t<span class=w> </span>connect<span class=w> </span>to<span class=w> </span>server
</span></code></pre></div><p>So the redirected request fails because port 443 is not open on the host. This is expected since we have not yet configured firewall rules to map privileged port 443 to Caddy's listening port 8443. We'll do that next.</p><h3 id=32-configure-ca-trust-and-firewall-rules>3.2 Configure CA Trust and Firewall Rules<a class=headerlink href=#32-configure-ca-trust-and-firewall-rules title="Permanent link">&para;</a></h3><p>Time for some finishing touches. We will setup firewall rules in the VM to map privileged ports 80 and 443 to Caddy's unprivileged listening ports 8080 and 8443 respectively. We will also extract Caddy's internal CA certificate and add it to the VM host's trusted certificate store so that clients can trust certificates issued by step-ca.</p><h4 id=configure-firewall-rules>Configure Firewall Rules<a class=headerlink href=#configure-firewall-rules title="Permanent link">&para;</a></h4><p>Now let's configure firewall rules to map privileged ports 80 and 443 to Caddy's activator listening ports 8080 and 8443 respectively. Run the following commands as the <code>vagrant</code> user:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>cat<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39; | sudo tee -a /etc/nftables.conf</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=s># Caddy HTTP and HTTPS privileged to unprivileged port forwarding</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=s>table ip nat {</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=s>    chain prerouting {</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=s>        type nat hook prerouting priority -100;</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=s>        tcp dport 80  redirect to :8080</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=s>        tcp dport 443 redirect to :8443</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=s>    }</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=s>    chain output {</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=s>        type nat hook output priority -100;</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=s>        tcp dport 80  redirect to :8080</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=s>        tcp dport 443 redirect to :8443</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=s>    }</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=s>    chain postrouting {</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=s>        type nat hook postrouting priority 100;</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=s>    }</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=s>}</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=s>EOF</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a>sudo<span class=w> </span>nft<span class=w> </span>-f<span class=w> </span>/etc/nftables.conf
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a>sudo<span class=w> </span>nft<span class=w> </span>list<span class=w> </span>ruleset
</span></code></pre></div><p>The first prerouting chain handles incoming connections from external sources. The output chain handles locally generated connections from the host itself. The postrouting chain is empty for now but could be used later for source NAT if needed. So far so good. Now let's verify that Caddy is accessible via the standard privileged ports 80 and 443:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=c1># First hitting HTTP on port 8080 redirected but internally with output chain to HTTPS on port 443</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>curl<span class=w> </span>-v<span class=w> </span>-k<span class=w> </span>-L<span class=w> </span>--resolve<span class=w> </span>identity.brothaman.org:8080:<span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=w> </span>http://identity.brothaman.org:8080
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=c1># Directly hit HTTPS 443 with no HTTP redirect needed but 443 -&gt; 8443 thanks to prerouting chain</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>curl<span class=w> </span>-v<span class=w> </span>-k<span class=w> </span>--resolve<span class=w> </span>identity.brothaman.org:443:<span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=w> </span>https://identity.brothaman.org
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=c1># First hits HTTP 80 and redirected to 443 -&gt; 8443 but internally by output chain to HTTPS on port 443</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a>curl<span class=w> </span>-v<span class=w> </span>-k<span class=w> </span>-L<span class=w> </span>--resolve<span class=w> </span>identity.brothaman.org:443:<span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=w> </span>http://identity.brothaman.org
</span></code></pre></div><p>From outside you can hit it like so as long as you set that <code>${ip}</code> variable to your VM's external IP address:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1># ip=&lt;your-vm-ip-address&gt;</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>curl<span class=w> </span>-v<span class=w> </span>-k<span class=w> </span>-L<span class=w>   </span>--resolve<span class=w> </span>identity.brothaman.org:80:<span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=w>   </span><span class=se>\</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=w>                </span>--resolve<span class=w> </span>identity.brothaman.org:443:<span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=w>  </span><span class=se>\</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>                </span>http://identity.brothaman.org
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>curl<span class=w> </span>-v<span class=w> </span>-k<span class=w> </span>--resolve<span class=w> </span>identity.brothaman.org:443:<span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=w>       </span><span class=se>\</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=w>                </span>https://identity.brothaman.org
</span></code></pre></div><h4 id=extract-and-trust-caddys-internal-ca-certificate>Extract and Trust Caddy's Internal CA Certificate<a class=headerlink href=#extract-and-trust-caddys-internal-ca-certificate title="Permanent link">&para;</a></h4><p>Now let's extract Caddy's internal CA certificate and add it to the VM host's trusted certificate store so that clients can trust certificates issued by Caddy. While at it we will also add <code>identity.brothaman.org</code> to the <code>/etc/hosts</code> file. Run the following commands as the <code>vagrant</code> user:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>ls<span class=w> </span>-l<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_HOME</span><span class=si>}</span><span class=s2>&quot;</span>/volumes/caddy-data/caddy/pki/authorities/local/
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>cp<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_HOME</span><span class=si>}</span><span class=s2>&quot;</span>/volumes/caddy-data/caddy/pki/authorities/local/root.crt<span class=w> </span>/usr/local/share/ca-certificates/caddy-internal.crt
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>sudo<span class=w> </span>update-ca-certificates
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=k>if</span><span class=w> </span>grep<span class=w> </span>-q<span class=w> </span><span class=s2>&quot;identity.brothaman.org&quot;</span><span class=w> </span>/etc/hosts<span class=p>;</span><span class=w> </span><span class=k>then</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=w>    </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;Entry for identity.brothaman.org already exists in /etc/hosts&quot;</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=k>else</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=w>    </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;Adding entry for identity.brothaman.org to /etc/hosts&quot;</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>    </span><span class=nv>ip</span><span class=o>=</span><span class=k>$(</span>ip<span class=w> </span>-o<span class=w> </span>-4<span class=w> </span>addr<span class=w> </span>show<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>ip<span class=w> </span>route<span class=w> </span>show<span class=w> </span>default<span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;/default/ {print $5}&#39;</span><span class=k>)</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{split($4,a,&quot;/&quot;); print a[1]; exit}&#39;</span><span class=k>)</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>    </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ip</span><span class=si>}</span><span class=s2> identity.brothaman.org&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>sudo<span class=w> </span>tee<span class=w> </span>-a<span class=w> </span>/etc/hosts
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=k>fi</span>
</span></code></pre></div><p>The <code>-k</code> flag is no longer needed when accessing Caddy since the CA certificate is now trusted. Furthermore the <code>/etc/hosts</code> entry allows easy access without needing to use curl's <code>--resolve</code> flag:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>curl<span class=w> </span>-L<span class=w> </span>http://identity.brothaman.org
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>curl<span class=w> </span>https://identity.brothaman.org
</span></code></pre></div><p>The HTTP request will be redirected to HTTPS automatically by Caddy so we still need curl's <code>-L</code> flag to follow redirects. Besides that everything else inside the VM works seamlessly with the least amount of flags. Browsers as well as curl will now also trust certificates issued by Caddy's internal CA. You can do the same for client desktop systems by adding the CA certificate to their trusted certificate stores.</p><h4 id=security-considerations>Security Considerations<a class=headerlink href=#security-considerations title="Permanent link">&para;</a></h4><p>You just saw us copy Caddy's internal CA certificate's public key out of its container volume to the VM host's trusted certificate store. We also mentioned that it can be copied to other clients to trust Caddy proxied servers. Is this safe? Yes it is.</p><p>The caddy-root.crt file extracted above is the public CA certificate only. The private key remains securely stored inside the Caddy container volume and is not exposed. Only the public CA certificate is needed to establish trust. By itself the public key can't be used to sign anything; an attacker would also need the matching private key (<code>root.key</code> inside /data/caddy/pki/). That private key stays on the Caddy host, and that's what must be protected like any other CA key.</p><p>However, you did see the private key there in the caddy-data volume right? Yes, but only because you have access to the host system as root. An attacker who compromises the host as root can always extract the private key from the container volume. Therefore, protecting the host system is paramount. If an attacker has root access to the host, all bets are off anyway.</p><h4 id=certificate-mitigations>Certificate Mitigations<a class=headerlink href=#certificate-mitigations title="Permanent link">&para;</a></h4><p>You can further mitigate the risk of private key compromise by using step-ca to issue short lived intermediate certificates for Caddy instead of using its internal CA. You can configure step-ca to issue intermediate certificates with short lifetimes (e.g., hours or days) to Caddy for TLS termination. step-ca also provides all the infrastructure to automate certificate public key rotation and renewal.</p><ul><li><p><strong>Separation of duties</strong>: Caddy no longer holds the root/intermediate private keys. Step-ca issues the certs; Caddy just requests them. Compromising the reverse proxy doesn't compromise the CA.</p></li><li><p><strong>Central revocation/rotation</strong>: step-ca maintains cert inventory and CRLs/OCSP. You can revoke a cert or intermediate, rotate keys on a schedule, and push new trust anchors out via config management. With Caddy's internal CA you'd have to manually copy/replace files and there's no revocation story.</p></li><li><p><strong>Delegation and policy</strong>: step-ca can issue different intermediates for different purposes (e.g., one for Caddy, one for other services), enforce lifetimes, require client auth, or integrate ACME endpoints for automation. Caddy can point its acme_server at step-ca so issuance still feels automatic but you keep control.</p></li><li><p><strong>Client trust management</strong>: If clients already trust your org's CA hierarchy (via step-ca), Caddy gets its certs from that chain and users don't need to install yet another root. If something goes wrong you invalidate the affected intermediates centrally, instead of touching every Caddy host.</p></li></ul><p>This way even if Caddy's private root key is compromised the damage is limited to the certificate's short lifetime. You can also implement key rotation policies to periodically change the private key and re-issue certificates. This further limits the window of opportunity for an attacker.</p><p>So yes: letting step-ca be the authority and Caddy just an ACME/renewal client gives you revocation, auditing, centralized policy, and confines the CA keys to one place. It's the usual don't mix your application and CA roles benefit.</p><h4 id=additional-security-considerations>Additional Security Considerations<a class=headerlink href=#additional-security-considerations title="Permanent link">&para;</a></h4><p>This all sounds good but both Caddy and step-ca containers co-located in the same unprivileged identity user account makes these suggestions seem somewhat moot. If the root or identity accounts are compromised, both containers are compromised. Plus, if I compromise Caddy's private key, I can spoof proxied applications without access to the step-ca root key.</p><p>So if you want to go robust, run step-ca in its own unprivileged user account separate from Caddy. This way compromising Caddy does not compromise step-ca, You might even want step-ca running on a separate ultra hardened host dedicated only to step-ca altogether. This adds complexity and management overhead but increases security. However, for many home lab use cases running both Caddy and step-ca in the same unprivileged user account is acceptable.</p><p>Another option is to protect step-ca's private key using hardware security modules (HSMs), TPMs or secure enclaves that provide an additional layer of security. This way even if the host is compromised, the private key remains protected within the HSM, TPM, or enclave. The applications proxied by Caddy can only be spoofed for a brief period of time (until the next rotation) if an attacker compromises Caddy's private key. Furthermore, if step-ca is using a hardware-backed key, the attacker cannot issue new certificates without access to the hardware module.</p><p>TPMs are ubiquitous in modern hardware and provide a cost effective way to protect private keys. They are widely supported by operating systems and software, including Smallstep's step-ca.</p><p>Step-ca can use a TPM-backed key for its root or intermediate CA. On Linux you can point step-ca at a PKCS#11 provider for the TPM (e.g., pkcs11uri pointing to the key handle) and configure the CA with that signer, or use Smallstep's experimental TPM engine to store the key in the TPM and have step-ca use it at startup. The net effect is the same: the private key never leaves the TPM, giving you hardware-backed protection for your CA root. Smallstep's docs cover both PKCS#11 and TPM drivers if you want to wire it up.</p><p>Here are the most helpful references for TPM-backed roots with Smallstep:</p><ul><li>Smallstep Docs - <a href=https://smallstep.com/docs/step-ca/configuration/#tpm-and-pkcs11>TPM Attestation &amp; Keys</a> (covers configuring step-ca with TPM-backed private keys and attestation)</li><li>step-ca + <a href=https://smallstep.com/docs/tutorials/hsm-pkcs11/ >PKCS#11 guide</a> (how to point step-ca at a hardware-backed key, including TPM modules)</li><li><a href=https://smallstep.com/blog/tpm-support-step-ca/ >TPM integration announcement</a> (overview of TPM support in Smallstep, with examples)</li><li><a href=https://smallstep.com/blog/using-tpm-to-protect-ca-keys/ >Using a TPM to protect your CA keys</a> (detailed walkthrough of using TPMs with step-ca)</li></ul><p>Those walk through generating a key inside the TPM, referencing it via PKCS#11 in ca.json, and the trade-offs between storing the root vs. an intermediate in hardware.</p><h3 id=33-add-the-step-ca-quadlet-to-the-idp-private-network>3.3 Add the step-ca quadlet to the idp-private Network<a class=headerlink href=#33-add-the-step-ca-quadlet-to-the-idp-private-network title="Permanent link">&para;</a></h3><p>Add the step-ca quadlet and add it to the <code>idp-private</code> network quadlet:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=nv>ID_USER</span><span class=o>=</span>identity
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=nv>ID_HOME</span><span class=o>=</span><span class=s2>&quot;</span><span class=k>$(</span>getent<span class=w> </span>passwd<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>cut<span class=w> </span>-f<span class=w> </span><span class=m>6</span><span class=w> </span>-d<span class=w> </span><span class=s1>&#39;:&#39;</span><span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=nv>CONTAINERS_CONFIG</span><span class=o>=</span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_HOME</span><span class=si>}</span><span class=s2>&quot;</span>/.config/containers/systemd/
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>cat<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39; | sudo -iu &quot;${ID_USER}&quot; tee &quot;${CONTAINERS_CONFIG}&quot;/step-ca.container</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=s>[Unit]</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=s>Description=Step-CA Container</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=s>[Container]</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=s>Image=docker.io/smallstep/step-ca:latest</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=s>ContainerName=step-ca</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=s>Environment=DOCKER_STEPCA_INIT_NAME=Smallstep</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=s>Environment=DOCKER_STEPCA_INIT_DNS_NAMES=localhost,brothaman.org</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=s>Environment=DOCKER_STEPCA_INIT_REMOTE_MANAGEMENT=true</span>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a>
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=s>Environment=DOCKER_STEPCA_INIT_REMOTE_MANAGEMENT=true</span>
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=s>Environment=DOCKER_STEPCA_INIT_PROVISIONER_TYPE=admin</span>
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=s>Environment=DOCKER_STEPCA_INIT_SSH=true</span>
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=s>Environment=DOCKER_STEPCA_INIT_ACME=true</span>
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=s># Environment=DOCKER_STEPCA_INIT_PASSWORD_FILE=/run/secrets/stepca_password</span>
</span><span id=__span-18-21><a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a><span class=s>Environment=DOCKER_STEPCA_INIT_PASSWORD=password</span>
</span><span id=__span-18-22><a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a>
</span><span id=__span-18-23><a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a><span class=s>Volume=/etc/timezone:/etc/timezone:ro</span>
</span><span id=__span-18-24><a id=__codelineno-18-24 name=__codelineno-18-24 href=#__codelineno-18-24></a><span class=s>Volume=/etc/localtime:/etc/localtime:ro</span>
</span><span id=__span-18-25><a id=__codelineno-18-25 name=__codelineno-18-25 href=#__codelineno-18-25></a>
</span><span id=__span-18-26><a id=__codelineno-18-26 name=__codelineno-18-26 href=#__codelineno-18-26></a><span class=s>Network=idp-private</span>
</span><span id=__span-18-27><a id=__codelineno-18-27 name=__codelineno-18-27 href=#__codelineno-18-27></a><span class=s>DNSSearch=brothaman.org</span>
</span><span id=__span-18-28><a id=__codelineno-18-28 name=__codelineno-18-28 href=#__codelineno-18-28></a><span class=s>IP=192.168.200.30</span>
</span><span id=__span-18-29><a id=__codelineno-18-29 name=__codelineno-18-29 href=#__codelineno-18-29></a><span class=s>AddHost=caddy.brothaman.org:192.168.200.10</span>
</span><span id=__span-18-30><a id=__codelineno-18-30 name=__codelineno-18-30 href=#__codelineno-18-30></a><span class=s>AddHost=keycloak.brothaman.org:192.168.200.20</span>
</span><span id=__span-18-31><a id=__codelineno-18-31 name=__codelineno-18-31 href=#__codelineno-18-31></a><span class=s>AddHost=step-ca.brothaman.org:192.168.200.30</span>
</span><span id=__span-18-32><a id=__codelineno-18-32 name=__codelineno-18-32 href=#__codelineno-18-32></a>
</span><span id=__span-18-33><a id=__codelineno-18-33 name=__codelineno-18-33 href=#__codelineno-18-33></a><span class=s>[Service]</span>
</span><span id=__span-18-34><a id=__codelineno-18-34 name=__codelineno-18-34 href=#__codelineno-18-34></a><span class=s>Restart=always</span>
</span><span id=__span-18-35><a id=__codelineno-18-35 name=__codelineno-18-35 href=#__codelineno-18-35></a><span class=s>TimeoutStartSec=120</span>
</span><span id=__span-18-36><a id=__codelineno-18-36 name=__codelineno-18-36 href=#__codelineno-18-36></a><span class=s>StartLimitBurst=5</span>
</span><span id=__span-18-37><a id=__codelineno-18-37 name=__codelineno-18-37 href=#__codelineno-18-37></a><span class=s>RestartSec=10s</span>
</span><span id=__span-18-38><a id=__codelineno-18-38 name=__codelineno-18-38 href=#__codelineno-18-38></a>
</span><span id=__span-18-39><a id=__codelineno-18-39 name=__codelineno-18-39 href=#__codelineno-18-39></a><span class=s>[Install]</span>
</span><span id=__span-18-40><a id=__codelineno-18-40 name=__codelineno-18-40 href=#__codelineno-18-40></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-18-41><a id=__codelineno-18-41 name=__codelineno-18-41 href=#__codelineno-18-41></a><span class=s>EOF</span>
</span><span id=__span-18-42><a id=__codelineno-18-42 name=__codelineno-18-42 href=#__codelineno-18-42></a>
</span><span id=__span-18-43><a id=__codelineno-18-43 name=__codelineno-18-43 href=#__codelineno-18-43></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>bro-activator<span class=w>             </span><span class=se>\</span>
</span><span id=__span-18-44><a id=__codelineno-18-44 name=__codelineno-18-44 href=#__codelineno-18-44></a><span class=w>    </span>--name<span class=w> </span>step-ca<span class=w>                              </span><span class=se>\</span>
</span><span id=__span-18-45><a id=__codelineno-18-45 name=__codelineno-18-45 href=#__codelineno-18-45></a><span class=w>    </span>--service-name<span class=w> </span>http<span class=w>                         </span><span class=se>\</span>
</span><span id=__span-18-46><a id=__codelineno-18-46 name=__codelineno-18-46 href=#__codelineno-18-46></a><span class=w>    </span>--external-port<span class=w> </span><span class=m>0</span>.0.0.0:9000<span class=w>                </span><span class=se>\</span>
</span><span id=__span-18-47><a id=__codelineno-18-47 name=__codelineno-18-47 href=#__codelineno-18-47></a><span class=w>    </span>--internal-port<span class=w> </span><span class=m>127</span>.0.0.1:9000
</span><span id=__span-18-48><a id=__codelineno-18-48 name=__codelineno-18-48 href=#__codelineno-18-48></a>
</span><span id=__span-18-49><a id=__codelineno-18-49 name=__codelineno-18-49 href=#__codelineno-18-49></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-18-50><a id=__codelineno-18-50 name=__codelineno-18-50 href=#__codelineno-18-50></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>step-ca-http-activator.service
</span></code></pre></div><h3 id=34-add-the-keycloak-quadlet-to-the-idp-private-network>3.4 Add the Keycloak quadlet to the idp-private Network<a class=headerlink href=#34-add-the-keycloak-quadlet-to-the-idp-private-network title="Permanent link">&para;</a></h3><p>Add the Keycloak quadlet and add it to the <code>idp-private</code> network quadlet:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>cat<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39; | sudo -iu &quot;${ID_USER}&quot; tee &quot;${CONTAINERS_CONFIG}&quot;/keycloak.container</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=s>[Unit]</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=s>Description=Keycloak Container</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=s>[Container]</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=s>#Image=quay.io/keycloak/keycloak:26.4.5</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=s>Image=keycloak/keycloak:26.4</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=s>ContainerName=keycloak</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=s>Exec=start-dev</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=s>Volume=/etc/timezone:/etc/timezone:ro</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=s>Volume=/etc/localtime:/etc/localtime:ro</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=s>IP=192.168.200.20</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=s>DNSSearch=brothaman.org</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a><span class=s>AddHost=caddy.brothaman.org:192.168.200.10</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a><span class=s>AddHost=keycloak.brothaman.org:192.168.200.20</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=s>AddHost=step-ca.brothaman.org:192.168.200.30</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a><span class=s>Network=idp-private</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a><span class=s>[Service]</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a><span class=s>Environment=KC_BOOTSTRAP_ADMIN_USERNAME=admin</span>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21 href=#__codelineno-19-21></a><span class=s>Environment=KC_BOOTSTRAP_ADMIN_PASSWORD=password</span>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22 href=#__codelineno-19-22></a><span class=s>Restart=always</span>
</span><span id=__span-19-23><a id=__codelineno-19-23 name=__codelineno-19-23 href=#__codelineno-19-23></a><span class=s>TimeoutStartSec=120</span>
</span><span id=__span-19-24><a id=__codelineno-19-24 name=__codelineno-19-24 href=#__codelineno-19-24></a><span class=s>StartLimitBurst=5</span>
</span><span id=__span-19-25><a id=__codelineno-19-25 name=__codelineno-19-25 href=#__codelineno-19-25></a><span class=s>RestartSec=10s</span>
</span><span id=__span-19-26><a id=__codelineno-19-26 name=__codelineno-19-26 href=#__codelineno-19-26></a>
</span><span id=__span-19-27><a id=__codelineno-19-27 name=__codelineno-19-27 href=#__codelineno-19-27></a><span class=s>[Install]</span>
</span><span id=__span-19-28><a id=__codelineno-19-28 name=__codelineno-19-28 href=#__codelineno-19-28></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-19-29><a id=__codelineno-19-29 name=__codelineno-19-29 href=#__codelineno-19-29></a><span class=s>EOF</span>
</span><span id=__span-19-30><a id=__codelineno-19-30 name=__codelineno-19-30 href=#__codelineno-19-30></a>
</span><span id=__span-19-31><a id=__codelineno-19-31 name=__codelineno-19-31 href=#__codelineno-19-31></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>bro-activator<span class=w>             </span><span class=se>\</span>
</span><span id=__span-19-32><a id=__codelineno-19-32 name=__codelineno-19-32 href=#__codelineno-19-32></a><span class=w>    </span>--name<span class=w> </span>keycloak<span class=w>                             </span><span class=se>\</span>
</span><span id=__span-19-33><a id=__codelineno-19-33 name=__codelineno-19-33 href=#__codelineno-19-33></a><span class=w>    </span>--service-name<span class=w> </span>http<span class=w>                         </span><span class=se>\</span>
</span><span id=__span-19-34><a id=__codelineno-19-34 name=__codelineno-19-34 href=#__codelineno-19-34></a><span class=w>    </span>--external-port<span class=w> </span><span class=m>0</span>.0.0.0:8081<span class=w>                </span><span class=se>\</span>
</span><span id=__span-19-35><a id=__codelineno-19-35 name=__codelineno-19-35 href=#__codelineno-19-35></a><span class=w>    </span>--internal-port<span class=w> </span><span class=m>127</span>.0.0.1:8080
</span><span id=__span-19-36><a id=__codelineno-19-36 name=__codelineno-19-36 href=#__codelineno-19-36></a>
</span><span id=__span-19-37><a id=__codelineno-19-37 name=__codelineno-19-37 href=#__codelineno-19-37></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-19-38><a id=__codelineno-19-38 name=__codelineno-19-38 href=#__codelineno-19-38></a>sudo<span class=w> </span>-iu<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>ID_USER</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>start<span class=w> </span>keycloak-http-activator.socket
</span></code></pre></div><h3 id=33-verify-container-to-container-communication>3.3 Verify Container-to-Container Communication<a class=headerlink href=#33-verify-container-to-container-communication title="Permanent link">&para;</a></h3><p>PID=$(podman inspect -f '{{.State.Pid}}' keycloak) podman unshare nsenter --target $PID --uts --ipc --net --pid hostname -f podman unshare nsenter --target $PID --uts --ipc --net --pid /usr/bin/ping -c1 192.168.200.1</p></article></div><script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script><script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script></div><button type=button class="md-top md-icon" data-md-component=top hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button></main><footer class=md-footer><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "content.code.copy", "content.code.select", "content.tabs.link", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script><script src=../../assets/javascripts/bundle.e71a0d61.min.js></script></body></html>