<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../0.%20setup/ rel=prev><link href=../2.%20quadlet/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.23"><title>Lab 1: User Lingering - Brothaman</title><link rel=stylesheet href=../../assets/stylesheets/main.84d31ad4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head><body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue><input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off><input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off><label class=md-overlay for=__drawer></label><div data-md-component=skip><a href=#lingering class=md-skip> Skip to content </a></div><div data-md-component=announce></div><header class="md-header md-header--shadow md-header--lifted" data-md-component=header><nav class="md-header__inner md-grid" aria-label=Header><a href=../.. title=Brothaman class="md-header__button md-logo" aria-label=Brothaman data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg></a><label class="md-header__button md-icon" for=__drawer><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> Brothaman </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> Lab 1: User Lingering </span></div></div></div><form class=md-header__option data-md-component=palette><input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0><label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label><input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1><label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label></form><script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script><label class="md-header__button md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required><label class="md-search__icon md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg></label><nav class=md-search__options aria-label=Search><button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav></form><div class=md-search__output><div class=md-search__scrollwrap tabindex=0 data-md-scrollfix><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta> Initializing search </div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div></nav><nav class=md-tabs aria-label=Tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a href=../.. class=md-tabs__link> Home </a></li><li class=md-tabs__item><a href=../../architecture/ class=md-tabs__link> Architecture </a></li><li class=md-tabs__item><a href=../../components/ class=md-tabs__link> Components </a></li><li class=md-tabs__item><a href=../../compose-conversion/ class=md-tabs__link> Tools & Utilities </a></li><li class="md-tabs__item md-tabs__item--active"><a href=../ class=md-tabs__link> Labs & Tutorials </a></li><li class=md-tabs__item><a href=../../specifications/bro-user/ class=md-tabs__link> Reference </a></li></ul></div></nav></header><div class=md-container data-md-component=container><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0><label class=md-nav__title for=__drawer><a href=../.. title=Brothaman class="md-nav__button md-logo" aria-label=Brothaman data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg></a> Brothaman </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1><label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0><span class=md-ellipsis> Home </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false><label class=md-nav__title for=__nav_1><span class="md-nav__icon md-icon"></span> Home </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../.. class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../directions/ class=md-nav__link><span class=md-ellipsis> Getting Started </span></a></li><li class=md-nav__item><a href=../../development/ class=md-nav__link><span class=md-ellipsis> Development </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2><label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0><span class=md-ellipsis> Architecture </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false><label class=md-nav__title for=__nav_2><span class="md-nav__icon md-icon"></span> Architecture </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../architecture/ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../architecture/ class=md-nav__link><span class=md-ellipsis> System Design </span></a></li><li class=md-nav__item><a href=../../socket-activation/ class=md-nav__link><span class=md-ellipsis> Socket Activation </span></a></li><li class=md-nav__item><a href=../../quadlet-patterns/ class=md-nav__link><span class=md-ellipsis> Quadlet Patterns </span></a></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_5><label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0><span class=md-ellipsis> Diagrams </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false><label class=md-nav__title for=__nav_2_5><span class="md-nav__icon md-icon"></span> Diagrams </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../diagrams/architecture/ class=md-nav__link><span class=md-ellipsis> System Architecture </span></a></li><li class=md-nav__item><a href=../../diagrams/per-service-pattern/ class=md-nav__link><span class=md-ellipsis> Service Pattern </span></a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3><label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0><span class=md-ellipsis> Components </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false><label class=md-nav__title for=__nav_3><span class="md-nav__icon md-icon"></span> Components </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../components/ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class=md-nav__item><a href=../../bro-helper/ class=md-nav__link><span class=md-ellipsis> Network Helper </span></a></li><li class=md-nav__item><a href=../../user-scope/ class=md-nav__link><span class=md-ellipsis> User Management </span></a></li><li class=md-nav__item><a href=../../unprivileged-podman/ class=md-nav__link><span class=md-ellipsis> Container Runtime </span></a></li><li class=md-nav__item><a href=../../zfs/ class=md-nav__link><span class=md-ellipsis> Storage Backend </span></a></li><li class=md-nav__item><a href=../../users-and-lingering/ class=md-nav__link><span class=md-ellipsis> User Sessions </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4><label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0><span class=md-ellipsis> Tools & Utilities </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false><label class=md-nav__title for=__nav_4><span class="md-nav__icon md-icon"></span> Tools & Utilities </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../compose-conversion/ class=md-nav__link><span class=md-ellipsis> Compose Conversion </span></a></li><li class=md-nav__item><a href=../../dictionary/ class=md-nav__link><span class=md-ellipsis> Dictionary </span></a></li><li class=md-nav__item><a href=../../project-plan/ class=md-nav__link><span class=md-ellipsis> Project Plan </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked><label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex><span class=md-ellipsis> Labs & Tutorials </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true><label class=md-nav__title for=__nav_5><span class="md-nav__icon md-icon"></span> Labs & Tutorials </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../ class=md-nav__link><span class=md-ellipsis> Overview </span></a></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2 checked><label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex><span class=md-ellipsis> Foundation </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=true><label class=md-nav__title for=__nav_5_2><span class="md-nav__icon md-icon"></span> Foundation </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../0.%20setup/ class=md-nav__link><span class=md-ellipsis> Lab 0: Environment Setup </span></a></li><li class="md-nav__item md-nav__item--active"><input class="md-nav__toggle md-toggle" type=checkbox id=__toc><label class="md-nav__link md-nav__link--active" for=__toc><span class=md-ellipsis> Lab 1: User Lingering </span><span class="md-nav__icon md-icon"></span></label><a href=./ class="md-nav__link md-nav__link--active"><span class=md-ellipsis> Lab 1: User Lingering </span></a><nav class="md-nav md-nav--secondary" aria-label="Page Contents"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> Page Contents </label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a href=#0-snapshot class=md-nav__link><span class=md-ellipsis> 0. Snapshot </span></a></li><li class=md-nav__item><a href=#1-create-an-unprivileged-lingering-user-and-enable-systemd-commands class=md-nav__link><span class=md-ellipsis> 1. Create an unprivileged lingering user and enable systemd commands </span></a><nav class=md-nav aria-label="1. Create an unprivileged lingering user and enable systemd commands"><ul class=md-nav__list><li class=md-nav__item><a href=#whats-going-on-here class=md-nav__link><span class=md-ellipsis> What's going on here? </span></a></li><li class=md-nav__item><a href=#user-manager class=md-nav__link><span class=md-ellipsis> User Manager </span></a><nav class=md-nav aria-label="User Manager"><ul class=md-nav__list><li class=md-nav__item><a href=#two-ways-the-user-manager-starts class=md-nav__link><span class=md-ellipsis> Two ways the user manager starts </span></a></li><li class=md-nav__item><a href=#relationship-to-runuserbus class=md-nav__link><span class=md-ellipsis> Relationship to /run/user/\/bus </span></a></li></ul></nav></li></ul></nav></li><li class=md-nav__item><a href=#2-create-install-and-start-test-systemd-user-service class=md-nav__link><span class=md-ellipsis> 2. Create, install, and start test systemd user service </span></a></li><li class=md-nav__item><a href=#3-reboot-with-lingering class=md-nav__link><span class=md-ellipsis> 3. Reboot with lingering </span></a></li><li class=md-nav__item><a href=#4-check-if-the-test-service-runs-after-reboot class=md-nav__link><span class=md-ellipsis> 4. Check if the test service runs after reboot </span></a></li><li class=md-nav__item><a href=#5-disable-lingering-and-reboot class=md-nav__link><span class=md-ellipsis> 5. Disable lingering and reboot </span></a></li><li class=md-nav__item><a href=#6-check-if-the-test-service-runs-after-reboot-should-not-be-running class=md-nav__link><span class=md-ellipsis> 6. Check if the test service runs after reboot (should NOT be running) </span></a></li><li class=md-nav__item><a href=#7-re-enable-lingering-and-see-what-happens class=md-nav__link><span class=md-ellipsis> 7. Re-enable lingering and see what happens </span></a></li><li class=md-nav__item><a href=#8-use-bro-user-instead class=md-nav__link><span class=md-ellipsis> 8. Use bro-user instead </span></a></li><li class=md-nav__item><a href=#9-lessons-learned class=md-nav__link><span class=md-ellipsis> 9. Lessons learned </span></a><nav class=md-nav aria-label="9. Lessons learned"><ul class=md-nav__list><li class=md-nav__item><a href=#key-takeaways class=md-nav__link><span class=md-ellipsis> Key takeaways </span></a></li><li class=md-nav__item><a href=#practical-implications class=md-nav__link><span class=md-ellipsis> Practical implications </span></a></li><li class=md-nav__item><a href=#final-observation class=md-nav__link><span class=md-ellipsis> Final observation </span></a></li></ul></nav></li><li class=md-nav__item><a href=#9-rollback class=md-nav__link><span class=md-ellipsis> 9. Rollback </span></a></li></ul></nav></li><li class=md-nav__item><a href=../2.%20quadlet/ class=md-nav__link><span class=md-ellipsis> Lab 2: Quadlet Basics </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_3><label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex><span class=md-ellipsis> Storage & Persistence </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false><label class=md-nav__title for=__nav_5_3><span class="md-nav__icon md-icon"></span> Storage & Persistence </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../3.%20volumes/ class=md-nav__link><span class=md-ellipsis> Lab 3: Volumes & ZFS </span></a></li><li class=md-nav__item><a href=../5.%20debugging/ class=md-nav__link><span class=md-ellipsis> Lab 5: Debugging </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_4><label class=md-nav__link for=__nav_5_4 id=__nav_5_4_label tabindex><span class=md-ellipsis> Networking & Services </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_4_label aria-expanded=false><label class=md-nav__title for=__nav_5_4><span class="md-nav__icon md-icon"></span> Networking & Services </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../4.%20networking/ class=md-nav__link><span class=md-ellipsis> Lab 4: Network Config </span></a></li><li class=md-nav__item><a href=../6.%20pgadmin/ class=md-nav__link><span class=md-ellipsis> Lab 6: Database Admin </span></a></li><li class=md-nav__item><a href=../7.%20pod/ class=md-nav__link><span class=md-ellipsis> Lab 7: Pod Management </span></a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6><label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0><span class=md-ellipsis> Reference </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false><label class=md-nav__title for=__nav_6><span class="md-nav__icon md-icon"></span> Reference </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_1><label class=md-nav__link for=__nav_6_1 id=__nav_6_1_label tabindex=0><span class=md-ellipsis> API Specifications </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_1_label aria-expanded=false><label class=md-nav__title for=__nav_6_1><span class="md-nav__icon md-icon"></span> API Specifications </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../../specifications/bro-user/ class=md-nav__link><span class=md-ellipsis> bro-user </span></a></li><li class=md-nav__item><a href=../../specifications/bro-volume/ class=md-nav__link><span class=md-ellipsis> bro-volume </span></a></li><li class=md-nav__item><a href=../../specifications/bro-activator/ class=md-nav__link><span class=md-ellipsis> bro-activator </span></a></li></ul></nav></li></ul></nav></li></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><h1 id=lingering>Lingering<a class=headerlink href=#lingering title="Permanent link">&para;</a></h1><p>In this lab we will prove that <strong>systemd lingering</strong> works when enabled for an unprivileged user and demonstrate its impact on <strong>user-scoped services</strong> that persist across reboots. You will:</p><ol><li>Create an unprivileged lingering user and enable systemd commands</li><li>Create, install, and start test systemd user-scoped service</li><li>Reboot with lingering</li><li>Check if the test service runs after reboot (should be running)</li><li>Disable lingering and reboot</li><li>Check if the test service runs after reboot (should NOT be running)</li><li>Re-enable lingering again and see what happens</li><li>Lessons learned</li></ol><h2 id=0-snapshot>0. Snapshot<a class=headerlink href=#0-snapshot title="Permanent link">&para;</a></h2><p>Since this test runs inside a Vagrant VM, capture a baseline snapshot before making any changes. From your host machine (in the same directory as your Vagrantfile):</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>if</span><span class=w> </span>!<span class=w> </span>vagrant<span class=w> </span>snapshot<span class=w> </span>list<span class=w> </span><span class=m>2</span>&gt;<span class=p>&amp;</span><span class=m>1</span><span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>before-starting<span class=w> </span>&gt;/dev/null<span class=p>;</span><span class=w> </span><span class=k>then</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>    </span>vagrant<span class=w> </span>snapshot<span class=w> </span>save<span class=w> </span>before-starting<span class=p>;</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=k>else</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>    </span><span class=nb>echo</span><span class=w> </span>before-starting<span class=w> </span>snapshot<span class=w> </span>already<span class=w> </span>exists<span class=p>;</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=k>fi</span>
</span></code></pre></div><p>This allows you to roll the VM back to its exact pre-test state later.</p><h2 id=1-create-an-unprivileged-lingering-user-and-enable-systemd-commands>1. Create an unprivileged lingering user and enable systemd commands<a class=headerlink href=#1-create-an-unprivileged-lingering-user-and-enable-systemd-commands title="Permanent link">&para;</a></h2><blockquote><p><strong>ATTENTION</strong>: Make sure to SSH into the vagrant vm with <code>vagrant ssh</code></p></blockquote><p>Create a dedicated unprivileged test user:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1># create and check user</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>sudo<span class=w> </span>useradd<span class=w> </span>-m<span class=w> </span>-s<span class=w> </span>/bin/bash<span class=w> </span>lingeruser
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>id<span class=w> </span>lingeruser
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>getent<span class=w> </span>passwd<span class=w> </span>lingeruser
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>sudo<span class=w> </span>-iu<span class=w> </span>lingeruser<span class=w> </span>ls<span class=w> </span>-ld<span class=w> </span>.
</span></code></pre></div><p>This ensures the user got created with home directory (<code>/home/lingeruser</code>) and we can execute commands as the user. Now let's make the user linger but notice the checks before and after for an instance of systemd running as the lingeruser:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;checking if new user&#39;s systemd instance is running&quot;</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>sudo<span class=w> </span>ps<span class=w> </span>-ux<span class=w> </span>-U<span class=w> </span>lingeruser<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;systemd --user&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-v<span class=w> </span>grep
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=nb>echo</span><span class=w> </span>no<span class=w> </span>systemd<span class=w> </span>from<span class=w> </span>the<span class=w> </span>ps<span class=w> </span><span class=nb>command</span><span class=w> </span>☝️
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=nb>echo</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=c1># make the user linger</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>sudo<span class=w> </span>loginctl<span class=w> </span>enable-linger<span class=w> </span>lingeruser
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;checking if new user&#39;s systemd instance is running&quot;</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>sleep<span class=w> </span><span class=m>3</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>sudo<span class=w> </span>ps<span class=w> </span>-ux<span class=w> </span>-U<span class=w> </span>lingeruser<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;systemd --user&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-v<span class=w> </span>grep
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=nb>echo</span><span class=w> </span>see<span class=w> </span>systemd<span class=w> </span>now<span class=w> </span>from<span class=w> </span>the<span class=w> </span>ps<span class=w> </span><span class=nb>command</span><span class=w> </span>☝️
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=nb>echo</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=c1># check if we can use systemctl</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>sudo<span class=w> </span>-iu<span class=w> </span>lingeruser<span class=w> </span>systemctl<span class=w> </span>--user<span class=w> </span>list-units<span class=w> </span>--no-pager
</span></code></pre></div><h3 id=whats-going-on-here>What's going on here?<a class=headerlink href=#whats-going-on-here title="Permanent link">&para;</a></h3><p>Systemd runs in system mode as root. When "<strong>enabled to</strong>", systemd can also run in user mode with the <code>--user</code> switch. The systemd process actually runs as a specific user. Here in this lab it runs as the lingeruser.</p><p>If you noticed the lingeruser's systemd process was not present before the <code>loginctl enable-linger lingeruser</code> command was run. Running the command fired up the systemd infrastructure for the lingeruser and the ps command after it showed the user's systemd instance now running. Furthermore, the enable-linger command makes sure, the user's systemd instance is always running, even when the user is not logged in.</p><p>Other things are also started. Namely a dbus broker for the user's system components bus. System components, including systemd, talk to one another using this messaging system. In fact, systemctl sends commands to the systemd user instance using this bus. However, to attach to the broker and send commands to the systemd user instance it needs to connect to the bus. These environment variables tell it where to find the bus (take a look):</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=nb>echo</span><span class=w> </span><span class=nv>XDG_RUNTIME_DIR</span><span class=o>=</span><span class=si>${</span><span class=nv>XDG_RUNTIME_DIR</span><span class=si>}</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=nb>echo</span><span class=w> </span><span class=nv>DBUS_SESSION_BUS_ADDRESS</span><span class=o>=</span><span class=si>${</span><span class=nv>DBUS_SESSION_BUS_ADDRESS</span><span class=si>}</span>
</span></code></pre></div><p>The brothaman package being installed automatically sets these environment variables for all unprivileged users by placing a script in <code>/etc/profile.d/xdg_runtime.sh</code>. This script runs at login and sets the variables correctly so that commands like <code>systemctl --user</code> work as expected.</p><h3 id=user-manager>User Manager<a class=headerlink href=#user-manager title="Permanent link">&para;</a></h3><p>The user manager is the per-user systemd instance that manages all user-scope units. On a system with systemd, there are two main layers of system management:</p><table><thead><tr><th>Layer</th><th>Runs as</th><th>Controls</th></tr></thead><tbody><tr><td><strong>System manager</strong></td><td><code>PID 1</code> (<code>/lib/systemd/systemd</code>)</td><td>system-wide units (<code>/etc/systemd/system/*.service</code>)</td></tr><tr><td><strong>User manager</strong></td><td><code>/lib/systemd/systemd --user</code> (one per logged-in or lingering user)</td><td>per-user units (<code>~/.config/systemd/user/*.service</code>)</td></tr></tbody></table><p>So each logged-in user (or each “lingering” user) gets their own lightweight systemd instance that controls user-scoped services, sockets, timers, and targets. You can see it with <code>ps -u lingeruser | grep systemd</code>.</p><h4 id=two-ways-the-user-manager-starts>Two ways the user manager starts<a class=headerlink href=#two-ways-the-user-manager-starts title="Permanent link">&para;</a></h4><ol><li><p><strong>Interactive login (default behavior)</strong><br> When a user logs in (via <code>ssh</code>, TTY, desktop, etc.), PAM runs <code>systemd --user</code>, creating <code>/run/user/&lt;uid&gt;/</code> and starting user services like <code>dbus.socket</code>, <code>xdg-desktop-portal.service</code>, etc.</p></li><li><p><strong>Lingering (non-interactive)</strong><br> When you enable lingering via <code>loginctl enable-linger &lt;user&gt;</code>. Systemd ensures that the per-user manager (<code>user@&lt;uid&gt;.service</code>) starts <strong>at boot</strong>, even if the user never logs in. That service runs as root's child process under the system manager and spawns <code>/lib/systemd/systemd --user</code> for that UID.</p></li></ol><h4 id=relationship-to-runuserbus>Relationship to /run/user/\<uid>/bus<a class=headerlink href=#relationship-to-runuserbus title="Permanent link">&para;</a></h4><p>The <strong>D-Bus session bus</strong> socket at <code>/run/user/&lt;uid&gt;/bus</code> is created and managed by the <strong>user manager</strong>.</p><ul><li>The user manager starts <code>dbus.socket</code> and <code>dbus.service</code> (or <code>dbus-broker.service</code>). </li><li><code>dbus.socket</code> creates the <code>bus</code> socket.</li><li>Any client that connects to <code>/run/user/&lt;uid&gt;/bus</code> triggers D-Bus activation of the broker/service.</li></ul><p>If the user manager isn't running, there's nothing to start <code>dbus.socket</code>, so <code>/run/user/&lt;uid&gt;/bus</code> doesn't exist — even though <code>/run/user/&lt;uid&gt;/</code> might. See it all running:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>vagrant@debian12:~$<span class=w> </span>sudo<span class=w> </span>loginctl<span class=w> </span>user-status<span class=w> </span>lingeruser<span class=w> </span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>lingeruser<span class=w> </span><span class=o>(</span><span class=m>1001</span><span class=o>)</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>           </span>Since:<span class=w> </span>Fri<span class=w> </span><span class=m>2025</span>-10-17<span class=w> </span><span class=m>19</span>:29:45<span class=w> </span>UTC<span class=p>;</span><span class=w> </span>24min<span class=w> </span>ago
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>           </span>State:<span class=w> </span>lingering
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>          </span>Linger:<span class=w> </span>yes
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>            </span>Unit:<span class=w> </span>user-1001.slice
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>                  </span>└─user@1001.service
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>                    </span>└─init.scope
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>                      </span>├─1801<span class=w> </span>/lib/systemd/systemd<span class=w> </span>--user
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>                      </span>└─1803<span class=w> </span><span class=s2>&quot;(sd-pam)&quot;</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>...
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>Oct<span class=w> </span><span class=m>17</span><span class=w> </span>...<span class=w> </span>systemd<span class=o>[</span><span class=m>1801</span><span class=o>]</span>:<span class=w> </span>Starting<span class=w> </span>dbus.socket<span class=w> </span>-<span class=w> </span>D-Bus<span class=w> </span>User<span class=w> </span>Message<span class=w> </span>Bus<span class=w> </span>Socket...
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>Oct<span class=w> </span><span class=m>17</span><span class=w> </span>...<span class=w> </span>systemd<span class=o>[</span><span class=m>1801</span><span class=o>]</span>:<span class=w> </span>Listening<span class=w> </span>on<span class=w> </span>dbus.socket<span class=w> </span>-<span class=w> </span>D-Bus<span class=w> </span>User<span class=w> </span>Message<span class=w> </span>Bus<span class=w> </span>Socket.
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a>...
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>Oct<span class=w> </span><span class=m>17</span><span class=w> </span><span class=m>19</span>:29:46<span class=w> </span>debian12<span class=w> </span>systemd<span class=o>[</span><span class=m>1801</span><span class=o>]</span>:<span class=w> </span>Startup<span class=w> </span>finished<span class=w> </span><span class=k>in</span><span class=w> </span>147ms.
</span></code></pre></div><h2 id=2-create-install-and-start-test-systemd-user-service>2. Create, install, and start test systemd user service<a class=headerlink href=#2-create-install-and-start-test-systemd-user-service title="Permanent link">&para;</a></h2><p><strong><em>NOTE: Sudo into the lingeruser with <code>sudo su - lingeruser</code></em></strong></p><p>Let's create the service directory and add lingeruser's new user-scoped systemd service. The service loops forever printing to a log file in /tmp then sleeping for 10 seconds. </p><div class="language-bash highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/systemd/user
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>cat<span class=w> </span>&gt;<span class=w> </span>~/.config/systemd/user/test-linger.service<span class=s>&lt;&lt;&#39;EOF&#39;</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=s>[Unit]</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=s>Description=Lingering Proof Test Service</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=s>[Service]</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=s>ExecStart=/bin/bash -c &#39;while true; do echo &quot;$(date -Is) test-linger running&quot; &gt;&gt; /tmp/test-linger.log; sleep 10; done&#39;</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=s>Restart=always</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=s>RestartSec=5</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=s>[Install]</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=s>WantedBy=default.target</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=s>EOF</span>
</span></code></pre></div><p>Enable and start the service like any other service, but for user scope we use the <code>--user</code> switch. We also confirm the service has started and is logging to the file:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>systemctl<span class=w> </span>--user<span class=w> </span>daemon-reload
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>systemctl<span class=w> </span>--user<span class=w> </span><span class=nb>enable</span><span class=w> </span>--now<span class=w> </span>test-linger.service
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>systemctl<span class=w> </span>--user<span class=w> </span>status<span class=w> </span>test-linger.service
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>systemctl<span class=w> </span>--user<span class=w> </span>list-units<span class=w> </span>--type<span class=o>=</span>service<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s2>&quot;test-linger&quot;</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>tail<span class=w> </span>-f<span class=w> </span>/tmp/test-linger.log
</span></code></pre></div><blockquote><p><strong>NOTE</strong>: you might need to type q to quit the systemd unit listing command</p></blockquote><p>Ctrl-C to exit the tail output.</p><h2 id=3-reboot-with-lingering>3. Reboot with lingering<a class=headerlink href=#3-reboot-with-lingering title="Permanent link">&para;</a></h2><p>Back as vagrant user:</p><p><code>sudo reboot</code></p><h2 id=4-check-if-the-test-service-runs-after-reboot>4. Check if the test service runs after reboot<a class=headerlink href=#4-check-if-the-test-service-runs-after-reboot title="Permanent link">&para;</a></h2><p>SSH back into the vagrant machine and run this as the vagrant user:</p><p><code>tail -f /tmp/test-linger.log</code></p><p>You might press return then wait for another line to be printed in 10s. Press Ctrl-C to exit the tailed output.</p><h2 id=5-disable-lingering-and-reboot>5. Disable lingering and reboot<a class=headerlink href=#5-disable-lingering-and-reboot title="Permanent link">&para;</a></h2><div class="language-bash highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>sudo<span class=w> </span>loginctl<span class=w> </span>disable-linger<span class=w> </span>lingeruser
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>sudo<span class=w> </span>reboot
</span></code></pre></div><h2 id=6-check-if-the-test-service-runs-after-reboot-should-not-be-running>6. Check if the test service runs after reboot (should NOT be running)<a class=headerlink href=#6-check-if-the-test-service-runs-after-reboot-should-not-be-running title="Permanent link">&para;</a></h2><p>SSH back into the vagrant machine and run this as the vagrant user:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>~/Local/brothaman-labs<span class=w> </span>vagrant<span class=w> </span>ssh<span class=w>                                              </span>Last<span class=w> </span>login:<span class=w> </span>Fri<span class=w> </span>Oct<span class=w> </span><span class=m>17</span><span class=w> </span><span class=m>20</span>:11:38<span class=w> </span><span class=m>2025</span><span class=w> </span>from<span class=w> </span><span class=m>192</span>.168.122.1
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>vagrant@debian12:~$<span class=w> </span>tail<span class=w> </span>-f<span class=w> </span>/tmp/test-linger.log
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>tail:<span class=w> </span>cannot<span class=w> </span>open<span class=w> </span><span class=s1>&#39;/tmp/test-linger.log&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span>reading:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>file<span class=w> </span>or<span class=w> </span>directory
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>tail:<span class=w> </span>no<span class=w> </span>files<span class=w> </span>remaining
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>vagrant@debian12:~$<span class=w> </span>sleep<span class=w> </span><span class=m>10</span><span class=p>;</span><span class=w> </span>tail<span class=w> </span>-f<span class=w> </span>/tmp/test-linger.log
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>tail:<span class=w> </span>cannot<span class=w> </span>open<span class=w> </span><span class=s1>&#39;/tmp/test-linger.log&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span>reading:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>file<span class=w> </span>or<span class=w> </span>directory
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>tail:<span class=w> </span>no<span class=w> </span>files<span class=w> </span>remaining
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>vagrant@debian12:~$<span class=w> </span>sudo<span class=w> </span>ps<span class=w> </span>-u<span class=w> </span>lingeruser
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=w>    </span>PID<span class=w> </span>TTY<span class=w>          </span>TIME<span class=w> </span>CMD
</span></code></pre></div><p>It is clear nothing is running any longer.</p><h2 id=7-re-enable-lingering-and-see-what-happens>7. Re-enable lingering and see what happens<a class=headerlink href=#7-re-enable-lingering-and-see-what-happens title="Permanent link">&para;</a></h2><div class="language-bash highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;checking if new user&#39;s systemd instance is running&quot;</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>sudo<span class=w> </span>ps<span class=w> </span>-ux<span class=w> </span>-U<span class=w> </span>lingeruser<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;systemd --user&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-v<span class=w> </span>grep
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=nb>echo</span><span class=w> </span>no<span class=w> </span>systemd<span class=w> </span>from<span class=w> </span>the<span class=w> </span>ps<span class=w> </span><span class=nb>command</span><span class=w> </span>☝️
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=nb>echo</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=c1># make the user linger</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>sudo<span class=w> </span>loginctl<span class=w> </span>enable-linger<span class=w> </span>lingeruser
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;checking if new user&#39;s systemd instance is running&quot;</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>sleep<span class=w> </span><span class=m>3</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>sudo<span class=w> </span>ps<span class=w> </span>-ux<span class=w> </span>-U<span class=w> </span>lingeruser<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;systemd --user&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-v<span class=w> </span>grep
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=nb>echo</span><span class=w> </span>see<span class=w> </span>systemd<span class=w> </span>now<span class=w> </span>from<span class=w> </span>the<span class=w> </span>ps<span class=w> </span><span class=nb>command</span><span class=w> </span>☝️
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>sudo<span class=w> </span>ps<span class=w> </span>-ux<span class=w> </span>-U<span class=w> </span>lingeruser<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;test-linger&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-v<span class=w> </span>grep
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=nb>echo</span><span class=w> </span>see<span class=w> </span>test-linger<span class=w> </span>shell<span class=w> </span>from<span class=w> </span>the<span class=w> </span>ps<span class=w> </span><span class=nb>command</span><span class=w> </span>☝️
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=nb>echo</span>
</span></code></pre></div><p>Reboot and check again, the service should still be up so long as we do not turn off user lingering.</p><h2 id=8-use-bro-user-instead>8. Use bro-user instead<a class=headerlink href=#8-use-bro-user-instead title="Permanent link">&para;</a></h2><p>The <code>bro-user</code> script including in the brothaman-scripts package can help create user-scoped lingering users and it does so using ZFS backing stores. It automatically enables the necessary lingering and runs commands to create the specified user and its datasets. Give it a try:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>sudo<span class=w> </span>bro-user<span class=w> </span>postgres
</span></code></pre></div><p>Note if you do not have the latest podman installed it will install that too. After the command completes, check that the user exists:</p><div class="language-bash highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>id<span class=w> </span>postgres
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>getent<span class=w> </span>passwd<span class=w> </span>postgres
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>ls<span class=w> </span>-ld<span class=w> </span>.
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>zfs<span class=w> </span>list
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>podman<span class=w> </span>image<span class=w> </span>list
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>sudo<span class=w> </span>-iu<span class=w> </span>postgres<span class=w> </span>podman<span class=w> </span>run<span class=w> </span>quay.io/podman/hello:latest
</span></code></pre></div><p>All <code>bro-user</code> created users are lingering by default. And their home directories are under the <code>/var/lib/containers/unprivileged/</code> base path which itself is a ZFS dataset. Life gets easier with <code>bro-user</code>!</p><h2 id=9-lessons-learned>9. Lessons learned<a class=headerlink href=#9-lessons-learned title="Permanent link">&para;</a></h2><p>Through this lab we verified how <strong>systemd's user-scoped manager</strong> behaves under different conditions and why <strong>lingering</strong> is such an important feature for background or headless service users.</p><h3 id=key-takeaways>Key takeaways<a class=headerlink href=#key-takeaways title="Permanent link">&para;</a></h3><ol><li><p><strong>User-mode systemd is separate from system-mode.</strong><br> Every user runs their own <code>systemd --user</code> instance, called the <em>user manager</em>.<br> This instance controls user-scoped units located under <code>~/.config/systemd/user/</code>.</p></li><li><p><strong>Lingering keeps the user manager alive across reboots and logouts.</strong><br> Without lingering, <code>systemd --user</code> only starts when the user logs in through PAM.<br> With lingering enabled (<code>loginctl enable-linger &lt;user&gt;</code>), the user’s <code>user@UID.service</code> starts at boot, even if they never log in.</p></li><li><p><strong>Environment variables are critical.</strong><br><code>XDG_RUNTIME_DIR</code> and <code>DBUS_SESSION_BUS_ADDRESS</code> must point to <code>/run/user/&lt;uid&gt;</code> and its bus socket so that commands like <code>systemctl --user</code> can talk to the user manager.<br> Adding <code>/etc/profile.d/xdg_runtime.sh</code> ensures these variables exist for all unprivileged users.</p></li><li><p><strong>The D-Bus socket (<code>/run/user/&lt;uid&gt;/bus</code>) belongs to the user manager.</strong><br> It only exists while that per-user <code>systemd --user</code> instance is running.<br> When lingering is disabled or the manager stops, the socket disappears and user-scoped commands fail.</p></li><li><p><strong>Services enabled under <code>default.target</code> survive reboots.</strong><br> Our test service <code>test-linger.service</code> continued running after every reboot while lingering was enabled, and stopped existing once lingering was disabled.</p></li><li><p><strong>Lingering makes user accounts behave like lightweight system services.</strong><br> This is ideal for rootless containers, background daemons (e.g., PostgreSQL, Gitea), or personal automation that must persist without an active session.</p></li><li><p><strong>Each lingered user consumes persistent resources.</strong><br> Because their <code>user@UID.service</code> remains active, each lingering user adds a small amount of memory and process overhead—acceptable for a few users, but not something to enable for hundreds indiscriminately.</p></li><li><strong><code>bro-user</code> simplifies lingering user creation.</strong><br> The <code>bro-user</code> script automates creating unprivileged lingering users with ZFS-backed home directories, making it easy to manage unprivileged service accounts.</li></ol><h3 id=practical-implications>Practical implications<a class=headerlink href=#practical-implications title="Permanent link">&para;</a></h3><ul><li>Use lingering for any <strong>headless service accounts</strong> that must auto-start at boot and not depend on an interactive login.</li><li>Always ensure that <strong><code>dbus-user-session</code></strong> or <strong><code>dbus-broker</code></strong> is installed so the per-user D-Bus bus can start.</li><li>Confirm lingering state with <code>loginctl show-user &lt;user&gt; | grep Linger</code></li><li>Verify the user manager is alive with<code>systemctl status user@$(id -u &lt;user&gt;).service</code></li></ul><h3 id=final-observation>Final observation<a class=headerlink href=#final-observation title="Permanent link">&para;</a></h3><p>Once lingering is enabled, a normal unprivileged account becomes a <strong>first-class citizen in systemd's dependency graph</strong> — its services are started, stopped, and monitored just like system-level units.</p><p>Disabling lingering cleanly removes that persistence, returning the user to an ephemeral, login-only environment.</p><h2 id=9-rollback>9. Rollback<a class=headerlink href=#9-rollback title="Permanent link">&para;</a></h2><p>When finished, restore the VM to the baseline snapshot:</p><div class="language-shell highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>vagrant<span class=w> </span>snapshot<span class=w> </span>restore<span class=w> </span>before-starting<span class=w> </span>--no-provision
</span></code></pre></div></article></div><script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script><script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script></div><button type=button class="md-top md-icon" data-md-component=top hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button></main><footer class=md-footer><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><script id=__config type=application/json>{"base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "content.code.copy", "content.code.select", "content.tabs.link", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script><script src=../../assets/javascripts/bundle.f55a23d4.min.js></script></body></html>