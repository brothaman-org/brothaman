# Lingering

In this lab we will prove that **systemd lingering** works when enabled for an unprivileged user and demonstrate its impact on **user-scoped services** that persist across reboots.

1. Create an unprivileged lingering user and enable systemd commands
2. Create, install, and start test systemd user-scoped service
3. Reboot with lingering
4. Check if the test service runs after reboot (should be running)
5. Disable lingering and reboot
6. Check if the test service runs after reboot (should NOT be running)
7. Re-enable lingering again and see what happens
8. Lessons learned

## 0. Snapshot

Since this test runs inside a Vagrant VM, capture a baseline snapshot before making any changes. From your host machine (in the same directory as your Vagrantfile):

```shell
if ! vagrant snapshot list 2>&1 | grep before-starting >/dev/null; then
  vagrant snapshot save before-starting;
else
  echo before-starting snapshot already exists;
fi
```

This allows you to roll the VM back to its exact pre-test state later.

## 1. Create an unprivileged lingering user and enable systemd commands

>**ATTENTION**: Make sure to SSH into the vagrant vm with `vagrant ssh`

Create a dedicated unprivileged test user:

```bash
# create and check user
sudo useradd -m -s /bin/bash lingeruser
id lingeruser
getent passwd lingeruser
sudo -iu lingeruser ls -ld .
```

This ensures the user got created with home directory (`/home/lingeruser`) and we can execute commands as the user. Now let's make the user linger but notice the checks before and after for an instance of systemd running as the lingeruser:

```bash
echo "checking if new user's systemd instance is running"
sudo ps -ux -U lingeruser | grep 'systemd --user' | grep -v grep
echo no systemd from the ps command ‚òùÔ∏è
echo

# make the user linger
sudo loginctl enable-linger lingeruser
echo "checking if new user's systemd instance is running"
sleep 3
sudo ps -ux -U lingeruser | grep 'systemd --user' | grep -v grep
echo see systemd now from the ps command ‚òùÔ∏è
echo

# check if we can use systemctl
sudo -iu lingeruser systemctl --user list-units
echo "NOTICE: using systemctl ‚òùÔ∏è fails üòû"

```

Lingering is enabled using the loginctl command. Unfortunately, this user cannot use systemd commands until some basic settings are set.

For user-mode systemd commands to work, the `XDG_RUNTIME_DIR` and `DBUS_SESSION_BUS_ADDRESS` shell variables **MUST BE** correctly set. We can do that system wide for all unprivileged users by adding the following script in `/etc/profile.d/xdg_runtime.sh`:

```bash
cat | sudo tee /etc/profile.d/xdg_runtime.sh <<'EOF'
export XDG_RUNTIME_DIR=/run/user/$(id -u)
export DBUS_SESSION_BUS_ADDRESS=unix:path=${XDG_RUNTIME_DIR}/bus
EOF

sudo chmod +x /etc/profile.d/xdg_runtime.sh

sudo -iu lingeruser systemctl --user list-units | tee /dev/null
echo systemctl ‚òùÔ∏è now succeeds üëè

```

### What's going on here?

Systemd runs in system mode as root. When "**enabled to**", systemd can also run in user mode with the `--user` switch. The systemd process actually runs as a specific user. Here in this lab it runs as the lingeruser.

If you noticed the lingeruser's systemd process was not present before the `loginctl enable-linger lingeruser` command was run. Running the command fired up the systemd infrastructure for the lingeruser and the ps command after it showed the user's systemd instance now running. Furthermore, the enable-linger command makes sure, the user's systemd instance is always running, even when the user is not logged in.

Other things are also started. Namely a dbus broker for the user's system components bus. System components, including systemd, talk to one another using this messaging system. In fact, systemctl sends commands to the systemd user instance using this bus. However, to attach to the broker and send commands to the systemd user instance it needs to connect to the bus. These environment variables tell it where to find the bus.

### User Manager

The user manager is the per-user systemd instance that manages all user-scope units. On a system with systemd, there are two main layers of system management:

| Layer | Runs as | Controls |
| --- | --- | --- |
| **System manager** | `PID 1` (`/lib/systemd/systemd`) | system-wide units (`/etc/systemd/system/*.service`) |
| **User manager** | `/lib/systemd/systemd --user` (one per logged-in or lingering user) | per-user units (`~/.config/systemd/user/*.service`) |

So each logged-in user (or each ‚Äúlingering‚Äù user) gets their own lightweight systemd instance that controls user-scoped services, sockets, timers, and targets. You can see it with `ps -u lingeruser | grep systemd`.

#### Two ways the user manager starts

1. **Interactive login (default behavior)**  
    When a user logs in (via `ssh`, TTY, desktop, etc.), PAM runs `systemd --user`, creating `/run/user/<uid>/` and starting user services like `dbus.socket`, `xdg-desktop-portal.service`, etc.
    
2. **Lingering (non-interactive)**  
    When you enable lingering via `loginctl enable-linger <user>`. Systemd ensures that the per-user manager (`user@<uid>.service`) starts **at boot**, even if the user never logs in. That service runs as root's child process under the system manager and spawns `/lib/systemd/systemd --user` for that UID.

#### Relationship to /run/user/\<uid>/bus

The **D-Bus session bus** socket at `/run/user/<uid>/bus` is created and managed by the **user manager**.

* The user manager starts `dbus.socket` and `dbus.service` (or `dbus-broker.service`). 
* `dbus.socket` creates the `bus` socket.
* Any client that connects to `/run/user/<uid>/bus` triggers D-Bus activation of the broker/service.

If the user manager isn't running, there's nothing to start `dbus.socket`, so `/run/user/<uid>/bus` doesn't exist ‚Äî even though `/run/user/<uid>/` might. See it all running:

```shell
vagrant@debian12:~$ sudo loginctl user-status lingeruser 
lingeruser (1001)
           Since: Fri 2025-10-17 19:29:45 UTC; 24min ago
           State: lingering
          Linger: yes
            Unit: user-1001.slice
                  ‚îî‚îÄuser@1001.service
                    ‚îî‚îÄinit.scope
                      ‚îú‚îÄ1801 /lib/systemd/systemd --user
                      ‚îî‚îÄ1803 "(sd-pam)"

...
Oct 17 ... systemd[1801]: Starting dbus.socket - D-Bus User Message Bus Socket...
Oct 17 ... systemd[1801]: Listening on dbus.socket - D-Bus User Message Bus Socket.
...
Oct 17 19:29:46 debian12 systemd[1801]: Startup finished in 147ms.
```

## 2. Create, install, and start test systemd user service

***NOTE: Sudo into the lingeruser with `sudo su - lingeruser`***

Let's create the service directory and add lingeruser's new user-scoped systemd service. The service loops forever printing to a log file in /tmp then sleeping for 10 seconds. 

```bash
mkdir -p ~/.config/systemd/user

cat > ~/.config/systemd/user/test-linger.service<<'EOF'
[Unit]
Description=Lingering Proof Test Service

[Service]
ExecStart=/bin/bash -c 'while true; do echo "$(date -Is) test-linger running" >> /tmp/test-linger.log; sleep 10; done'
Restart=always
RestartSec=5

[Install]
WantedBy=default.target

EOF

```

Enable and start the service like any other service, but for user scope we use the `--user` switch. We also confirm the service has started and is logging to the file:

```bash
systemctl --user daemon-reload
systemctl --user enable --now test-linger.service
systemctl --user status test-linger.service
systemctl --user list-units --type=service | grep "test-linger"
tail -f /tmp/test-linger.log

```

>**NOTE**: you might need to type q to quit the systemd unit listing command

Ctrl-C to exit the tail output.

## 3. Reboot with lingering

Back as vagrant user:

`sudo reboot`

## 4. Check if the test service runs after reboot

SSH back into the vagrant machine and run this as the vagrant user:

`tail -f /tmp/test-linger.log`

You might press return then wait for another line to be printed in 10s. Press Ctrl-C to exit the tailed output.

## 5. Disable lingering and reboot

```bash
sudo loginctl disable-linger lingeruser
sudo reboot
```

## 6. Check if the test service runs after reboot (should NOT be running)

SSH back into the vagrant machine and run this as the vagrant user:

```bash
~/Local/brothaman-labs vagrant ssh                                              Last login: Fri Oct 17 20:11:38 2025 from 192.168.122.1
vagrant@debian12:~$ tail -f /tmp/test-linger.log
tail: cannot open '/tmp/test-linger.log' for reading: No such file or directory
tail: no files remaining
vagrant@debian12:~$ sleep 10; tail -f /tmp/test-linger.log
tail: cannot open '/tmp/test-linger.log' for reading: No such file or directory
tail: no files remaining
vagrant@debian12:~$ sudo ps -u lingeruser
    PID TTY          TIME CMD
```

It is clear nothing is running any longer.

## 7. Re-enable lingering and see what happens

```bash
echo "checking if new user's systemd instance is running"
sudo ps -ux -U lingeruser | grep 'systemd --user' | grep -v grep
echo no systemd from the ps command ‚òùÔ∏è
echo

# make the user linger
sudo loginctl enable-linger lingeruser
echo "checking if new user's systemd instance is running"
sleep 3
sudo ps -ux -U lingeruser | grep 'systemd --user' | grep -v grep
echo see systemd now from the ps command ‚òùÔ∏è
sudo ps -ux -U lingeruser | grep 'test-linger' | grep -v grep
echo see test-linger shell from the ps command ‚òùÔ∏è
echo

```

Reboot and check again, the service should still be up so long as we do not turn off user lingering.

## 8. Lessons learned

Through this lab we verified how **systemd‚Äôs user-scoped manager** behaves under different conditions and why **lingering** is such an important feature for background or headless service users.

### Key takeaways

1. **User-mode systemd is separate from system-mode.**  
    Every user runs their own `systemd --user` instance, called the _user manager_.  
    This instance controls user-scoped units located under `~/.config/systemd/user/`.
    
2. **Lingering keeps the user manager alive across reboots and logouts.**  
    Without lingering, `systemd --user` only starts when the user logs in through PAM.  
    With lingering enabled (`loginctl enable-linger <user>`), the user‚Äôs `user@UID.service` starts at boot, even if they never log in.
    
3. **Environment variables are critical.**  
    `XDG_RUNTIME_DIR` and `DBUS_SESSION_BUS_ADDRESS` must point to `/run/user/<uid>` and its bus socket so that commands like `systemctl --user` can talk to the user manager.  
    Adding `/etc/profile.d/xdg_runtime.sh` ensures these variables exist for all unprivileged users.
    
4. **The D-Bus socket (`/run/user/<uid>/bus`) belongs to the user manager.**  
    It only exists while that per-user `systemd --user` instance is running.  
    When lingering is disabled or the manager stops, the socket disappears and user-scoped commands fail.
    
5. **Services enabled under `default.target` survive reboots.**  
    Our test service `test-linger.service` continued running after every reboot while lingering was enabled, and stopped existing once lingering was disabled.
    
6. **Lingering makes user accounts behave like lightweight system services.**  
    This is ideal for rootless containers, background daemons (e.g., PostgreSQL, Gitea), or personal automation that must persist without an active session.
    
7. **Each lingered user consumes persistent resources.**  
    Because their `user@UID.service` remains active, each lingering user adds a small amount of memory and process overhead‚Äîacceptable for a few users, but not something to enable for hundreds indiscriminately.
    

### Practical implications

* Use lingering for any **headless service accounts** that must auto-start at boot and not depend on an interactive login.
* Always ensure that **`dbus-user-session`** or **`dbus-broker`** is installed so the per-user D-Bus bus can start.
* Confirm lingering state with `loginctl show-user <user> | grep Linger`
* Verify the user manager is alive with`systemctl status user@$(id -u <user>).service`

### Final observation

Once lingering is enabled, a normal unprivileged account becomes a **first-class citizen in systemd's dependency graph** ‚Äî its services are started, stopped, and monitored just like system-level units.

Disabling lingering cleanly removes that persistence, returning the user to an ephemeral, login-only environment.

## 9. Rollback

When finished, restore the VM to the baseline snapshot:

```shell
vagrant snapshot restore before-starting --no-provision
```
