# Quadlet

In this lab we install the latest Podman with Quadlet support and use it to create, install, and test a simple container service under an **unprivileged lingering user**.

This builds on [1. lingering](1.%20lingering.md) — make sure you have completed that experiment and verified that lingering is enabled for your test user. Here's a quick summary of steps:

1. Uninstall system podman if present
2. Install the latest podman from alvistack
3. Drop in the test-quadlet.container
4. Reboot test making sure it is up after reboot

## 0. Snapshot

Before making changes, capture a baseline snapshot of the VM so we can roll back cleanly if anything goes wrong:

```shell
if ! vagrant snapshot list 2>&1 | grep before-quadlet >/dev/null; then
  vagrant snapshot save before-quadlet;
else
  echo before-quadlet snapshot already exists;
fi
```

This ensures that you can easily revert to a clean pre-Quadlet state.

## 1. Uninstall System Podman (if present)

First, remove any system-level Podman installation that might conflict with the user-space version we'll install next.

```shell
sudo apt remove -y podman podman-rootless podman-plugins containers-common
sudo apt autoremove -y
```

After removal, confirm that no residual binaries or systemd services remain:

```shell
which podman || echo "Podman removed"
sudo systemctl disable --now podman.service podman.socket 2>/dev/null || true
```

You should see “Podman removed” printed and no active Podman system services.

## 2. Install the Latest Podman from Alvistack

>***Back to the vagrant user***

We'll now install the latest version of Podman from the **Alvistack** repository, which typically ships newer Podman releases with full Quadlet support.

### 2.1 Add the Repository

```shell
sudo apt update
sudo apt install -y curl gnupg2
curl -fsSL https://downloadcontent.opensuse.org/repositories/home:/alvistack/Debian_12/Release.key | \
  sudo gpg --dearmor -o /usr/share/keyrings/alvistack.gpg

echo "deb [signed-by=/usr/share/keyrings/alvistack.gpg] http://downloadcontent.opensuse.org/repositories/home:/alvistack/Debian_12 ./" | \
  sudo tee /etc/apt/sources.list.d/alvistack.list
```

### 2.2 Install Podman

```shell
sudo apt update
sudo apt install -y \
  podman conmon crun catatonit \
  netavark aardvark-dns \
  slirp4netns uidmap \
  fuse-overlayfs dbus-user-session \
  iptables nftables \
  passt

```

### 2.3 Verify Quadlet Support

>***Back to the lingeruser***: `sudo su - lingeruser`

```shell
podman quadlet --help
```

You should see subcommands like `install`, `list`, `rm`, and `print`.

Next, check podman info:

```shell
podman system info
```

### 2.4 Kick the Tires

Run a quick smoke test to ensure Podman works for both root and unprivileged users:

```shell
podman run --rm quay.io/podman/hello
```

And print the version for reference:

```shell
podman version
```

Note the **Client**, **Server**, and **Quadlet** versions for your documentation.

## 3. Drop in the Test Quadlet

In this section we'll create a simple Quadlet file for an unprivileged lingering user. This container will simply run a small web server to verify Quadlet automation.

### 3.1 Switch to the User

>***Back to the lingeruser***: `sudo su - lingeruser`

### 3.2 Create the Quadlet File

Create the Quadlet definition in the user's configuration directory:

```shell
mkdir -p ~/.config/containers/systemd/
cat > ~/.config/containers/systemd/test-quadlet.container <<'EOF'
[Unit]
Description=Quadlet Test Container

[Container]
Image=nginx:alpine
Exec=nginx -g 'daemon off;'
ContainerName=test-quadlet
PublishPort=8080:80

[Service]
Restart=always
TimeoutStartSec=300
StartLimitIntervalSec=60s
StartLimitBurst=5
RestartSec=10s

[Install]
WantedBy=default.target
EOF
```

### 3.3 Reload and Inspect Quadlet

Tell systemd to reload the user unit files:

```shell
systemctl --user daemon-reload
```

Now check what Quadlet sees:

```shell
podman quadlet list
```

Start it:

```shell
systemctl --user start test-quadlet.service
```

And confirm that the generated `.service` file exists under:

```shell
cat /run/user/$UID/systemd/generator/test-quadlet.service
```

You should see the generated service file contents. Notice there was no service enable operation right? Then check the status:

```shell
systemctl --user status test-quadlet.service
```

You should see the Nginx container running with `Active: active (running)` status. Verify from Podman’s perspective:

```shell
podman ps
```

Finally, test the container by curling the local port:

```shell
curl http://localhost:8080
```

You should see the Nginx welcome page HTML.

## 4. Reboot and Persistence Test

Reboot the VM to ensure the Quadlet container auto-starts thanks to **lingering**:

```shell
sudo reboot
```

After reboot, log back in as the same unprivileged user and check:

```shell
systemctl --user status test-quadlet.service
```

You should see it running automatically.

Confirm from Podman:

```shell
podman ps
```

And once more verify with:

```shell
curl http://localhost:8080
```

If all looks good, Quadlet persistence is working correctly under the lingering user.

## 5. Rollback (Optional)

If you want to revert to the pre-Quadlet state, roll back using your saved snapshot:

```shell
vagrant snapshot restore before-quadlet
```

## Lessons Learned

1. **Quadlet integrates tightly with systemd**, turning container definitions into first-class services.
2. **Lingering users** are essential for persistent unprivileged containers across reboots.
3. **Alvistack’s Podman builds** offer up-to-date features missing from Debian's stock packages.
4. **Generated `.service` units under `/run/user/<uid>/containers/systemd/`** are ephemeral but reflect the active container states.
5. Quadlet simplifies container lifecycle management — **no manual `podman run` required** once configured.
6. When combined with **lingering**, Quadlet gives you reliable, self-starting, user-scoped container services that survive reboots without root privileges.
